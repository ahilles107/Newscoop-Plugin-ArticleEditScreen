"use strict";angular.module("authoringEnvironmentApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAlohaEditor","mgcrea.ngStrap.button","mgcrea.ngStrap.helpers.dimensions","mgcrea.ngStrap.tooltip","mgcrea.ngStrap.popover","template/modal/backdrop.html","template/modal/window.html","ui.bootstrap.dropdown","ui.bootstrap.modal","ui.select2","gc.toaster","angularFileUpload","ngTagsInput"]).config(["$routeProvider","$httpProvider","$buttonProvider",function(a,b,c){a.when("/:language/:article",{templateUrl:"views/main.html",resolve:{articleInstance:["articleLoader",function(a){return a()}]}}).when("/",{template:"",controller:"RedirectToArticleCtrl"}).when("/:callback*",{templateUrl:"views/oAuthCallback.html",controller:""}).otherwise({redirectTo:"/"}),b.interceptors.push("authInterceptor"),c.defaults.toggleEvent="change"}]).run(["$document",function(a){a.on("dragover drop",function(a){a.preventDefault()})}]);var mutate_event_stack=[{name:"width",handler:function(a){var b={el:a};return $(b.el).data("mutate-width")||$(b.el).data("mutate-width",$(b.el).width()),$(b.el).data("mutate-width")&&$(b.el).width()!==$(b.el).data("mutate-width")?($(b.el).data("mutate-width",$(b.el).width()),!0):!1}},{name:"height",handler:function(a){var b=a;return $(b).data("mutate-height")||$(b).data("mutate-height",$(b).height()),$(b).data("mutate-height")&&$(b).height()!==$(b).data("mutate-height")?($(b).data("mutate-height",$(b).height()),!0):void 0}},{name:"top",handler:function(a){return $(a).data("mutate-top")||$(a).data("mutate-top",$(a).css("top")),$(a).data("mutate-top")&&$(a).css("top")!==$(a).data("mutate-top")?($(a).data("mutate-top",$(a).css("top")),!0):void 0}},{name:"bottom",handler:function(a){return $(a).data("mutate-bottom")||$(a).data("mutate-bottom",$(a).css("bottom")),$(a).data("mutate-bottom")&&$(a).css("bottom")!==$(a).data("mutate-bottom")?($(a).data("mutate-bottom",$(a).css("bottom")),!0):void 0}},{name:"right",handler:function(a){return $(a).data("mutate-right")||$(a).data("mutate-right",$(a).css("right")),$(a).data("mutate-right")&&$(a).css("right")!==$(a).data("mutate-right")?($(a).data("mutate-right",$(a).css("right")),!0):void 0}},{name:"left",handler:function(a){return $(a).data("mutate-left")||$(a).data("mutate-left",$(a).css("left")),$(a).data("mutate-left")&&$(a).css("left")!==$(a).data("mutate-left")?($(a).data("mutate-left",$(a).css("left")),!0):void 0}},{name:"hide",handler:function(a){return $(a).is(":hidden")?!0:void 0}},{name:"show",handler:function(a){return $(a).is(":visible")?!0:void 0}},{name:"scrollHeight",handler:function(a){return $(a).data("prev-scrollHeight")||$(a).data("prev-scrollHeight",$(a)[0].scrollHeight),$(a).data("prev-scrollHeight")&&$(a)[0].scrollHeight!==$(a).data("prev-scrollHeight")?($(a).data("prev-scrollHeight",$(a)[0].scrollHeight),!0):void 0}},{name:"scrollWidth",handler:function(a){return $(a).data("prev-scrollWidth")||$(a).data("prev-scrollWidth",$(a)[0].scrollWidth),$(a).data("prev-scrollWidth")&&$(a)[0].scrollWidth!==$(a).data("prev-scrollWidth")?($(a).data("prev-scrollWidth",$(a)[0].scrollWidth),!0):void 0}},{name:"scrollTop",handler:function(a){return $(a).data("prev-scrollTop")||$(a).data("prev-scrollTop",$(a)[0].scrollTop()),$(a).data("prev-scrollTop")&&$(a)[0].scrollTop()!==$(a).data("prev-scrollTop")?($(a).data("prev-scrollTop",$(a)[0].scrollTop()),!0):void 0}},{name:"scrollLeft",handler:function(a){return $(a).data("prev-scrollLeft")||$(a).data("prev-scrollLeft",$(a)[0].scrollLeft()),$(a).data("prev-scrollLeft")&&$(a)[0].scrollLeft()!==$(a).data("prev-scrollLeft")?($(a).data("prev-scrollLeft",$(a)[0].scrollLeft()),!0):void 0}}];!function(a){function b(){var d=c;"undefined"!==d.event_stack&&d.event_stack.length&&a.each(d.event_stack,function(a,b){c.add_event(b)}),d.event_stack=[],a.each(d.stack,function(b,c){a(c.selector).each(function(a,b){d.events[c.event_name](b)===!0?c.callback&&c.callback(b,c):c.false_callback&&c.false_callback(b,c)})}),setTimeout(b,c.speed)}var c={speed:50,event_stack:mutate_event_stack,stack:[],events:{},add_event:function(a){c.events[a.name]=a.handler},add:function(a,b,d,e){c.stack[c.stack.length]={event_name:a,selector:b,callback:d,false_callback:e}}};b(),a.fn.extend({mutate:function(){var b=!1,d=arguments[1],e=this,f=arguments[2]?arguments[2]:function(){};return"extend"===arguments[0].toLowerCase()?(c.add_event(d),this):(a.each(a.trim(arguments[0]).split(" "),function(a,g){b=g,c.add(b,e,d,f)}),this)}})}(jQuery);var ModalCtrlConstructor=function(a,b,c,d){a.title=c,a.text=d,a.ok=function(){b.close(!0)},a.cancel=function(){b.dismiss(!1)}};ModalCtrlConstructor.$inject=["$scope","$modalInstance","title","text"],angular.module("authoringEnvironmentApp").factory("modalFactory",["$modal",function(a){return{_createConfirmInstance:function(b,c,d){var e=d?"views/modal-confirm-heavy.html":"views/modal-confirm-light.html";return a.open({templateUrl:e,controller:ModalCtrlConstructor,backdrop:"static",keyboard:!1,resolve:{title:function(){return b},text:function(){return c}}})},confirmLight:function(a,b){return this._createConfirmInstance(a,b,!1)},confirmHeavy:function(a,b){return this._createConfirmInstance(a,b,!0)}}}]),function(a){function b(){a.module("authoringEnvironmentApp").config(["$provide",function(a){a.decorator("$httpBackend",angular.mock.e2e.$httpBackendDecorator)}]).run(["$httpBackend",function(a){a.whenGET(/views\/.*/).passThrough();var b={language:"en",fields:{highlight:"0",lede:"<p>BRUSSELS - Italian and Greek candidates nominated for President of the European Council in secret ballot.</p>",body:'<!-- Snippet 12 --><p>It plu plia olda nula, lo ekoo interjekcio aŭ. Iom inkluzive dividostreko sh, subtraho praantaŭhieraŭ bio fo. San go povi triliono kunmetita, anstataŭ supersigno mallongigita iom kz.</p> <!** Image 101 align="left" alt="Daniel Göpfert" sub="Daniel Göpfert" width="90" height="120" > <!-- Snippet 8 align="left" --> <p>Tiel ofon iometo dio at, vir alikvante montrovorto prirespondi re, sis tiam reen frazparto jh. Pov mi pobo infra alternativo, nenio geedzo alimaniere sor um.</p>\r\n<p>Tek in dekoj komplika kernovorto, dekuma disskribado je end. Vendo posttagmezo um esk, ki nedifina personalo, unt. Sen ki tiele aligi resti. Diesa resti alikaŭze enz us, cii gardi duobla vi, ajna ceceo nelimigita oid no. Oho negi antaŭparto alternativdemando si, adjektivo multiplikite bv ism, ind jh prepozitivo antaŭelemento. He ano orda nekutima, mil fi alia patro solstariva.</p>\r\n<p>Tia zepto rolvorteto du. Ar duo frota sepen dikfingro. Des vavo senforte ed. Mano halt\' onklo sur nv, aliu help transigi ian o, amen multe kompreneble ena er. Nul tiuj fora nano jo.</p>\r\n<p>Kuo op negi posta. Kazablanko subpropozicio mal ne. End ad ekoo sori, in sor otek finitivo okulvitroj, egalo latina iom ge. Pra ho filo troa, mf esk apud aliel geedzo, fin duobla fratineto sekstiliono as. Lo devus video kelka mia, sia ed mili fini. Sin nula usono kunmetaĵo ik, cii op tiea post gibi, sob brosi substantiva is.</p>\r\n<p>Jam unun participo sh. Nea mo ioma identiga, mi edzo ekde frikativo dio. Cii milo tohuo iufoje tc, mo tet krom prezoinda tempopunkto, hago dank\' esperantigita ok kie. Iufoje helpverbo ko mis, poa ci dura eĥo komparado. Pli persa deziri ju, falsa ekesti definitive jes aj. Tro iu hodiaŭa infinitivo, e eca malpli kernovorto.</p>\r\n<p>Ke ato armo postpriskribo. Mem al triliono frikativo miriametro, spite vortfarado fo iel. Oj iom ruli okej vatto. Jota tiama tagnokto nu ili. Nei kian spite ki, nenia reciprokeco ajn vo. Hot jena respondeci uj.</p>\r\n<div class="generic-embed"> </div>\r\n<p>Fri go longa senobjekta postmorgaŭ, deci praantaŭhieraŭ ina el, nea ve dato hekto. Ci speco anstataŭi sat, ses mono literaturo ko. Per vi dume falsa fundamenta, amen siatempe kuo id. Pri vi eĥo fontoj frazparto. Kab\'o difina laŭlonge ne aĥ.</p>',printsection:"Sports",printstory:null,iPad_prominent:"0"},authors:[{name:"Test Persona",link:"http://tw-merge.lab.sourcefabric.org/content-api/author/9"},{name:"Frank N. Stein",link:"http://tw-merge.lab.sourcefabric.org/content-api/author/13"}],number:"64",title:"European Council candidates set to be named",updated:"2013-12-17T14:31:14+0000",comments:"http://tw-merge.lab.sourcefabric.org/content-api/articles/64/en/comments",type:"news",published:"2013-11-14T10:49:17+0000",topics:[{id:10,title:"Cruise Night"},{id:10,title:"Crucero nocturno"},{id:11,title:"People In The News"},{id:11,title:"La gente en las noticias"},{id:29,title:"Milan Shows"},{id:29,title:"Muestra Milán"}],slideshow:[{id:5,title:"Berlin Zoo",itemsLink:"http://tw-merge.lab.sourcefabric.org/content-api/slideshows/5"}],renditions:[{caption:"articlebig",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/600x400%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"sectionthumb",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/250x167%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"square",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/150x150%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"thumb",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/150x100%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"topfront",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/500x333%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"artikel",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/555x370%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"artikelnew",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/639x426%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"blogsidebar",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x150%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierbild",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/980x306%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierbildnew",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/990x330%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierteaser",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x131%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"naviteaser",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/120x53%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"rubrikenseite",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x200%2Ffit%2Fimages%257Ccms-image-000000099.jpg"}],webcode:"cup6z",reads:"5"},d={name:"news",fields:[{name:"body",type:"body",fieldWeight:3,isHidden:0,commentsEnabled:0,fieldTypeParam:"editor_size=750",isContentField:1},{name:"highlight",type:"switch",fieldWeight:1,isHidden:0,commentsEnabled:0,isContentField:0},{name:"iPad_prominent",type:"switch",fieldWeight:6,isHidden:0,commentsEnabled:0,isContentField:0},{name:"lede",type:"longtext",fieldWeight:2,isHidden:0,commentsEnabled:0,fieldTypeParam:"editor_size=250",isContentField:0},{name:"printsection",length:0,type:"text",fieldWeight:4,isHidden:0,commentsEnabled:0,isContentField:0},{name:"printstory",length:0,type:"text",fieldWeight:5,isHidden:0,commentsEnabled:0,isContentField:0}]},e=new RegExp(c+"/articles.*");a.whenGET(e).respond(b),a.when("PATCH",e).respond({});var e=new RegExp(c+"/articleTypes.*");a.whenGET(e).respond(d);var f=function(a,b){return{id:a,name:"My "+a+" "+b,template:b,content:{code:'<div class="embed'+a+'">This is so cool, '+b+"</div>"}}},g={1:f(1,"Generic"),2:f(2,"Generic"),3:f(3,"Generic"),4:f(4,"Generic")},h={5:f(5,"Tweet"),6:f(6,"Tweet"),7:f(7,"Tweet"),8:f(8,"Tweet")},i={1:f(1,"Generic"),2:f(2,"Generic"),3:f(3,"Generic"),4:f(4,"Generic"),5:f(5,"Tweet"),6:f(6,"Tweet"),7:f(7,"Tweet"),8:f(8,"Tweet")},e=new RegExp("/content-api/images[?]page=[0-9]+");a.whenGET(e).respond({items:[{id:1,basename:"Carla-bruni-sarkozy.jpg"},{id:2,basename:"French_election__N_2200069b.jpg"},{id:3,basename:"Strong-turnout-for-French-election.jpg"},{id:4,basename:"sarcozy-presidente-de-francia.jpg"},{id:5,basename:"sarkyDM1910_468x505.jpg"},{id:6,basename:"images-cms-image-003318021.jpg"},{id:7,basename:"images-cms-image-003935520.jpg"},{id:8,basename:"images-cms-image-004021392.jpg"},{id:9,basename:"images-cms-image-004059514.jpg"},{id:10,basename:"images-cms-image-004059556.jpg"}],pagination:{itemsPerPage:10,currentPage:1,itemsCount:149735,nextPageLink:"https://tw-merge.lab.sourcefabric.org/content-api/images?page=2&items_per_page=10"}});var e=new RegExp("/content-api/images/[0-9]+");a.whenGET(e).respond({id:1,location:"local",basename:"French_election__N_2200069b.jpg",thumbnailPath:"cms-thumb-000000001.jpg",url:"",description:"image description",width:"150",height:"210",photographer:"",photographerUrl:"",place:""});var e=new RegExp("/content-api/comments/.*");a.whenGET(e).respond({items:[{id:26822,author:"Inihe Ublinschä",subject:"subject",message:"message",thread_level:0,thread_order:1,status:"approved",created:"2013-11-28T18:10:09+0000",updated:"2013-11-28T18:10:09+0000",recommended:0},{id:26828,author:"More Timat",subject:"ungeeignet..",message:"Mir fiel derselbe Satz auf: «Das Anliegen, die Spekulation mit Grundbesitz einzudämmen ... , sei zwar verständlich, doch die Initiative sei dazu ungeeignet» Ja was gibts denn für geeignete Mittel möchte ich gerne wissen. Enteignung? Verstaatlichung des gesamten Bodens und Verpachtung im Baurecht für 99 Jahre? Vorschläge willkommen!",thread_level:0,thread_order:2,status:"approved",created:"2013-11-28T21:30:43+0000",updated:"2013-11-28T21:30:43+0000",recommended:1}]});var j=g,k=(f(1,"Generic"),{id:1,name:"Generic",template:"%code%"});a.whenGET(/\/content-api\/article\/64\/1\/snippets\/[\d]/).respond(function(a,b){return console.log(b.split("/")),[200,f(b.split("/")[4],"generic")]}),a.whenGET(/\/content-api\/article\/64\/1\/snippets/).respond(j),a.whenGET(/\/content-api\/snippets\/generic\/[\d]/).respond(function(a,b){return[200,f(b.split("/")[4],"generic")]}),a.whenGET(/\/content-api\/snippets\/tweet\/[\d]/).respond(function(a,b){return[200,f(b.split("/")[4],"tweet")]}),a.whenGET(/\/content-api\/snippets\/generic/).respond(g),a.whenGET(/\/content-api\/snippets\/tweet/).respond(h),a.whenGET(/\/content-api\/snippets/).respond(i),a.whenGET(/\/content-api\/snippetTemplate\/[\d]/).respond(k)}])}if(document.URL.match(/nobackend$/)){console.log("=== STUBBED BACKEND ===");var c="http://newscoop.aes.sourcefabric.net/content-api";b()}}(angular),angular.module("authoringEnvironmentApp").filter("availableRoles",[function(){return function(a,b,c){var d=[];return b?(a.forEach(function(a){var e=!1;c.forEach(function(c){return c!==b&&c.id===b.id&&c.articleRole.id===a.id?void(e=!0):void 0}),e||d.push(a)}),d):a}}]),angular.module("authoringEnvironmentApp").filter("allowedWfStatuses",["Article",function(a){return function(b,c,d){var e=[];return b.forEach(function(b){var f=!0;b.value===a.wfStatus.PUBLISHED_W_ISS&&(f=c!==a.wfStatus.PUBLISHED&&d!==a.issueWfStatus.PUBLISHED),f&&e.push(b)}),e}}]),angular.module("authoringEnvironmentApp").controller("MainCtrl",["$scope","$window","mode","userAuth",function(a,b,c,d){if(d.isAuthenticated())a.auth=!0;else{a.auth=!1;var e=d.newTokenByLoginModal();e.then(function(){a.auth=!0}).catch(function(){})}a.$on("$viewContentLoaded",function(){jQuery("#cs-specific").prependTo(".main-background-container")}),a.mode=c}]),function(){function a(a){var b=this,c=new RegExp("access_token=(\\w+)");b.iframeLoadedHandler=function(b){var d,e;"string"==typeof b.hash&&(d=c.exec(b.hash),null!==d&&(e=d[1],a.close(e)))}}a.$inject=["$modalInstance"],angular.module("authoringEnvironmentApp").service("userAuth",["$http","$modal","$q","$window","toaster",function(b,c,d,e,f){var g=this;g.token=function(){return e.sessionStorage.getItem("token")},g.isAuthenticated=function(){return!!e.sessionStorage.getItem("token")},g.newTokenByLoginModal=function(){var b,g=d.defer();return b=c.open({templateUrl:"views/modal-login.html",controller:a,controllerAs:"ctrl",windowClass:"modalLogin",backdrop:"static"}),b.result.then(function(a){e.sessionStorage.setItem("token",a),f.add({type:"sf-info",message:"Successfully refreshed authentication token."}),g.resolve(a)}).catch(function(a){f.add({type:"sf-error",message:"Failed to refresh authentication token."}),g.reject(a)}),g.promise}}])}(),angular.module("authoringEnvironmentApp").controller("RedirectToArticleCtrl",["$location",function(a){var b=["/",articleInfo.language,"/",articleInfo.articleNumber].join("");a.path(b)}]),angular.module("authoringEnvironmentApp").factory("articleLoader",["$route","$q","Article","article",function(a,b,c,d){return function(){var e=b.defer(),f=a.current.params;return c.getById(f.article,f.language).then(function(a){d.articleInstance=a,e.resolve(a)}).catch(function(a){e.reject(a)}),e.promise}}]),angular.module("authoringEnvironmentApp").factory("Topic",["$http","$q","$timeout","dateFactory","pageTracker","transform",function(a,b,c,d,e,f){var g=250,h=null,i=0,j=function(){};return j.createFromApiData=function(a){var b=new j;return b.id=parseInt(a.id),b.title=a.title,b.path=a.path,b.parentId=parseInt(a.parent),b.level=parseInt(a.level),b.order=parseInt(a.order),b.text=b.title,b},j.getAll=function(){var c,d=[],e=b.defer();return d.$promise=e.promise,c=Routing.generate("newscoop_gimme_topics_gettopics",{items_per_page:9999},!0),a.get(c).success(function(a){a.items.forEach(function(a){a=j.createFromApiData(a),d.push(a)}),e.resolve()}).error(function(a){e.reject(a)}),d},j.getAllByArticle=function(c,d){var e,f=[],g=b.defer();return f.$promise=g.promise,e=Routing.generate("newscoop_gimme_topics_getarticlestopics",{number:c,language:d},!0),a.get(e).success(function(a){a.items.forEach(function(a){a=j.createFromApiData(a),f.push(a)}),g.resolve()}).error(function(a){g.reject(a)}),f},j.liveSearchQuery=function(b,f){var k,l=b.page>1,m=d.makeInstance();if(!f){if(!l)return i=m,void c(function(){j.liveSearchQuery(b,!0)},g);if(angular.equals(b.context,h))return;h=b.context}!l&&g>m-i||(k=Routing.generate("newscoop_gimme_topics_searchtopics",{items_per_page:10,page:b.page,query:b.term},!0),a.get(k).success(function(a){var c,d=[];a.items.forEach(function(a){c=j.createFromApiData(a),d.push(c)}),b.callback({results:d,more:!e.isLastPage(a.pagination),context:a.pagination})}))},j.create=function(c,d){var e,g=b.defer(),h={topic:{}};return h.topic.title=c,"undefined"!=typeof d&&(h.topic.parent=d),e=Routing.generate("newscoop_gimme_topics_createtopic",{},!0),a.post(e,h,{transformRequest:f.formEncode}).then(function(b){var c=b.headers("x-location");return a.get(c)},b.reject).then(function(a){var b=j.createFromApiData(a.data);g.resolve(b)},function(){g.reject()}),g.promise},j.addToArticle=function(c,d,e){var f=b.defer(),g=[];if(e.length<1)throw new Error("Topics list is empty.");return e.forEach(function(a){g.push("<"+Routing.generate("newscoop_gimme_topics_gettopicbyid",{id:a.id},!1)+'; rel="topic">')}),g=g.join(),a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:c,language:d},!0),method:"LINK",headers:{link:g}}).success(function(){f.resolve(e)}).error(function(a){f.reject(a)}),f.promise},j.prototype.removeFromArticle=function(c,d){var e,f=this,g=b.defer();return e=["<",Routing.generate("newscoop_gimme_topics_gettopicbyid",{id:f.id},!1),'; rel="topic">'].join(""),a({url:Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:c,language:d},!0),method:"UNLINK",headers:{link:e}}).success(function(){g.resolve()}).error(function(a){g.reject(a)}),g.promise},j}]),angular.module("authoringEnvironmentApp").controller("SfPanesCtrl",["$scope","$filter","panes",function(a,b,c){a.panes=c.query(),a.tabpaneIsOpen=function(c){return b("filter")(a.panes,{position:c,selected:!0,visible:!0}).length>0},a.flipVisible=function(a){c.visible(a),a.active=!0}}]),angular.module("authoringEnvironmentApp").controller("PaneAuthorsCtrl",["$scope","$q","article","Author","modalFactory","toaster",function(a,b,c,d,e){var f=c.articleInstance,g=this;g.setRoleChangeWatch=function(b){var c=a.$watch(function(){return b.articleRole},function(a,c){a!==c&&g.authorRoleChanged(a,c,b)},!0);b.stopRoleChangeWatch=c},g.authorRoleChanged=function(a,b,c){c.updatingRole=!0,c.updateRole({number:f.articleId,language:f.language,oldRoleId:b.id,newRoleId:c.articleRole.id}).then(null,function(){c.stopRoleChangeWatch(),c.articleRole=b,g.setRoleChangeWatch(c)}).finally(function(){c.updatingRole=!1})},a.authorRoles=d.getRoleList(),a.authors=[],a.newAuthor=null,a.newAuthorRoleId=null,a.addingNewAuthor=!1,a.showAddAuthor=!0,a.select2Options={minimumInputLength:3,query:d.liveSearchQuery},a.clearNewAuthorForm=function(){a.newAuthor=null,a.newAuthorRoleId=null},a.addAuthorToArticle=function(){var b=angular.copy(a.newAuthor),c=a.newAuthorRoleId;a.addingNewAuthor=!0,b.addToArticle(f.articleId,f.language,c).then(function(){a.authors.push(b),g.setRoleChangeWatch(b)}).finally(function(){a.addingNewAuthor=!1})},a.confirmRemoveAuthor=function(c){var d,g,h;g="Do you really want to remove this author?",h="Should you change your mind, the same author can always be added again.",d=e.confirmLight(g,h),d.result.then(function(){return c.removeFromArticle(f.articleId,f.language,c.articleRole.id)},b.reject).then(function(){_.remove(a.authors,function(a){return a===c})})},a.orderChanged=function(){d.setOrderOnArticle(f.articleId,f.language,a.authors)},a.authors=d.getAllByArticle(f.articleId,f.language),a.authors.$promise.then(function(){a.authors.forEach(function(a){g.setRoleChangeWatch(a)})})}]),angular.module("authoringEnvironmentApp").controller("PaneInfoCtrl",["article",function(a){var b=this;b.article=a.articleInstance}]),angular.module("authoringEnvironmentApp").controller("PaneTopicsCtrl",["$q","$scope","article","modalFactory","Topic",function(a,b,c,d,e){var f=c.articleInstance,g=[],h=!1;b.selectedTopics=[],b.assigningTopics=!1,b.select2Options={minimumInputLength:3,query:e.liveSearchQuery},b.addingNewTopic=!1,b.newTopic={title:"",parentTopic:null},b.assignedTopics=e.getAllByArticle(f.articleId,f.language),b.addNewTopicToArticle=function(c){var d;b.addingNewTopic=!0,e.create(c.title,c.parentTopic?c.parentTopic.id:void 0).then(function(a){return d=a,e.addToArticle(f.articleId,f.language,[d])},function(c){return 409===c.status&&b.addTopic.topicTitle.$setValidity("duplicate",!1),a.reject(c)}).then(function(){var a=_.findIndex(b.assignedTopics,{id:d.parentId});a>-1?b.assignedTopics.splice(a+1,0,d):b.assignedTopics.push(d),b.clearNewTopicForm()},a.reject).finally(function(){b.addingNewTopic=!1})},b.clearNewTopicForm=function(){b.newTopic.title="",b.newTopic.parentTopic=null,b.addTopic.topicTitle.$setValidity("duplicate",!0)},b.clearSelectedTopics=function(){for(;b.selectedTopics.length>0;)b.selectedTopics.pop()},b.findTopics=function(c){var d,f=a.defer(),i={};return b.selectedTopics.forEach(function(a){i[a.id]=!0}),b.assignedTopics.forEach(function(a){i[a.id]=!0}),h||(g=e.getAll()),g.$promise.then(function(){h=!0,c=c.toLowerCase(),d=_.filter(g,function(a){return!(a.id in i)&&a.title.toLowerCase().indexOf(c)>=0}),f.resolve(d)}),f.promise},b.assignSelectedToArticle=function(){b.assigningTopics=!0,e.addToArticle(f.articleId,f.language,b.selectedTopics).then(function(a){a.forEach(function(a){b.assignedTopics.push(a)}),b.clearSelectedTopics()}).finally(function(){b.assigningTopics=!1})},b.confirmUnassignTopic=function(c){var e,g,h;g="Do you really want to unassign this topic from the article?",h="Should you change your mind, the topic can always be re-assigned again.",e=d.confirmLight(g,h),e.result.then(function(){return c.removeFromArticle(f.articleId,f.language)},a.reject).then(function(){_.remove(b.assignedTopics,{id:c.id})})}}]),angular.module("authoringEnvironmentApp").controller("PaneSwitchesCtrl",["$q","article","ArticleType",function(a,b,c){var d=this;d.article=b.articleInstance,d.modified=!1,d.saveInProgress=!1,d.switches=[{name:"show_on_front_page",text:"Show on Front Page"},{name:"show_on_section_page",text:"Show on Section Page"}],c.getByName(d.article.type).then(function(a){a.fields.forEach(function(a){"switch"===a.type&&(d.switches.push({name:a.name,text:a.phrase||a.name}),d.article.fields[a.name]=!!parseInt(d.article.fields[a.name]))}),["show_on_front_page","show_on_section_page"].forEach(function(a){d.article.fields[a]=!!parseInt(d.article.fields[a])})}),d.valueChanged=function(){d.modified=!0},d.save=function(){var a=_.map(d.switches,"name");d.saveInProgress=!0,d.article.saveSwitches(a).finally(function(){d.modified=!1,d.saveInProgress=!1})}}]),angular.module("authoringEnvironmentApp").factory("panes",["$filter",function(){function a(a){var b="";return angular.forEach(a,function(a,c){switch(a){case"small":b+="shrink-"+c+" ";break;case"big":b+="shrink-"+c+"-more "}}),b}var b=[{name:"Info",id:"info",icon:"info",template:"views/pane-info.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Authors",id:"authors",icon:"authors",template:"views/pane-authors.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Related Articles",id:"related-articles-panel",icon:"relatedarticles",template:"views/pane-related-articles.html",position:"right",size:"small",visible:!0,active:!0,selected:!0},{name:"Switches",id:"switches",icon:"switches",template:"views/pane-switches.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Topics",id:"topics",icon:"topics",template:"views/pane-topics.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Images",id:"images",icon:"media",template:"views/pane-draggable.html",position:"left",size:"small",visible:!1,active:!1,selected:!0},{name:"Snippets",id:"snippets",icon:"embeds",template:"views/pane-embed.html",position:"left",size:"small",visible:!1,active:!1,selected:!0},{name:"Comments",id:"comments",icon:"comments",template:"views/pane-comments.html",position:"left",size:"big",visible:!1,active:!1,selected:!0}];return b.layout={right:null,left:null},b.articleClass="",{query:function(){return b},visible:function(c){b.forEach(function(a){a===c?c.visible=!c.visible:a.visible=!1}),b.layout=this.layout(b),b.articleClass=a(b.layout)},layout:function(a){var b={left:null,right:null};return a.forEach(function(a){a.visible&&(b[a.position]=a.size)}),b}}}]),angular.module("authoringEnvironmentApp").controller("PanesConfigCtrl",["$scope","panes",function(a,b){a.panes=b.query(),a.flipPosition=function(a){a.position="left"===a.position?"right":"left"}}]),angular.module("authoringEnvironmentApp").controller("ArticleCtrl",["$q","$scope","$rootScope","article","Article","ArticleType","panes","configuration","mode","platform",function(a,b,c,d,e,f,g,h,i,j){var k=this;k.fieldStatsText=function(a){var c,d,f;return f="title"===a?b.article.title:b.article.fields[a],d=e.textStats(f),c=[d.chars," Character",1!==d.chars?"s":""," / ",d.words," Word",1!==d.words?"s":""].join("")},b.mode=i,b.articleService=d,b.article=d.articleInstance,b.panes=g.query(),b.platform=j,c.$on("texteditor-content-changed",function(a,c,d){var e,f,g={keypress:!0,paste:!0,idle:!0};d.triggerType in g&&(e=d.editable.originalObj.data("field-name"),f=k.fieldStatsText(e),b.$apply(function(){var a=_(b.editableFields).find({name:e});a.statsText=f}))}),f.getByName(b.article.type).then(function(a){var c=h.articleTypeFields[a.name],d=[];a.fields.forEach(function(a){var d=b.article.fields[a.name];a.name in c&&!d&&(b.article.fields[a.name]=c[a.name].defaultText)}),_(c).forIn(function(a){a.statsText=k.fieldStatsText(a.name),d.push(a)}),b.editableFields=d}),b.save=function(){b.article.save().then(function(){b.articleService.modified=!1})}}]),angular.module("authoringEnvironmentApp").controller("ArticleActionsCtrl",["$rootScope","$scope","$window","article","Article","configuration","mode","toaster",function(a,b,c,d,e,f,g,h){var i;b.mode=g,b.articleService=d,b.article=d.articleInstance,b.Article=e,b.workflowStatuses=[{value:e.wfStatus.NEW,text:"New"},{value:e.wfStatus.SUBMITTED,text:"Submitted"},{value:e.wfStatus.PUBLISHED,text:"Published"},{value:e.wfStatus.PUBLISHED_W_ISS,text:"Published with issue"}],b.changingWfStatus=!1,a.$on("texteditor-content-changed",function(a,c,d){var e,f={keypress:!0,paste:!0,idle:!0};d.triggerType in f&&(e=d.editable.originalObj.data("field-name"),b.setModified(!0))}),i=_.find(b.workflowStatuses,{value:b.article.status}),b.wfStatus=i,b.setWorkflowStatus=function(a){b.changingWfStatus=!0,b.article.setWorkflowStatus(a).then(function(){var c=_.find(b.workflowStatuses,{value:a});b.wfStatus=c}).finally(function(){b.changingWfStatus=!1})},b.close=function(){var a=[f.API.rootURI,"/","admin/articles/index.php?","f_publication_id=",b.article.publication.id,"&f_issue_number=",b.article.issue.number,"&f_language_id=",b.article.languageData.id,"&f_section_number=",b.article.section.number].join("");b.article.releaseLock().then(function(){c.location.href=a}).catch(function(){h.add({type:"sf-error",message:"Unlocking the article failed."})})},b.save=function(){b.article.save().then(function(){b.setModified(!1)})},b.setModified=function(a){b.articleService.modified=a}}]),function(){function a(a,b,c,d){var e,f=this;e=[d.API.rootURI,"/admin/articles/preview.php?","f_publication_id=",c.publicationId,"&f_issue_number=",c.issueId,"&f_section_number=",c.sectionId,"&f_article_number=",c.articleId,"&f_language_id=",c.languageId,"&f_language_selected=",c.languageId].join(""),f.url=b.trustAsResourceUrl(e),f.close=function(){a.close()}}a.$inject=["$modalInstance","$sce","articleInfo","configuration"],angular.module("authoringEnvironmentApp").controller("ArticlePreviewCtrl",["$modal","article",function(b,c){function d(c){b.open({templateUrl:"views/modal-article-preview.html",controller:a,controllerAs:"modalPreviewCtrl",windowClass:"modalPreview",resolve:{articleInfo:function(){return{articleId:c.articleId,languageId:c.languageData.id,publicationId:c.publication.id,issueId:c.issue.number,sectionId:c.section.number}}}})}var e=this;e.openPreview=function(){d(c.articleInstance)}}])}(),function(){function a(a,b,c){var d,e=this;d=["http://newscoop.aes.sourcefabric.net","/admin/image/article","/article_number/",c.articleId,"/language_id/",c.languageId].join(""),e.url=b.trustAsResourceUrl(d),e.close=function(){a.close()}}a.$inject=["$modalInstance","$sce","articleInfo"],angular.module("authoringEnvironmentApp").controller("RenditionsEditorCtrl",["$modal","article",function(b,c){var d=c.articleInstance,e=this;e.openRenditionsEditor=function(){b.open({templateUrl:"views/modal-renditions-editor.html",controller:a,controllerAs:"modalRenditionsCtrl",windowClass:"renditionsModal",resolve:{articleInfo:function(){return{articleId:d.articleId,languageId:d.languageData.id}}}})}}])}(),angular.module("authoringEnvironmentApp").factory("AlohaFormattingFactory",["$rootScope",function(a){a.$on("texteditor-selection-changed",function(){angular.forEach(b,function(a){var b=Aloha.queryCommandState(a);jQuery(".editoricon-"+a.toLowerCase()).parent().toggleClass("active",b)})});var b=[],c=["Insertorderedlist","Insertunorderedlist"];return{get:function(){return b},add:function(a){-1===c.indexOf(a)&&b.push(a)},remove:function(a){var c=b.indexOf(a);c>-1&&b.splice(c,1)},query:function(a){return-1===c.indexOf(a)?Aloha.queryCommandState(a):!1}}}]),angular.module("authoringEnvironmentApp").directive("sfAlohaFormatGeneric",["AlohaFormattingFactory",function(a){var b=['<button class="btn btn-default btn-sm action strong" ','    rel="tooltip" title="{{buttonName}}">','    <i class="editoricon-{{alohaElement|lowercase}} ','              fa fa-{{alohaElement|lowercase}}"></i>',"</button>"].join("");return{template:b,restrict:"A",replace:!0,scope:{alohaElement:"@alohaElement",buttonName:"@buttonName"},link:function(b,c){var d,e;a.add(b.alohaElement),e=Aloha.queryCommandSupported(b.alohaElement),d=Aloha.queryCommandEnabled(b.alohaElement),"undefined"==typeof d&&(d=!0),c.attr("disabled",!e||!d),c.bind("click",function(){Aloha.execCommand(b.alohaElement,!1,""),c.toggleClass("active",a.query(b.alohaElement))})}}}]),function(){function a(a,b,c,d){a.linkData={},["url","text","title"].forEach(function(b){a.linkData[b]=c[b]
}),a.linkData.openNewWindow=!!c.openNewWindow,a.addingNew=d,a.ok=function(){b.close(a.linkData)},a.cancel=function(){b.dismiss(!1)}}function b(b,c,d){function e(e,f){function g(){var a,b,c,e,f=d.getSelection();a=$(f.anchorNode).parents(".aloha-editable"),b=a.length>0,c=!f.isCollapsed,p.attr("disabled",!m||!l||!b||!r&&!c),q.attr("disabled",!(o&&n&&b&&r)),e=r?"Edit Link":"Add Link",p.attr("title",e)}function h(b,d){var f=c.open({templateUrl:"views/modal-edit-link.html",controller:a,scope:e,backdrop:"static",keyboard:!1,resolve:{linkData:function(){return b},addingNew:function(){return d}}});return f.result}function i(){var a,b;a=d.getSelection(),b=$(a.anchorNode).closest("a"),b.length>0&&b.replaceWith(b.html()),r=!1}function j(a){var b,c;c=d.getSelection(),c.removeAllRanges(),b=new Range,b.setStart(a[0],0),b.setEnd(a[0],a[0].childNodes.length),c.addRange(b)}var k,l,m,n,o,p,q,r=!1;k=f.children(),p=$(k[0]),q=$(k[1]),k.unwrap(),m=Aloha.queryCommandSupported("createLink"),l=Aloha.queryCommandEnabled("createLink"),"undefined"==typeof l&&(l=!0),o=Aloha.queryCommandSupported("unlink"),n=Aloha.queryCommandEnabled("unlink"),"undefined"==typeof n&&(n=!0),b.$on("texteditor-selection-changed",function(){r=!!Aloha.queryCommandValue("createLink"),g()}),p.click(function(){var a,b,c,e={},f=d.getSelection();c=$(f.anchorNode).closest("a"),a=c.length<=0,a?b=f.getRangeAt(0):(e.url=c.attr("href"),e.title=c.attr("title"),e.openNewWindow="_blank"===c.attr("target"),j(c)),e.text=f.toString(),h(e,a).then(function(d){a&&(c=jQuery("<a/>"),b.surroundContents(c[0]),c.find("a").each(function(a,b){var c=$(b);c.replaceWith(c.html())})),c.attr("href",d.url),c.attr("title",d.title),d.openNewWindow?c.attr("target","_blank"):c.removeAttr("target"),j(c),r=!0}).finally(function(){g()})}),q.click(function(){r&&(i(),g())}),g()}var f=["<div>",'  <button class="btn btn-default btn-sm" title="Add Link">','      <i class="fa fa-link"></i>',"  </button>",'  <button class="btn btn-default btn-sm" title="Remove Link">','      <i class="fa fa-unlink"></i>',"  </button>","</div>"].join("");return{template:f,restrict:"E",replace:!0,scope:{},link:e}}a.$inject=["$scope","$modalInstance","linkData","addingNew"],angular.module("authoringEnvironmentApp").directive("sfAlohaFormatLink",["$rootScope","$modal","$window",b])}(),angular.module("authoringEnvironmentApp").directive("sfAlohaFormatStyle",function(){return{template:'<button class="dropdown-button">{{styleName}}</button>',restrict:"A",replace:!0,scope:{styleElement:"@styleElement",styleName:"@styleName"},link:function(a,b){var c=Aloha.queryCommandSupported("formatBlock")&&Aloha.queryCommandEnabled("formatBlock");b.toggleClass("disabled",c),b.bind("click",function(){Aloha.execCommand("formatBlock",!1,a.styleElement)})}}}),angular.module("authoringEnvironmentApp").directive("sfIframeLogin",["configuration",function(a){return{template:"<iframe></iframe>",replace:!0,restrict:"E",scope:{onLoadHandler:"&onLoad"},link:function(b,c,d){var e;if(!d.onLoad)throw"sfIframeLogin: missing onLoad handler";e=[a.auth.server,"?client_id=",CSClientId,"&redirect_uri=",a.auth.redirect_uri,"&response_type=token"].join(""),c.attr("src",e),c.attr("width",d.width||570),c.attr("height",d.height||510),c.on("load",function(){try{b.onLoadHandler({location:c[0].contentWindow.location})}catch(a){}})}}}]),angular.module("authoringEnvironmentApp").controller("ToolbarCtrl",["$scope","$rootScope","$filter","$timeout",function(a,b,c,d){var e;a.stylers=[{element:"p",name:"Normal Text"},{element:"h1",name:"Heading 1"},{element:"h2",name:"Heading 2"},{element:"h3",name:"Heading 3"},{element:"h4",name:"Heading 4"},{element:"h5",name:"Heading 5"},{element:"pre",name:"Preformatted"}],a.active=c("filter")(a.stylers,{element:"p"},!0)[0].name,e=function(){var b,e=Aloha.queryCommandValue("formatBlock");e.toString().length>0&&(b=c("filter")(a.stylers,{element:e},!0),b.length>0&&d(function(){a.active=b[0].name}))},b.$on("texteditor-selection-changed",function(){e()}),b.$on("texteditor-command-executed",function(){e()})}]),angular.module("authoringEnvironmentApp").service("article",[function(){}]),angular.module("authoringEnvironmentApp").factory("Article",["$http","$q","ArticleType",function(a,b,c){function d(a){var b="<--";b+="\\s",b+="Snippet",b+="\\s",b+="([\\d]+)",b+="(",b+="(",b+="[\\s]+",b+="(align",b+="|\\w+)",b+="\\s*",b+="=",b+="\\s*",b+="(",b+='"[^"]*"',b+="|[^\\s]*",b+=")",b+=")*",b+=")",b+="[\\s]*",b+="-->";var c=new RegExp(b,"ig"),d=a.replace(c,function(a,b){var c='<div class="snippet" data-id="';return c+=parseInt(b),c+='"></div>'});return d}function e(a){var b="<";b+="\\*\\*",b+="[\\s]*",b+="Image",b+="[\\s]+",b+="([\\d]+)",b+="(",b+="(",b+="[\\s]+",b+="(align|alt|sub",b+="|width|height|ratio",b+="|\\w+)",b+="\\s*",b+="=",b+="\\s*",b+="(",b+='"[^"]*"',b+="|[^\\s]*",b+=")",b+=")*",b+=")",b+="[\\s]*",b+="\\*\\*",b+=">";var c=new RegExp(b,"ig"),d=a.replace(c,function(a,b,c){var d='<div class="image" dropped-image data-id="'+b+'"',e=document.createElement("div");e.innerHTML="<div "+c+"></div>";for(var f=e.childNodes[0].attributes,g=0;g<f.length;g++)d+=" data-"+f[g].name+'="'+f[g].value+'"';return d+="></div>"});return d}function f(a,b){var c,d,e;return"snippet"!==a&&"image"!==a||null===b?b:(e={snippet:"--",image:"**"},c=$("<div/>").html(b),d=c.contents().filter("div."+a),d.replaceWith(function(){var b,c=$(this);return b=["<",e[a]," ",a.charAt(0).toUpperCase(),a.slice(1)," ",parseInt(c.data("id"),10)],$.each(c.data(),function(a,c){"id"!==a&&b.push(" ",a,'="',c,'"')}),b.push(" ",e[a],">"),b.join("")}),c.html().replace(/\&lt\;\*\*/g,"<**").replace(/\*\*\&gt\;/g,"**>").replace(/\&lt\;\-\-/g,"<--").replace(/\-\-\&gt\;/g,"-->"))}function g(a){return e(d(a))}var h,i=new XRegExp("(\\p{Letter}|\\d)+","g");return h=function(a){var b=this;a=a||{},a.fields=a.fields||{},angular.extend(b,a),b.articleId=b.number,delete b.number,Object.keys(b.fields).forEach(function(a){var c=b.fields[a];"string"==typeof c&&(b.fields[a]=g(c))}),b.comments_locked=!!parseInt(b.comments_locked),b.comments_enabled=!!parseInt(b.comments_enabled),b.statusString=_.property(a.status)(_.invert(h.wfStatus))},h.commenting=Object.freeze({ENABLED:0,DISABLED:1,LOCKED:2}),h.wfStatus=Object.freeze({NEW:"N",SUBMITTED:"S",PUBLISHED:"Y",PUBLISHED_W_ISS:"M"}),h.issueWfStatus=Object.freeze({NOT_PUBLISHED:"N",PUBLISHED:"Y"}),h.getById=function(c,d){var e,f=b.defer();return e=Routing.generate("newscoop_gimme_articles_getarticle",{number:c,language:d},!0),a.get(e).success(function(a){var b=new h(a);f.resolve(b)}).error(function(a){f.reject(a)}),f.promise},h.textStats=function(a){var b,c={};return a?(a=$("<div/>").html(a).text(),c.chars=a.length,b=a.match(i),c.words=b?b.length:0):(c.chars=0,c.words=0),c},h.prototype.loadContentFields=function(){var a=this,d=[],e=b.defer();return d.$promise=e.promise,c.getByName(a.type).then(function(a){a.fields.forEach(function(a){return 1===a.isContentField?void d.unshift(a.name):1!==a.showInEditor||"body"!=a.type&&"longtext"!=a.type?void 0:void d.unshift(a.name)}),e.resolve(d)}),e.promise},h.prototype.loadFirstImage=function(){var c=this,d=b.defer(),e=Routing.generate("newscoop_gimme_images_getimagesforarticle",{number:c.articleId,language:c.language},!0);return a.get(e).success(function(a){a.items.length>0?d.resolve(a.items[0].basename):d.reject(a)}).error(function(a){d.reject(a)}),d.promise},h.prototype.searchArticles=function(c,d){var e,f=[],g=b.defer(),i={};return f.$promise=g.promise,_.isEmpty(d)||(i=d),i.items_per_page=20,i.query=c,e=Routing.generate("newscoop_gimme_articles_searcharticles",i,!0),a.get(e).success(function(a){a.items.forEach(function(a){var b=new h(a);f.push(b)}),g.resolve(f)}).error(function(a){g.reject(a)}),g.promise},h.prototype.getRelatedArticles=function(){var c,d=[],e=this,f=b.defer();return d.$promise=f.promise,c=Routing.generate("newscoop_gimme_articles_related",{number:e.articleId,language:e.language},!0),a.get(c).success(function(a){a.items.forEach(function(a){var b=new h(a);d.push(b)}),f.resolve()}).error(function(a){f.reject(a)}),d},h.prototype.addRelatedArticle=function(c){var d=b.defer(),e=this,f=[];return f=["<"+Routing.generate("newscoop_gimme_articles_getarticle",{number:c.articleId},!1)+'; rel="topic">'].join(""),a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:e.articleId,language:e.language},!0),method:"LINK",headers:{link:f}}).success(function(){d.resolve()}).error(function(a){d.reject(a)}),d.promise},h.prototype.removeRelatedArticle=function(c){var d,e=b.defer(),f=this;return d=["<",Routing.generate("newscoop_gimme_articles_getarticle",{number:c.articleId},!1),'; rel="topic">'].join(""),a({url:Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:f.articleId,language:f.language},!0),method:"UNLINK",headers:{link:d}}).success(function(){e.resolve()}).error(function(a){e.reject(a)}),e.promise},h.prototype.save=function(){var c,d,e=b.defer(),g=this;return d=Routing.generate("newscoop_gimme_articles_linkarticle",{number:g.articleId,language:g.language},!0),c=angular.copy(g),Object.keys(c.fields).forEach(function(a){var b=f("image",c.fields[a]);c.fields[a]=f("snippet",b)}),a.patch(d,c).success(function(){e.resolve()}).error(function(a){e.reject(a)}),e.promise},h.prototype.saveSwitches=function(c){var d,e,f=b.defer(),g=this;return e=Routing.generate("newscoop_gimme_articles_linkarticle",{number:g.articleId,language:g.language},!0),d={fields:{}},c.forEach(function(a){d.fields[a]=g.fields[a]}),a.patch(e,d).success(function(){f.resolve()}).error(function(a){f.reject(a)}),f.promise},h.prototype.changeCommentingSetting=function(c){var d,e,f=b.defer();return e=Routing.generate("newscoop_gimme_articles_patcharticle",{number:this.articleId,language:this.language},!0),d={comments_enabled:c===h.commenting.ENABLED,comments_locked:c===h.commenting.LOCKED},a.patch(e,d).success(function(){f.resolve()}).error(function(a){f.reject(a)}),f.promise},h.prototype.setWorkflowStatus=function(b){var c=Routing.generate("newscoop_gimme_articles_changearticlestatus",{number:this.articleId,language:this.language,status:b},!0);return a.patch(c)},h.prototype.releaseLock=function(){function c(){f.isLocked=!1,e.resolve()}var d,e=b.defer(),f=this;return d=Routing.generate("newscoop_gimme_articles_changearticlelockstatus",{number:this.articleId,language:this.language},!0),a.delete(d).success(c).error(function(a,b){403===b?c():e.reject(a)}),e.promise},h}]),angular.module("authoringEnvironmentApp").factory("ArticleType",["$http","$q",function(a,b){var c=this,d=function(){};return c.createFromApiData=function(a){var b=new d;return b.name=a.name,b.fields=[],a.fields.forEach(function(a){b.fields.push(angular.copy(a))}),b},d.getByName=function(c){var e=b.defer(),f=Routing.generate("newscoop_gimme_articletypes_getarticletype",{name:c},!0);return a.get(f).success(function(a){e.resolve(d.createFromApiData(a))}).error(function(a){e.reject(a)}),e.promise},d.createFromApiData=c.createFromApiData,d}]),angular.module("authoringEnvironmentApp").directive("sfDroppable",["$compile","Dragdata",function(a,b){var c,d,e;return e="h1, h2, h3, h4, h5, h6, ol, p, pre, table, ul",d="drag-drop-placeholder",c="."+d,{restrict:"A",link:function(f,g){function h(){var a=$("<div>&nbsp;</div>").addClass(d).attr("contenteditable",!1);return a}function i(d){var g,h,i=$(d.target);d.preventDefault(),d.stopPropagation(),j=0,$(c).remove(),g=b.getDropped(d.originalEvent.dataTransfer.getData("Text")),h=a(g)(f),i.is(e)?i.after(h):k.prepend(h)}var j,k=$(g);j=0,k.on("dragover",e,function(a){var b=$(a.target);b.next().is(c)||b.after(h())}),k.on("dragleave",e,function(a){var b=$(a.target).next();b.is(c)&&b.remove()}),k.on("drop",e,i),k.on("dragenter",function(){var a;j++,k.children(":first").is(c)||(a=h(),a.on("dragenter",function(){a.addClass("drag-over")}),a.on("dragleave",function(){a.removeClass("drag-over")}),k.prepend(a))}),k.on("dragleave",function(){var a=k.children(":first");j--,1>j&&a.is(c)&&a.remove()}),k.on("drop",i)}}}]),angular.module("authoringEnvironmentApp").directive("sfDraggable",["Dragdata","$log",function(a,b){function c(b){b.attr("draggable",!0),b.addClass("draggable"),b.on("dragstart",function(c){var d=a.getData(b);c.originalEvent.dataTransfer.setData("Text",d)})}function d(a){a.attr("draggable",!1),a.removeClass("draggable")}return{restrict:"A",scope:{allowDrag:"=sfDraggable"},link:function(e,f){var g=a.checkDraggable(f);g&&b.debug(g),e.$watch(function(){return e.allowDrag},function(a){a?c(f):d(f)})}}}]),angular.module("authoringEnvironmentApp").directive("dragSort",[function(){var a,b=-1,c=null,d=-1,e=function(e){e.attr("draggable",!0),e.on("dragstart",function(b){var c;a.children().each(function(a,b){$(b).attr("data-sort-index",a)}),c={sortIndex:parseInt(e.attr("data-sort-index"),10)},d=c.sortIndex,b.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(c)),b.originalEvent.dataTransfer.effectAllowed="move",e.addClass("dragged")}),e.on("dragend",function(){e.removeClass("dragged"),c&&c.remove(),a.children().each(function(a,b){$(b).removeAttr("data-sort-index")}),b=-1,d=-1}),e.on("dragenter",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),e.on("dragover",function(f){var g,h,i,j,k=parseInt(e.attr("data-sort-index"),10);if(f.originalEvent.preventDefault(),f.originalEvent.stopPropagation(),f.originalEvent.dataTransfer.dropEffect="move",i=void 0===f.originalEvent.offsetY?f.originalEvent.pageY-e.offset().top:f.originalEvent.offsetY,g=e.outerHeight(),h=g/2>i?k:k+1,h!==b){if(b=h,c&&c.remove(),b===d||b===d+1)return;c=$('<div class="new-item-slot"></div>'),j=a.children().eq(b),j.length>0?c.insertBefore(j):a.append(c)}}),e.on("drop",function(a){a.originalEvent.preventDefault()})},f=function(a,c){a.on("dragover",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),a.on("dragenter",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),a.on("drop",function(a){var d,e,f;a.originalEvent.preventDefault(),a.originalEvent.stopPropagation(),d=a.originalEvent.dataTransfer.getData("text/plain"),d=JSON.parse(d),f=d.sortIndex,b>f&&(b-=1),f!==b&&(e=c.items.splice(f,1)[0],c.items.splice(b,0,e),c.$apply(),c.orderChangedCallback())})},g=function(b,c){a=$(c[0]),b.$watchCollection("items",function(b,c){var d=a.children(),f=_.difference(b,c);angular.forEach(d,function(a,c){_.indexOf(f,b[c])>-1&&e($(a))})}),f(a,b)};return{restrict:"A",scope:{items:"=",orderChangedCallback:"&onOrderChanged"},link:g}}]),angular.module("authoringEnvironmentApp").service("Dragdata",["$log",function(a){this.converters={test:function(){return{}},image:function(a){return{id:a.attr("data-id"),width:a.attr("data-width")}},embed:function(a){return{id:a.attr("data-id")}}},this.available=function(){var a=[];return angular.forEach(this.converters,function(b,c){a.push(c)}),a},this.checkDraggable=function(a){var b=a.attr("data-draggable-type");return b?b in this.converters?!1:'error: draggable type "'+b+'" is not supported':"error: a draggable element has not a data-draggable-type attribute"},this.getData=function(a){var b=a.attr("data-draggable-type"),c=this.converters[b],d=c(a);return d.type=b,JSON.stringify(d)},this.getDropped=function(b){var c=JSON.parse(b);switch(c.type){case"test":return $("<div>").text("test dropped");case"image":return Aloha.jQuery("<div>").data({id:c.id}).alohaBlock({"aloha-block-type":"ImageBlock"});case"embed":return Aloha.jQuery("<div>").addClass("snippet").data({id:c.id}).append($("<dropped-snippet>").attr({"data-snippet-id":c.id})).alohaBlock();default:a.debug("getDropped function called on a malformed data object, no known type into it")}}}]),angular.module("authoringEnvironmentApp").factory("SnippetTemplate",["$http","$q",function(a,b){var c=this,d=function(){};return c.createFromApiData=function(a){var b=new d;return["id","name","enabled","favourite"].forEach(function(c){b[c]=a[c]}),b.fields=[],_.forEach(a.fields,function(a){"frontend"===a.scope&&b.fields.push(angular.copy(a))}),b},d.getAll=function(){var d=b.defer(),e=[];return e.$promise=d.promise,a.get(Routing.generate("newscoop_gimme_snippettemplates_getsnippettemplates",{},!0),{params:{items_per_page:99999}}).success(function(a){a.items.forEach(function(a){a=c.createFromApiData(a),e.push(a)}),d.resolve()}).error(function(a){d.reject(a)}),e},d.createFromApiData=c.createFromApiData,d}]),angular.module("authoringEnvironmentApp").factory("Snippet",["$http","$q",function(a,b){var c=this,d=function(){};return c.createFromApiData=function(a){var b=new d;return["id","templateId","name","render"].forEach(function(c){b[c]=a[c]}),b},d.getAllByArticle=function(d,e){var f,g=b.defer(),h=[];return h.$promise=g.promise,f={params:{rendered:!0,items_per_page:99999}},a.get(Routing.generate("newscoop_gimme_snippets_getsnippetsforarticle_1",{number:d,language:e},!0),f).success(function(a){a.items&&a.items.forEach(function(a){a=c.createFromApiData(a),h.push(a)}),g.resolve()}).error(function(a){g.reject(a)}),h},d.getById=function(d){var e=b.defer(),f=Routing.generate("newscoop_gimme_snippets_getsnippet",{snippetId:d},!0);return a.get(f,{params:{rendered:!0}}).success(function(a){e.resolve(c.createFromApiData(a))}).error(function(a){e.reject(a)}),e.promise},d.create=function(d,e,f){var g,h=b.defer();return g={template:e,snippet:{name:d,fields:{}}},_.forEach(f,function(a,b){g.snippet.fields[b]={data:a}}),a.post(Routing.generate("newscoop_gimme_snippets_createsnippet",{},!0),g).then(function(b){var c=b.headers("x-location");return a.get(c,{params:{rendered:!0}})},function(){return b.reject()}).then(function(a){var b=c.createFromApiData(a.data);h.resolve(b)},function(){h.reject()}),h.promise},d.prototype.addToArticle=function(c,d){var e,f=this,g=b.defer();return e="<"+Routing.generate("newscoop_gimme_snippets_getsnippet",{snippetId:f.id},!1)+'; rel="snippet">',a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:c,language:d},!0),method:"LINK",headers:{link:e}}).success(function(){g.resolve()}).error(function(a){g.reject(a)}),g.promise},d.prototype.removeFromArticle=function(c,d){var e,f=this,g=b.defer();return e="<"+Routing.generate("newscoop_gimme_snippets_getsnippet",{snippetId:f.id},!1)+'; rel="snippet">',a({url:Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:c,language:d},!0),method:"UNLINK",headers:{link:e}}).success(function(){g.resolve()}).error(function(a){g.reject(a)}),g.promise},d}]),angular.module("authoringEnvironmentApp").service("snippets",["$log","article","Snippet",function(a,b,c){var d=b.articleInstance,e=this;e.article=d,e.attached=c.getAllByArticle(d.articleId,d.language),e.inArticleBody={},e.addToIncluded=function(a){e.inArticleBody[a]=!0},e.removeFromIncluded=function(a){delete e.inArticleBody[a]},e.matchMaker=function(a){return function(b){return parseInt(b.id)===parseInt(a)}},e.addToArticle=function(b,c){var d,f=e.matchMaker(b.id);return _.find(e.attached,f)?void a.warn("Snippet",b.id,"is already attached."):(d=b.addToArticle(c.articleId,c.language),d.then(function(){e.attached.push(b)}),d)},e.removeFromArticle=function(b,c){var d,f=e.matchMaker(b.id);return _.find(e.attached,f)?(d=b.removeFromArticle(c.articleId,c.language),d.then(function(){_.remove(e.attached,f)}),d):void a.warn("Snippet",b.id,"is already detached.")}}]),angular.module("authoringEnvironmentApp").controller("PaneSnippetsCtrl",["$scope","$q","article","Snippet","SnippetTemplate","snippets","modalFactory",function(a,b,c,d,e,f,g){var h=c.articleInstance;a.clearNewSnippetForm=function(){a.newSnippet.name="",a.newSnippet.template=null,a.snippetTemplates.forEach(function(a){a.fields.forEach(function(a){delete a.value})})},a.addNewSnippetToArticle=function(c){var e,g={};a.addingNewSnippet=!0,c.template.fields.forEach(function(a){g[a.name]=a.value}),d.create(c.name,c.template.id,g).then(function(a){return e=a,f.addToArticle(e,h)},b.reject).then(function(){a.showAddSnippet=!1,a.clearNewSnippetForm()},b.reject).finally(function(){a.addingNewSnippet=!1})},a.confirmRemoveSnippet=function(a){var b,c,d;c="Do you really want to remove this snippet?",d="Should you change your mind, the snippet can always be added again.",b=g.confirmLight(c,d),b.result.then(function(){f.removeFromArticle(a,h)})},a.inArticleBody=function(a){return!!f.inArticleBody[a]},a.showAddSnippet=!1,a.newSnippet={name:"",template:null},a.addingNewSnippet=!1,a.inputFieldTypes=Object.freeze({integer:"number",text:"text",url:"url"}),a.snippetTemplates=e.getAll(),a.snippets=f.attached,a.$watchCollection(f.attached,function(){a.snippets=f.attached})}]),angular.module("authoringEnvironmentApp").controller("DroppedSnippetCtrl",["$scope","$sce","$rootScope","Snippet","snippets",function(a,b,c,d,e){a.expanded=!1,a.snippets=e,this.init=function(c){d.getById(c).then(function(c){a.snippetHtml=b.trustAsHtml(c.render),a.snippet=c,e.addToIncluded(c.id)})},this.snippetRemoved=function(a){e.removeFromIncluded(a),c.$apply(e.inArticleBody)},a.expand=function(){a.expanded=!0},a.collapse=function(){a.expanded=!1}}]),angular.module("authoringEnvironmentApp").directive("droppedSnippet",[function(){return{restrict:"E",templateUrl:"views/dropped-snippet.html",controller:"DroppedSnippetCtrl",scope:{snippetId:"@"},link:function(a,b,c,d){var e=parseInt(a.snippetId);b.find(".remove").on("click",function(){b.parent().remove(),d.snippetRemoved(parseInt(a.snippetId,10))}),d.init(e)}}}]),angular.module("authoringEnvironmentApp").directive("autoListOffset",[function(){return{restrict:"A",link:function(a,b,c){function d(){var a=Math.round(f.outerHeight());0!==a&&(i?(a=e,i=!1):a+=h,g.css("top",a))}var e,f,g,h=125,i=!0;e=parseInt(c.autoListOffset),(isNaN(e)||1>e)&&(e=150),f=b.find(".paneFormWrapper"),g=b.find(".list"),f.mutate("height",function(){d()}),d()}}}]),angular.module("authoringEnvironmentApp").factory("NcImage",["$http","$q","$upload","formDataFactory",function(a,b,c,d){var e;return e=function(a){var b,c=this;b=["id","basename","thumbnailPath","description","photographer","photographerUrl"],a=a||{},b.forEach(function(b){c[b]=a[b]}),c.width="width"in a?parseInt(a.width,10):void 0,c.height="height"in a?parseInt(a.height,10):void 0},e.getById=function(c){var d=b.defer();return a.get(Routing.generate("newscoop_gimme_images_getimage",{number:c},!0)).success(function(a){d.resolve(new e(a))}).error(function(a){d.reject(a)}),d.promise},e.query=function(c,d,f){var g,h,i=b.defer(),j=[];return j.$promise=i.promise,g={params:{expand:!0,items_per_page:d,page:c}},f&&(g.params.query=f),h=Routing.generate("newscoop_gimme_images_searchimages",{},!0),a.get(h,g).success(function(a){a=a||{},a.items&&a.items.forEach(function(a){a=new e(a),j.push(a)}),i.resolve({items:j,pagination:a.pagination})}).error(function(a){i.reject(a)}),j},e.getAllByArticle=function(c,d){var f,g=b.defer(),h=[];return h.$promise=g.promise,f={params:{expand:!0,items_per_page:99999}},a.get(Routing.generate("newscoop_gimme_images_getimagesforarticle",{number:c,language:d},!0),f).success(function(a){a.items&&a.items.forEach(function(a){a=new e(a),h.push(a)}),g.resolve(h)}).error(function(a){g.reject(a)}),h},e.addAllToArticle=function(c,d,e){var f=b.defer(),g=[];return e.forEach(function(a){g.push("<"+Routing.generate("newscoop_gimme_images_getimage",{number:a.id},!1)+'; rel="image">')}),g=g.join(","),a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:c,language:d},!0),method:"LINK",headers:{link:g}}).success(function(){f.resolve()}).error(function(a){f.reject(a)}),f.promise},e.upload=function(a,e){var f,g=b.defer(),h=d.makeInstance(),i="No x-location header in API response.";return"function"!=typeof e&&(e=function(){}),h.append("image[image]",a),h.append("image[photographer]",a.photographer||""),h.append("image[description]",a.description||""),c.http({method:"POST",url:Routing.generate("newscoop_gimme_images_createimage",{},!0),data:h,headers:{"Content-Type":void 0},transformRequest:angular.identity}).progress(e).success(function(a,b,c){var d,h;e({loaded:100,total:100}),h=c()["x-location"],h?(f=h.split("/"),d=parseInt(f[f.length-1],10),g.resolve({id:d,url:h})):(console.warn(i),g.reject(i))}).error(function(){g.reject("error uploading")}),g.promise},e.prototype.updateDescription=function(c){var d,e,f=b.defer(),g=this;return e=Routing.generate("newscoop_gimme_images_updateimage",{number:g.id},!0),d={number:g.id,image:{description:c}},a({method:"PATCH",url:e,data:d}).success(function(){g.description=c,f.resolve()}).error(function(a){f.reject(a)}),f.promise},e.prototype.removeFromArticle=function(c,d){var e,f=this,g=b.defer();return e="<"+Routing.generate("newscoop_gimme_images_getimage",{number:f.id},!1)+'; rel="image">',a({url:Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:c,language:d},!0),method:"UNLINK",headers:{link:e}}).success(function(){g.resolve()}).error(function(a){g.reject(a)}),g.promise},e}]),angular.module("authoringEnvironmentApp").service("images",["pageTracker","configuration","$log","article","getFileReader","formDataFactory","imageFactory","NcImage","$rootScope","$q",function(a,b,c,d,e,f,g,h,i,j){var k,l=this,m=50;l.query=function(b){for(l.searchFilter=b;l.displayed.length>0;)l.displayed.pop();for(;l.loaded.length>0;)l.loaded.pop();l.tracker.reset(),l.itemsFound=0,l.canLoadMore=!1,l.load(l.tracker.next(),l.searchFilter).then(function(b){l.displayed=b.items,b.pagination?(l.itemsPerPage=b.pagination.itemsPerPage,l.itemsFound=b.pagination.itemsCount):(l.itemsPerPage=m,l.itemsFound=b.items.length),l.canLoadMore=!a.isLastPage(b.pagination),l.canLoadMore&&l.more()})},l.more=function(){var b=l.loaded.splice(0,l.itemsPerPage);l.displayed=l.displayed.concat(b),l.canLoadMore&&l.load(l.tracker.next(),l.searchFilter).then(function(b){l.loaded=l.loaded.concat(b.items),l.canLoadMore=!a.isLastPage(b.pagination)})},l.load=function(a,b){var c=h.query(a,l.itemsPerPage,b).$promise;return c.catch(function(){l.tracker.remove(a)}),c},l.loadAttached=function(a){l.attached=h.getAllByArticle(a.articleId,a.language),l.attached.$promise.then(k.resolve,k.reject)},l.collect=function(a,b){var c;l.isCollected(a)||(b?h.getById(a).then(function(a){l.collected.push(a)}):(c=_.find(l.displayed,{id:a}),c&&l.collected.push(c)))},l.discard=function(a){_.remove(l.collected,{id:a})},l.discardAll=function(){for(;l.collected.length>0;)l.collected.pop();for(;l.images2upload.length>0;)l.images2upload.pop()},l.attachAllCollected=function(){var a=[];l.collected.forEach(function(b){_.find(l.attached,b)||a.push(b)}),a.length<1||h.addAllToArticle(l.article.articleId,l.article.language,a).then(function(){a.forEach(function(a){l.attached.push(a)})})},l.detach=function(a){var b=_.find(l.attached,{id:a});b&&b.removeFromArticle(l.article.articleId,l.article.language).then(function(){_.remove(l.attached,{id:a})})},l.addToIncluded=function(a){l.inArticleBody[a]=!0},l.removeFromIncluded=function(a){delete l.inArticleBody[a]},l.findAttached=function(a){return _.find(l.attached,{id:a})},l.findCollected=function(a){return _.find(l.collected,{id:a})},l.byId=function(a){var b=l.findAttached(a);if(b)return b;throw new Error("asking details about an image which is not attached to the article is not supported")},l.isAttached=function(a){return"undefined"!=typeof l.findAttached(a)},l.isCollected=function(a){return"undefined"!=typeof l.findCollected(a)},l.togglerClass=function(a){return l.isCollected(a)?"glyphicon-minus":"glyphicon-plus"},l.toggleCollect=function(a){l.isCollected(a)?l.discard(a):l.collect(a)},l.addToUploadList=function(a){var b,c;for(b=0;b<a.length;b++)c=l.decorate(a[b]),l.images2upload.push(c),c.readRawData()},l.removeFromUploadList=function(a){_.remove(l.images2upload,a)},l.clearUploadList=function(){for(;l.images2upload.length>0;)l.images2upload.pop()},l.uploadAll=function(){var a,b=[];return l.images2upload.forEach(function(c){a=h.upload(c,c.progressCallback),b.push(a)}),b},l.decorate=function(a){return a.progress=0,a.max=0,a.percent="0%",a.progressCallback=function(b){a.progress=b.loaded,a.max=b.total,a.percent=Math.round(b.loaded/b.total*100)+"%"},a.readRawData=function(){var b=j.defer(),c=e.get();return c.onload=function(){var d=g.makeInstance();d.onload=function(c){a.width=d.width,a.height=d.height,a.src=d.src,b.resolve(c.target.result),i.$apply()},d.src=c.result},c.readAsDataURL(a),b.promise},a},k=j.defer(),l.attachedLoaded=k.promise,l.article=d.articleInstance,l.loadAttached(l.article),l.tracker=a.getTracker({max:100}),l.loaded=[],l.displayed=[],l.collected=[],l.images2upload=[],l.includedIndex=-1,l.inArticleBody={},l.itemsPerPage=m,l.itemsFound=0,l.searchFilter="",l.canLoadMore=!1}]),angular.module("authoringEnvironmentApp").service("modal",["$templateCache","$log","$http",function(){var a="#myModal",b=this;this.visible=!1,this.show=function(c){this.title=c.title,this.url=c.templateUrl,c.backdrop="static",c.keyboard=!1,c.show=!0,$(a).modal(c),b.visible=!0},this.hide=function(){this.visible=!1,$(a).modal("hide")}}]),angular.module("authoringEnvironmentApp").controller("ModalCtrl",["$scope","modal",function(a,b){a.modal=b}]),angular.module("authoringEnvironmentApp").controller("ImagePaneCtrl",["$scope","images","modal","modalFactory","configuration",function(a,b,c,d,e){a.images=b,a.defaultWidth="100%",a.root=e.API.rootURI,a.attachModal=function(){c.show({title:"Attach Image",templateUrl:"views/attach-image.html"})},a.detachingAllowed=function(a){return!b.inArticleBody[a]},a.detachImage=function(a){var c,e,f;e="Do you really want to detach this image from the article?",f="Should you change your mind, the image can always be re-attached again.",c=d.confirmLight(e,f),c.result.then(function(){b.detach(a)},function(){})}}]),angular.module("authoringEnvironmentApp").controller("MediaArchiveCtrl",["$scope","images","configuration",function(a,b,c){a.images=b,a.root=c.API.rootURI,a.searchFilter="",a.$watch("images.searchFilter",function(b){a.appliedFilter=b}),a.thumbnailClicked=function(a){var c=b.isAttached(a),d=b.isCollected(a);c||d||b.toggleCollect(a)},a.searchArchive=function(a){b.query(a)},a.loadMore=function(){b.more()}}]),angular.module("authoringEnvironmentApp").controller("AttachImageCtrl",["$scope","$q","images","modal","configuration",function(a,b,c,d,e){a.root=e.API.rootURI,a.images=c,a.sources=[{value:"computer",url:"views/attach-image/computer.html",description:"From Computer"},{value:"archive",url:"views/attach-image/archive.html",description:"Media Archive"}],a.selected=a.sources[1],a.select=function(b){a.selected=b},a.attachCollected=function(){c.attachAllCollected(),c.discardAll(),d.hide()},a.discardChanges=function(a){a.preventDefault(),a.stopPropagation(),c.discardAll(),d.hide()}}]),angular.module("authoringEnvironmentApp").controller("UploadFromCompCtrl",["$scope","images","$q",function(a,b,c){a.images2upload=b.images2upload,a.uploading=!1,a.$watchCollection("images.images2upload",function(b){a.images2upload=b}),a.addToUploadList=function(c){b.addToUploadList(c),a.$apply()},a.removeFromStaging=function(a){b.removeFromUploadList(a)},a.uploadStaged=function(){var d;a.uploading=!0,d=b.uploadAll(),c.all(d).then(function(a){a.forEach(function(a){b.collect(a.id,!0)}),b.clearUploadList()}).finally(function(){a.uploading=!1})},a.clearStaged=function(){b.clearUploadList()},a.setForAllPhotographer=function(a){b.images2upload.forEach(function(b){b.photographer=a})},a.setForAllDescription=function(a){b.images2upload.forEach(function(b){b.description=a})}}]),angular.module("authoringEnvironmentApp").service("pageTracker",function(){this.isLastPage=function(a){if("undefined"==typeof a)return!0;["itemsPerPage","currentPage","itemsCount"].map(function(b){a[b]=parseInt(a[b],10)});var b=a.itemsCount/a.itemsPerPage;return a.currentPage>=b},this.getTracker=function(){return{counter:1,pages:{},remove:function(a){delete this.pages[a]},has:function(a){return a in this.pages},next:function(){for(var a=1;a<=this.counter;a++)if(this.has(a)===!1)return this.pages[a]=!0,a===this.counter&&this.counter++,a
},reset:function(){this.pages={},this.counter=1}}}}),function(){function a(a){var b=[];this.toggleToolbar=function(a){var c="none"===a.css("display");_.find(b,a)||b.push(a),c&&b.forEach(function(a){a.hide()}),a.toggle(c)},this.deregisterToolbar=function(a){_.remove(b,a)},a.$on("texteditor-editable-deactivated",function(){b.forEach(function(a){a.hide()})})}a.$inject=["$rootScope"],angular.module("authoringEnvironmentApp").directive("droppedImagesContainer",function(){return{restrict:"A",controller:a}})}(),angular.module("authoringEnvironmentApp").directive("droppedImage",["configuration","$log","$timeout",function(a,b,c){return{restrict:"A",templateUrl:"views/dropped-image.html",controller:"DroppedImageCtrl",scope:{imageId:"@imageId",alignment:"@imageAlignment",size:"@imageSize"},require:["dropped-image","^^dropped-images-container"],link:function(d,e,f,g){function h(){var a;return(!j||j.length<1)&&(j=$("#img-toolbar-"+d.imageId),a=j.detach(),p.append(a)),j}function i(){var a,b,c,d=h();a=p.css("float"),"left"===a?b=0:"right"===a?(b=p.outerWidth()-d.outerWidth(),b=Math.round(b)):(b=o.outerWidth()-d.outerWidth(),b=Math.round(b/2)),c=-(d.outerHeight()+15),h().css({left:b,top:c})}var j,k=g[0],l={},m=g[1],n=$(e),o=n.find(".dropped-image"),p=n.parent();d.activeSize=null,d.activeAlignment=null,n.find("button.close").click(function(){p.remove(),k.imageRemoved(parseInt(d.imageId,10))}),n.find(".caption").click(function(a){a.stopPropagation()}),o.click(function(){m.toggleToolbar(h())}),e.on("$destroy",function(){m.deregisterToolbar(h())}),d.setAlignment=function(a){var c,e;switch(a){case"left":c="left",e="2% 2% 2% 0",d.activeAlignment="left";break;case"right":c="right",e="2% 0 2% 2%",d.activeAlignment="right";break;case"center":c="none",e="2% auto",d.activeAlignment="center";break;default:return b.warn("unknown image alignment:",a),void(d.activeAlignment=null)}n.css({"float":c}),p.css({"float":c,margin:e}),"center"===a&&p.css({margin:"auto"}),p.attr("data-alignment",a),i()},d.setSize=function(b,c){var e;return b.match(/^\d+px$/)?(e=b.substring(0,b.length-2),d.changePixelSize(parseInt(e)),d.activeSize="custom",void i()):(b in a.image.width?(e=a.image.width[b],d.activeSize=b):(e=d.image.width+2+"px",d.activeSize="original"),p.css("width",e),n.css("width","100%"),p.attr("data-size",b),d.widthPx=n.innerWidth(),c&&(d.widthPx-=2),void i())},d.changePixelSize=function(a){angular.isNumber(a)&&a>0&&(a=Math.round(a),n.css("width",a+"px"),p.css("width",a+2+"px"),p.attr("data-size",a+"px"),d.widthPx=a,d.activeSize="custom",i())},l.alignment=d.alignment||"center",l.size=d.size||"medium",k.init(parseInt(d.imageId,10)).then(function(){d.setAlignment(l.alignment),d.setSize(l.size,!0),c(i,0)})}}}]),angular.module("authoringEnvironmentApp").controller("DroppedImageCtrl",["images","$scope","configuration","NcImage","$rootScope","$q",function(a,b,c,d,e,f){this.init=function(c){var d=f.defer();return a.attachedLoaded.then(function(){b.image=a.byId(c),a.addToIncluded(b.image.id),b.newCaption=b.image.description,d.resolve(b.image)}),d.promise},this.imageRemoved=function(b){a.removeFromIncluded(b),e.$apply(a.inArticleBody)},b.editCaptionMode=function(a){a&&(b.newCaption=b.image.description),b.editingCaption=a},b.updateCaption=function(){b.editingCaption=!1,b.image.updateDescription(b.newCaption).catch(function(){b.newCaption=b.image.description})},b.editingCaption=!1,b.newCaption="",b.root=c.API.rootURI,b.images=a}]),angular.module("authoringEnvironmentApp").factory("configuration",function(){return{API:{rootURI:"http://newscoop.aes.sourcefabric.net",endpoint:"/content-api",full:"http://newscoop.aes.sourcefabric.net/content-api"},auth:{client_id:"7_6203opwgvx8g4skgskksgkws8cs44ks8s4cw4sc8cg4wsk8c40",redirect_uri:"http://localhost:9000",server:"http://newscoop.aes.sourcefabric.net/oauth/v2/auth"},article:{width:{desktop:960,tablet:600,phone:320}},image:{width:{small:"30%",medium:"50%",big:"100%"},"float":"none"},articleTypeFields:{news:{dateline:{name:"dateline",displayName:"Date Line",order:10,defaultText:"[please provide your One-Word-Catchline here]"},title:{name:"title",displayName:"Title",order:20},lede:{name:"lede",displayName:"Lead",order:30,defaultText:"[please provide your content]"},mainImage:{name:"mainImage",displayName:"Main Image",order:40},body:{name:"body",displayName:"Body",order:50,defaultText:"[please provide your content]"}},newswire:{dateline:{name:"dateline",displayName:"Date Line",order:10,defaultText:"[Please provide your One-Word-Catchline here]"},title:{name:"title",displayName:"Title",order:20},dataLead:{name:"dataLead",displayName:"Lead",order:30,defaultText:"[please provide your content]"},mainImage:{name:"mainImage",displayName:"Main Image",order:40},dataContent:{name:"dataContent",displayName:"Body",order:50,defaultText:"[please provide your content]"}},blog:{title:{name:"title",displayName:"Title",order:10},lede:{name:"lede",displayName:"Lead",order:20,defaultText:"[please provide your content]"},mainImage:{name:"mainImage",displayName:"Main Image",order:30,isRegular:!1},body:{name:"body",displayName:"Body",order:40,defaultText:"[please provide your content]"}}}}}),angular.module("authoringEnvironmentApp").directive("fixedImagePlaceholder",function(){return{templateUrl:"views/fixed-image-placeholder.html",restrict:"E",link:function(a,b){b.on("drop",function(b){b.preventDefault();var c=b.originalEvent.dataTransfer.getData("Text");a.onDrop(c)})}}}),angular.module("authoringEnvironmentApp").controller("FixedImagePlaceholderCtrl",["$scope","images","configuration",function(a,b,c){a.root=c.API.rootURI,a.style={},a.dropped=!1,a.onDrop=function(c){var d=JSON.parse(c);"image"===d.type&&a.$apply(function(){a.image=b.byId(d.id),a.style.opacity=1,a.dropped=!0})}}]),angular.module("authoringEnvironmentApp").factory("authInterceptor",["$injector","$q",function(a,b){return{request:function(b){var c,d,e=a.get("userAuth");return c=Routing.generate("newscoop_gimme_articles_getarticles",{},!1),c=c.substring(1,c.lastIndexOf("/")),-1===b.url.indexOf(c+"/")?b:(b.headers=b.headers||{},d=e.token(),d&&(b.headers.Authorization="Bearer "+d),b)},responseError:function(c){var d,e,f,g,h;return g=a.get("userAuth"),c.config.IS_RETRY?b.reject(c):401===c.status||"OAuth2 authentication required"===c.statusText?(e=c.config,f=b.defer(),g.newTokenByLoginModal().then(function(){h=a.get("$http"),d=angular.copy(e),d.IS_RETRY=!0,h(d).then(function(a){delete a.config.IS_RETRY,f.resolve(a)}).catch(function(){f.reject(c)})}).catch(function(){f.reject(c)}),f.promise):b.reject(c)}}}]),angular.module("authoringEnvironmentApp").service("addToUrl",function(){this.add=function(a,b){var c="";return angular.forEach(a,function(a,b){c+="&"+b+"="+a}),/[?]/.test(b)||(c="?"+c.slice(1)),b+c}}),angular.module("authoringEnvironmentApp").service("mode",function(){this.current="normal",this.zen=!1,this.goZen=function(){this.current="zen",this.zen=!0},this.goNormal=function(){this.current="normal",this.zen=!1}}),angular.module("authoringEnvironmentApp").service("platform",function(){var a=this;this.current="desktop",this.go={mobile:function(){a.current="mobile"},desktop:function(){a.current="desktop"},tablet:function(){a.current="tablet"}}}),angular.module("authoringEnvironmentApp").service("comments",["article","$http","$q","$resource","transform","pageTracker","$log","nestedSort",function(a,b,c,d,e,f,g,h){function i(a){return a.selected=!1,a.showStatus="collapsed",a.isEdited=!1,a.recommended=!!a.recommended,a.editing={status:a.status},a.reply={subject:"Re: "+a.subject,message:""},a.isReplyMode=!1,a.sendingReply=!1,a.collapse=function(){this.showStatus="collapsed",this.isReplyMode=!1},a.expand=function(){this.showStatus="expanded"},a.toggle=function(){"expanded"===this.showStatus?this.collapse():this.expand()},a.edit=function(){this.editing.subject=this.subject,this.editing.message=this.message,this.isEdited=!0,this.isReplyMode=!1},a.cancel=function(){this.isEdited=!1},a.save=function(){var a=this;l.resource.save({articleNumber:j.articleId,languageCode:j.language,commentId:a.id},{comment:a.editing},function(){a.subject=a.editing.subject,a.message=a.editing.message,a.isEdited=!1})},a.remove=function(){var a=this;l.resource.delete({articleNumber:j.articleId,languageCode:j.language,commentId:a.id}).$promise.then(function(){_.remove(l.displayed,l.matchMaker(a.id))})},a.replyTo=function(){a.isReplyMode=!0},a.cancelReply=function(){a.isReplyMode=!1},a.sendReply=function(){var a=this,b=angular.copy(a.reply);b.parent=a.id,a.sendingReply=!0,l.add({comment:b}).then(function(){a.sendingReply=!1,a.isReplyMode=!1,a.reply={subject:"Re: "+a.subject,message:""}})},a.toggleRecommended=function(){var a=this,b=!a.recommended;l.resource.toggleRecommended({commentId:a.id},{comment:{recommended:b?1:0}},function(){a.recommended=b})},a.changeStatus=function(a){var b=this;l.resource.patch({articleNumber:j.articleId,languageCode:j.language,commentId:b.id},{comment:{status:a}},function(){b.status=a},function(){g.debug("error changing the status for the comment")})},a}var j=a.articleInstance,k=50,l=this,m="nested";l.canLoadMore=!0,l.loaded=[],l.displayed=[],l.tracker=f.getTracker(),l.resource=d(Routing.generate("newscoop_gimme_comments_getcommentsforarticle_1",{},!0)+"/:articleNumber/:languageCode",{},{create:{method:"POST",transformRequest:e.formEncode},patch:{method:"PATCH",url:Routing.generate("newscoop_gimme_comments_updatecomment_1",{},!0)+"/:articleNumber/:languageCode/:commentId",transformRequest:e.formEncode},save:{method:"POST",url:Routing.generate("newscoop_gimme_comments_createcomment",{},!0)+"/:articleNumber/:languageCode/:commentId",transformRequest:e.formEncode},"delete":{method:"DELETE",url:Routing.generate("newscoop_gimme_comments_deletecomment_1",{},!0)+"/:articleNumber/:languageCode/:commentId"},toggleRecommended:{method:"PATCH",url:Routing.generate("newscoop_gimme_comments_updatecomment",{},!0)+"/:commentId.json"}}),l.add=function(a){var d=c.defer();return l.resource.create({articleNumber:j.articleId,languageCode:j.language},a,function(a,c){var e=c("X-Location");e?b.get(e).success(function(a){l.displayed.push(i(a)),h.sort(l.displayed)}):l.init(),d.resolve()}),d.promise},l.init=function(a){l.tracker=f.getTracker(),l.canLoadMore=!0,l.loaded=[],l.displayed=[],m=a&&a.sorting?a.sorting:"nested",l.load(l.tracker.next()).then(function(a){l.displayed=a.items.map(i),h.sort(l.displayed),l.canLoadMore&&l.load(l.tracker.next()).then(function(a){l.loaded=l.loaded.concat(a.items)})})},l.more=function(){if(l.canLoadMore){var a=l.loaded.splice(0,k);a=a.map(i),l.displayed=l.displayed.concat(a);var b=l.tracker.next();l.load(b).then(function(a){l.loaded=l.loaded.concat(a.items)})}else g.error("More comments required, but the service cannot load more of them. In this case the user should not be able to trigger this request")},l.load=function(a){var d,e,g=c.defer();return d="nested"===m?"nested":"",e=Routing.generate("newscoop_gimme_comments_getcommentsforarticle_1",{number:j.articleId,language:j.language,order:d,items_per_page:k,page:a},!0),b.get(e).success(function(a){g.resolve(a),f.isLastPage(a.pagination)&&(l.canLoadMore=!1)}).error(function(){l.tracker.remove(a)}),g.promise},l.matchMaker=function(a){return function(b){return parseInt(b.id)===parseInt(a)}},l.changeSelectedStatus=function(a,b,c){var d=null,e=l.displayed,f=0,g=e.length,h=[];if(!b&&"undefined"!=typeof c)return void e.forEach(function(b){b.id===c&&b.changeStatus(a)});if(!b&&"undefined"==typeof c)return void e.forEach(function(b){b.selected&&b.changeStatus(a)});if(b&&"undefined"!=typeof c)for(;g>f;){if(d){if(!(e[f].thread_level>d.thread_level))break;h.push(e[f])}else e[f].id===c&&(d=e[f],h.push(d));f++}else for(;g>f;){if(d){if(!(e[f].thread_level>d.thread_level)){d=null;continue}h.push(e[f])}else e[f].selected&&(d=e[f],h.push(d));f++}h.forEach(function(b){b.changeStatus(a)})}}]),angular.module("authoringEnvironmentApp").controller("CommentsCtrl",["$scope","comments","article","Article","modalFactory","$log",function(a,b,c,d,e,f){var g=c.articleInstance,h=["pending","approved","hidden"];a.sortings=[{text:"Nested"},{text:"Chronological"},{text:"Chronological (asc.)"}],a.sorting=a.sortings[0],a.toggle=function(b){var c=a.statuses[b];a.statuses[b]=!c,"all"===b?h.map(c?function(b){a.statuses[b]=!0}:function(b){a.statuses[b]=!1}):c?h.every(function(b){return!1===a.statuses[b]})&&(a.statuses.all=!0):a.statuses.all=!1},a.commentingSettingSrv=d.commenting.ENABLED,a.commentingSetting=a.commentingSettingSrv,a.commentingOptDirty=!1,a.isChangingCommenting=!1,a.commenting=d.commenting,a.commentingOpts=[{value:d.commenting.ENABLED,text:"Enabled"},{value:d.commenting.DISABLED,text:"Disabled"},{value:d.commenting.LOCKED,text:"Locked"}],this.initCommenting=function(){a.commentingSettingSrv=g.comments_locked?d.commenting.LOCKED:g.comments_enabled?d.commenting.ENABLED:d.commenting.DISABLED,a.commentingSetting=a.commentingSettingSrv},this.initCommenting(),a.statuses={all:!0,pending:!1,approved:!1,hidden:!1},a.selected=function(b){return a.statuses.all?!0:a.statuses[b.status]?!0:!1},a.isSending=!1,a.comments=b,a.create={},b.init(),a.add=function(c){a.isSending=!0,b.add(c).then(function(){a.adding=!1,a.isSending=!1,a.create={}},function(){a.isSending=!1})},a.cancel=function(){a.adding=!1,a.create={}},a.globalShowStatus="collapsed",a.$watch("globalShowStatus",function(){b.displayed.map(function(b){b.showStatus=a.globalShowStatus})}),a.updateCommentingDirtyFlag=function(){a.commentingOptDirty=a.commentingSetting!==a.commentingSettingSrv},a.changeCommentingSetting=function(){var b=a.commentingSetting,c=a.commentingSettingSrv;a.isChangingCommenting=!0,g.changeCommentingSetting(b).then(function(){a.commentingSettingSrv=b},function(){a.commentingSetting=c}).finally(function(){a.updateCommentingDirtyFlag(),a.isChangingCommenting=!1})},a.toggleShowStatus=function(){a.globalShowStatus="expanded"===a.globalShowStatus?"collapsed":"expanded"},a.$watch("sorting",function(){f.debug("sorting changed"),b.canLoadMore&&b.init("Nested"===a.sorting.text?{sorting:"nested"}:{sorting:"chronological"})}),a.countSelected=function(){var a=0;return b.displayed.forEach(function(b){b.selected&&a++}),a},a.confirmHideComments=function(a){var c,d,f,g="undefined"!=typeof a;g?(d="Do you really want to hide this comment?",f="Comment's content will not be visible to users."):(d="Do you really want to hide selected comments?",f="Comments' contents will not be visible to users."),c=e.confirmLight(d,f),c.result.then(function(){g?b.changeSelectedStatus("hidden",!1,a):b.changeSelectedStatus("hidden",!1)},function(){})},a.confirmDeleteComments=function(a){var c,d,f,g="undefined"!=typeof a;g?(d="Are you sure you want to mark this comment as deleted?",f="Deleted comments are not visible to users."):(d="Are you sure you want to mark selected comments as deleted?",f="Deleted comments are not visible to users."),c=e.confirmHeavy(d,f),c.result.then(function(){g?b.changeSelectedStatus("deleted",!0,a):b.changeSelectedStatus("deleted",!0)},function(){})}}]),angular.module("authoringEnvironmentApp").directive("comment",function(){return{templateUrl:"views/comment.html",restrict:"E",scope:{model:"=",allowreplying:"=",onHide:"&confirmHideComments",onDelete:"&confirmDeleteComments"},link:function(){}}}),angular.module("authoringEnvironmentApp").service("transform",function(){function a(a){return $.param(a)}this.formEncode=function(b,c){var d=c();return d["Content-Type"]="application/x-www-form-urlencoded",a(b)},this.formEncodeData=a}),angular.module("authoringEnvironmentApp").service("circularBufferFactory",function(){this.create=function(a){if(!("size"in a))throw new Error("a circular buffer needs an integer size option");return{opt:a,arr:[],used:function(){return this.arr.length},push:function(a){this.used()>=this.opt.size&&this.arr.shift(),this.arr.push(a)},dump:function(){return angular.copy(this.arr)},prev:function(a){var b=a||1,c=parseInt(b,10);if(1>c)throw new Error(c+" is not a valid value for the `prev` function, check the tests or the code");var d=this.arr.length-c,e=d>=0?d:0;return this.arr[e]}}}}),angular.module("authoringEnvironmentApp").filter("sortComments",["$log",function(a){function b(a){return new Date(a.created)}return function(c,d){var e,f;switch(d){case"Nested":return _.sortBy(c,"nestedPosition");case"Chronological":return e=_.sortBy(c,b),e.reverse(),e;case"Chronological (asc.)":return _.sortBy(c,b);default:throw f="unknown sorting: "+d,a.error(f),new Error(f)}}}]),angular.module("authoringEnvironmentApp").service("nestedSort",["$log",function(a){var b=this;this.sortByCreated=function(a){function b(a){return new Date(a.created)}return _.sortBy(a,b)},this.sort=function(c){function d(a){var c=b.sortByCreated(a.childs);c.forEach(function(a){a.nestedPosition=i,i++,d(a)})}for(var e=[],f=0,g=function(a){return a.thread_level===f},h=c.filter(g);h.length>0;)e.push(h),f++,h=c.filter(g);b.map={root:{childs:[]}},e.forEach(function(c){c.forEach(function(c){var d=angular.copy(c);d.childs=[],0===d.thread_level&&(d.parent="root"),b.map[d.id]=d,"parent"in d?d.parent in b.map?b.map[d.parent].childs.push(d):a.debug("error, comment",d,"has parent",d.parent,"which is not available to us"):a.debug("error, comment",d,"is not first level but it has no parent")})});var i=0;d(b.map.root),c.forEach(function(c){c.id in b.map?c.nestedPosition=b.map[c.id].nestedPosition:a.error("comment",c,"is not in the nested sorting map",b.map)})}}]),angular.module("authoringEnvironmentApp").service("currentTime",function(){var a=!1;this.set=function(b){a=b},this.unset=function(){a=!1},this.get=function(){return a===!1?new Date:a},this.isToday=function(a){var b=this.get();return a.toDateString()===b.toDateString()}}),angular.module("authoringEnvironmentApp").filter("niceDate",["currentTime","$filter",function(a,b){return function(c){var d;return d="string"==typeof c?new Date(Date.parse(c)):c,a.isToday(d)?"today "+b("date")(d,"H:mm"):b("date")(d,"dd.MM.yyyy")}}]),angular.module("authoringEnvironmentApp").filter("stripHTML",[function(){var a=new RegExp(String.fromCharCode(160),"g");return function(b){return $("<div>").html(b).text().replace(a," ")}}]),angular.module("authoringEnvironmentApp").directive("dropImages",function(){return{restrict:"A",scope:{handler:"&"},link:function(a,b){b=$(b[0]),b.on("drop",function(b){var c,d,e,f=[],g=new RegExp(/^image\/.*/i);for(b.preventDefault(),b.stopPropagation(),e=b.originalEvent.dataTransfer.files,c=0;c<e.length;c++)d=e.item(c),g.test(d.type)&&f.push(d);a.handler({files:f})}),b.on("dragover",function(a){a.preventDefault(),a.stopPropagation(),a.originalEvent.dataTransfer.dropEffect="copy"})}}}),angular.module("authoringEnvironmentApp").directive("fileUpload",function(){return{restrict:"A",scope:{handler:"&"},link:function(a,b){var c=$("<input>").attr({type:"file",accept:"image/*",multiple:"multiple","class":"hidden-input",style:"display:none"});c.on("click",function(a){a.stopPropagation()}),c.on("change",function(){var b=c.get(0).files;a.handler({files:b})}),b.append(c),b.on("click",function(){c.click()})}}}),angular.module("authoringEnvironmentApp").factory("Author",["$http","$q","$timeout","dateFactory","pageTracker",function(a,b,c,d,e){var f=250,g=null,h=0,i=function(){};return i.createFromApiData=function(a){var b=new i;return b.id=a.author.id,b.firstName=a.author.firstName,b.lastName=a.author.lastName,b.text=a.author.firstName+" "+a.author.lastName,b.articleRole=a.type?{id:a.type.id,name:a.type.type}:null,b.avatarUrl=a.author.image?decodeURIComponent(a.author.image):"/images/authors-default-avatar.png",b.sortOrder=a.order,b},i.getAllByArticle=function(c,d){var e,f=[],g=b.defer();return f.$promise=g.promise,e=Routing.generate("newscoop_gimme_authors_getarticleauthors",{number:c,language:d,items_per_page:99999},!0),a.get(e).success(function(a){a.items.forEach(function(a){a=i.createFromApiData(a),f.push(a)}),g.resolve()}).error(function(a){g.reject(a)}),f},i.getRoleList=function(){var c,d=b.defer(),e=[];return e.$promise=d.promise,c=Routing.generate("newscoop_gimme_authors_getauthorstypes",{items_per_page:99999},!0),a.get(c).success(function(a){a.items.forEach(function(a){a.name=a.type,delete a.type,e.push(a)}),d.resolve()}).error(function(a){d.reject(a)}),e},i.liveSearchQuery=function(b,j){var k,l=b.page>1,m=d.makeInstance();if(!j){if(!l)return h=m,void c(function(){i.liveSearchQuery(b,!0)},f);if(angular.equals(b.context,g))return;g=b.context}!l&&f>m-h||(k=Routing.generate("newscoop_gimme_authors_searchauthors",{items_per_page:10,page:b.page,query:b.term},!0),a.get(k).success(function(a){var c,d=[];a.items.forEach(function(a){c=i.createFromApiData({author:a}),d.push(c)}),b.callback({results:d,more:!e.isLastPage(a.pagination),context:a.pagination})}))},i.setOrderOnArticle=function(b,c,d){var e=[];d.forEach(function(a){e.push(a.id+"-"+a.articleRole.id)}),e=e.join(),a.post(Routing.generate("newscoop_gimme_authors_setarticleauthorsorder",{number:b,language:c},!0),{order:e})},i.prototype.addToArticle=function(c,d,e){var f,g,h=this,i=b.defer();return f=["<",Routing.generate("newscoop_gimme_authors_getauthorbyid",{id:h.id},!1),'; rel="author">,',"<",Routing.generate("newscoop_gimme_authors_getauthortype",{id:e},!1),'; rel="author-type">'].join(""),g=Routing.generate("newscoop_gimme_articles_linkarticle",{number:c,language:d},!0),a({url:g,method:"LINK",headers:{link:f}}).success(function(){h.articleRole=h.articleRole||{},h.articleRole.id=e,i.resolve()}).error(function(a){i.reject(a)}),i.promise},i.prototype.removeFromArticle=function(c,d,e){var f,g,h=this,i=b.defer();return f=["<",Routing.generate("newscoop_gimme_authors_getauthorbyid",{id:h.id},!1),'; rel="author">,',"<",Routing.generate("newscoop_gimme_authors_getauthortype",{id:e},!1),'; rel="author-type">'].join(""),g=Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:c,language:d},!0),a({url:g,method:"UNLINK",headers:{link:f}}).success(function(){i.resolve()}).error(function(a){i.reject(a)}),i.promise},i.prototype.updateRole=function(b){var c,d,e,f;return d=["<",Routing.generate("newscoop_gimme_authors_getauthortype",{id:b.oldRoleId},!1),'; rel="old-author-type">,',"<",Routing.generate("newscoop_gimme_authors_getauthortype",{id:b.newRoleId},!1),'; rel="new-author-type">'].join(""),f=Routing.generate("newscoop_gimme_authors_updatearticleauthor",{number:b.number,language:b.language,authorId:this.id},!0),c={headers:{link:d}},e=a.post(f,{},c)},i}]),angular.module("authoringEnvironmentApp").factory("getFileReader",function(){return{get:function(){return new FileReader}}}),angular.module("authoringEnvironmentApp").factory("formDataFactory",function(){return{makeInstance:function(){return new FormData}}}),angular.module("authoringEnvironmentApp").factory("imageFactory",function(){return{makeInstance:function(){return new Image}}}),angular.module("authoringEnvironmentApp").factory("dateFactory",function(){return{makeInstance:function(){return new Date}}}),angular.module("authoringEnvironmentApp").controller("PaneRelatedArticlesCtrl",["$q","article","modalFactory","Publication","Issue","Section",function(a,b,c,d,e,f){var g=this,h=b.articleInstance;g.availablePublications=d.getAll(),g.availableIssues=e.getAll(),g.availableSections=f.getAll(),g.assignedRelatedArticles=h.getRelatedArticles(),g.loadAvailableFilters=function(){var a=g.buildFilters();g.issueFilter||(g.availableIssues=e.getAll(a)),g.availableSections=f.getAll(a)},g.previewRelatedArticle=function(a){a.loadContentFields().then(function(b){a.contentFields=b}),a.loadFirstImage().then(function(b){var c="http://newscoop.aes.sourcefabric.net/images/";a.firstImage=b?c+b:null}),g.relatedArticlePreview=a,g.showArticlePreview=!g.showArticlePreview},g.orderChange=function(){console.log("order changed!")},g.loadSearchResults=function(){var a,b,c={},d={};g.availableRelatedArticles=[],g.relatedArticleListRetrieved=!1,g.assignedRelatedArticles.forEach(function(a){c[a.articleId]=!0}),b=g.query?g.query.toLowerCase():"",d=g.buildFilters(),h.searchArticles(b,d).then(function(b){g.relatedArticleListRetrieved=!0,console.log(c),a=_.filter(b,function(a){return!(a.articleId in c)}),g.availableRelatedArticles=a})},g.buildFilters=function(){var a={};return g.publicationFilter&&(a.publication=g.publicationFilter.id),g.issueFilter&&(a.issue=g.issueFilter.number),g.sectionFilter&&(a.section=g.sectionFilter.number),a},g.assignToArticle=function(a){var b=this;b.assigningRelatedArticles=!0,h.addRelatedArticle(a).then(function(){b.assignedRelatedArticles.push(a),b.searchArticles(b.query)}).finally(function(){b.assigningRelatedArticles=!1})},g.confirmUnassignRelatedArticle=function(b){var d,e,f;e="Do you really want to unassign this relatedArticle from the article?",f="Should you change your mind, the relatedArticle can always be re-assigned again.",d=c.confirmLight(e,f),d.result.then(function(){return h.removeRelatedArticle(b)},a.reject).then(function(){_.remove(g.assignedRelatedArticles,{articleId:b.articleId})})}}]),angular.module("authoringEnvironmentApp").factory("Publication",["$http","$q",function(a,b){var c=function(){};return c.createFromApiData=function(a){var b=new c;return b.name=a.name,b.id=a.id,b},c.getAll=function(){var d,e=[],f=b.defer();return e.$promise=f.promise,d=Routing.generate("newscoop_gimme_publications_getpublications",{},!0),a.get(d).success(function(a){a.items.forEach(function(a){a=c.createFromApiData(a),e.push(a)}),f.resolve()}).error(function(a){f.reject(a)}),e},c}]),angular.module("authoringEnvironmentApp").factory("Issue",["$http","$q",function(a,b){var c=function(){};return c.createFromApiData=function(a){var b=new c;return b.number=a.number,b.title=a.title,b},c.getAll=function(d){var e,f=[],g=b.defer();return f.$promise=g.promise,e=Routing.generate("newscoop_gimme_issues_getissues",d,!0),a.get(e).success(function(a){a.items.forEach(function(a){a=c.createFromApiData(a),f.push(a)}),g.resolve()}).error(function(a){g.reject(a)}),f},c}]),angular.module("authoringEnvironmentApp").factory("Section",["$http","$q",function(a,b){var c=function(){};return c.createFromApiData=function(a){var b=new c;return b.number=a.number,b.title=a.title,b},c.getAll=function(d){var e,f=[],g=b.defer();return f.$promise=g.promise,e=Routing.generate("newscoop_gimme_sections_getsections",d,!0),a.get(e).success(function(a){a.items.forEach(function(a){a=c.createFromApiData(a),f.push(a)}),g.resolve()}).error(function(a){g.reject(a)}),f},c}]);