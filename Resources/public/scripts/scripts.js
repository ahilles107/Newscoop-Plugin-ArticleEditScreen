"use strict";angular.module("authoringEnvironmentApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAlohaEditor","mgcrea.ngStrap.button","mgcrea.ngStrap.helpers.dimensions","mgcrea.ngStrap.tooltip","mgcrea.ngStrap.popover","template/modal/backdrop.html","template/modal/window.html","ui.bootstrap.dropdownToggle","ui.bootstrap.modal","ui.select2","angularFileUpload","angularOauth"]).config(["$routeProvider","$httpProvider","$buttonProvider",function(a,b,c){a.when("/:language/:article",{templateUrl:"views/main.html"}).when("/:callback*",{templateUrl:"views/oAuthCallback.html",controller:"CallbackCtrl"}).otherwise({redirectTo:"/de/533522"}),b.interceptors.push("authInterceptor"),c.defaults.toggleEvent="change"}]).run(["$document",function(a){a.on("dragover drop",function(a){a.preventDefault()})}]);var mutate_event_stack=[{name:"width",handler:function(a){var b={el:a};return $(b.el).data("mutate-width")||$(b.el).data("mutate-width",$(b.el).width()),$(b.el).data("mutate-width")&&$(b.el).width()!==$(b.el).data("mutate-width")?($(b.el).data("mutate-width",$(b.el).width()),!0):!1}},{name:"height",handler:function(a){var b=a;return $(b).data("mutate-height")||$(b).data("mutate-height",$(b).height()),$(b).data("mutate-height")&&$(b).height()!==$(b).data("mutate-height")?($(b).data("mutate-height",$(b).height()),!0):void 0}},{name:"top",handler:function(a){return $(a).data("mutate-top")||$(a).data("mutate-top",$(a).css("top")),$(a).data("mutate-top")&&$(a).css("top")!==$(a).data("mutate-top")?($(a).data("mutate-top",$(a).css("top")),!0):void 0}},{name:"bottom",handler:function(a){return $(a).data("mutate-bottom")||$(a).data("mutate-bottom",$(a).css("bottom")),$(a).data("mutate-bottom")&&$(a).css("bottom")!==$(a).data("mutate-bottom")?($(a).data("mutate-bottom",$(a).css("bottom")),!0):void 0}},{name:"right",handler:function(a){return $(a).data("mutate-right")||$(a).data("mutate-right",$(a).css("right")),$(a).data("mutate-right")&&$(a).css("right")!==$(a).data("mutate-right")?($(a).data("mutate-right",$(a).css("right")),!0):void 0}},{name:"left",handler:function(a){return $(a).data("mutate-left")||$(a).data("mutate-left",$(a).css("left")),$(a).data("mutate-left")&&$(a).css("left")!==$(a).data("mutate-left")?($(a).data("mutate-left",$(a).css("left")),!0):void 0}},{name:"hide",handler:function(a){return $(a).is(":hidden")?!0:void 0}},{name:"show",handler:function(a){return $(a).is(":visible")?!0:void 0}},{name:"scrollHeight",handler:function(a){return $(a).data("prev-scrollHeight")||$(a).data("prev-scrollHeight",$(a)[0].scrollHeight),$(a).data("prev-scrollHeight")&&$(a)[0].scrollHeight!==$(a).data("prev-scrollHeight")?($(a).data("prev-scrollHeight",$(a)[0].scrollHeight),!0):void 0}},{name:"scrollWidth",handler:function(a){return $(a).data("prev-scrollWidth")||$(a).data("prev-scrollWidth",$(a)[0].scrollWidth),$(a).data("prev-scrollWidth")&&$(a)[0].scrollWidth!==$(a).data("prev-scrollWidth")?($(a).data("prev-scrollWidth",$(a)[0].scrollWidth),!0):void 0}},{name:"scrollTop",handler:function(a){return $(a).data("prev-scrollTop")||$(a).data("prev-scrollTop",$(a)[0].scrollTop()),$(a).data("prev-scrollTop")&&$(a)[0].scrollTop()!==$(a).data("prev-scrollTop")?($(a).data("prev-scrollTop",$(a)[0].scrollTop()),!0):void 0}},{name:"scrollLeft",handler:function(a){return $(a).data("prev-scrollLeft")||$(a).data("prev-scrollLeft",$(a)[0].scrollLeft()),$(a).data("prev-scrollLeft")&&$(a)[0].scrollLeft()!==$(a).data("prev-scrollLeft")?($(a).data("prev-scrollLeft",$(a)[0].scrollLeft()),!0):void 0}}];!function(a){function b(){var d=c;"undefined"!==d.event_stack&&d.event_stack.length&&a.each(d.event_stack,function(a,b){c.add_event(b)}),d.event_stack=[],a.each(d.stack,function(b,c){a(c.selector).each(function(a,b){d.events[c.event_name](b)===!0?c.callback&&c.callback(b,c):c.false_callback&&c.false_callback(b,c)})}),setTimeout(b,c.speed)}var c={speed:1,event_stack:mutate_event_stack,stack:[],events:{},add_event:function(a){c.events[a.name]=a.handler},add:function(a,b,d,e){c.stack[c.stack.length]={event_name:a,selector:b,callback:d,false_callback:e}}};b(),a.fn.extend({mutate:function(){var b=!1,d=arguments[1],e=this,f=arguments[2]?arguments[2]:function(){};return"extend"===arguments[0].toLowerCase()?(c.add_event(d),this):(a.each(a.trim(arguments[0]).split(" "),function(a,g){b=g,c.add(b,e,d,f)}),this)}})}(jQuery);var ModalCtrlConstructor=function(a,b,c,d){a.title=c,a.text=d,a.ok=function(){b.close(!0)},a.cancel=function(){b.dismiss(!1)}};ModalCtrlConstructor.$inject=["$scope","$modalInstance","title","text"],angular.module("authoringEnvironmentApp").factory("modalFactory",["$modal",function(a){return{_createConfirmInstance:function(b,c,d){var e=d?"views/modal-confirm-heavy.html":"views/modal-confirm-light.html";return a.open({templateUrl:e,controller:ModalCtrlConstructor,backdrop:"static",keyboard:!1,resolve:{title:function(){return b},text:function(){return c}}})},confirmLight:function(a,b){return this._createConfirmInstance(a,b,!1)},confirmHeavy:function(a,b){return this._createConfirmInstance(a,b,!0)}}}]),function(a){function b(){a.module("authoringEnvironmentApp").config(["$provide",function(a){a.decorator("$httpBackend",angular.mock.e2e.$httpBackendDecorator)}]).run(["$httpBackend",function(a){a.whenGET(/views\/.*/).passThrough();var b={language:"en",fields:{highlight:"0",lede:"<p>BRUSSELS - Italian and Greek candidates nominated for President of the European Council in secret ballot.</p>",body:'<!-- Snippet 12 --><p>It plu plia olda nula, lo ekoo interjekcio aŭ. Iom inkluzive dividostreko sh, subtraho praantaŭhieraŭ bio fo. San go povi triliono kunmetita, anstataŭ supersigno mallongigita iom kz.</p> <!** Image 101 align="left" alt="Daniel Göpfert" sub="Daniel Göpfert" width="90" height="120" > <!-- Snippet 8 align="left" --> <p>Tiel ofon iometo dio at, vir alikvante montrovorto prirespondi re, sis tiam reen frazparto jh. Pov mi pobo infra alternativo, nenio geedzo alimaniere sor um.</p>\r\n<p>Tek in dekoj komplika kernovorto, dekuma disskribado je end. Vendo posttagmezo um esk, ki nedifina personalo, unt. Sen ki tiele aligi resti. Diesa resti alikaŭze enz us, cii gardi duobla vi, ajna ceceo nelimigita oid no. Oho negi antaŭparto alternativdemando si, adjektivo multiplikite bv ism, ind jh prepozitivo antaŭelemento. He ano orda nekutima, mil fi alia patro solstariva.</p>\r\n<p>Tia zepto rolvorteto du. Ar duo frota sepen dikfingro. Des vavo senforte ed. Mano halt\' onklo sur nv, aliu help transigi ian o, amen multe kompreneble ena er. Nul tiuj fora nano jo.</p>\r\n<p>Kuo op negi posta. Kazablanko subpropozicio mal ne. End ad ekoo sori, in sor otek finitivo okulvitroj, egalo latina iom ge. Pra ho filo troa, mf esk apud aliel geedzo, fin duobla fratineto sekstiliono as. Lo devus video kelka mia, sia ed mili fini. Sin nula usono kunmetaĵo ik, cii op tiea post gibi, sob brosi substantiva is.</p>\r\n<p>Jam unun participo sh. Nea mo ioma identiga, mi edzo ekde frikativo dio. Cii milo tohuo iufoje tc, mo tet krom prezoinda tempopunkto, hago dank\' esperantigita ok kie. Iufoje helpverbo ko mis, poa ci dura eĥo komparado. Pli persa deziri ju, falsa ekesti definitive jes aj. Tro iu hodiaŭa infinitivo, e eca malpli kernovorto.</p>\r\n<p>Ke ato armo postpriskribo. Mem al triliono frikativo miriametro, spite vortfarado fo iel. Oj iom ruli okej vatto. Jota tiama tagnokto nu ili. Nei kian spite ki, nenia reciprokeco ajn vo. Hot jena respondeci uj.</p>\r\n<div class="generic-embed"> </div>\r\n<p>Fri go longa senobjekta postmorgaŭ, deci praantaŭhieraŭ ina el, nea ve dato hekto. Ci speco anstataŭi sat, ses mono literaturo ko. Per vi dume falsa fundamenta, amen siatempe kuo id. Pri vi eĥo fontoj frazparto. Kab\'o difina laŭlonge ne aĥ.</p>',printsection:"Sports",printstory:null,iPad_prominent:"0"},authors:[{name:"Test Persona",link:"http://tw-merge.lab.sourcefabric.org/content-api/author/9"},{name:"Frank N. Stein",link:"http://tw-merge.lab.sourcefabric.org/content-api/author/13"}],number:"64",title:"European Council candidates set to be named",updated:"2013-12-17T14:31:14+0000",comments:"http://tw-merge.lab.sourcefabric.org/content-api/articles/64/en/comments",type:"news",published:"2013-11-14T10:49:17+0000",topics:[{id:10,title:"Cruise Night"},{id:10,title:"Crucero nocturno"},{id:11,title:"People In The News"},{id:11,title:"La gente en las noticias"},{id:29,title:"Milan Shows"},{id:29,title:"Muestra Milán"}],slideshow:[{id:5,title:"Berlin Zoo",itemsLink:"http://tw-merge.lab.sourcefabric.org/content-api/slideshows/5"}],renditions:[{caption:"articlebig",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/600x400%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"sectionthumb",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/250x167%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"square",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/150x150%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"thumb",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/150x100%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"topfront",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/500x333%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"artikel",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/555x370%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"artikelnew",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/639x426%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"blogsidebar",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x150%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierbild",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/980x306%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierbildnew",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/990x330%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierteaser",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x131%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"naviteaser",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/120x53%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"rubrikenseite",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x200%2Ffit%2Fimages%257Ccms-image-000000099.jpg"}],webcode:"cup6z",reads:"5"},d={name:"news",fields:[{name:"body",type:"body",fieldWeight:3,isHidden:0,commentsEnabled:0,fieldTypeParam:"editor_size=750",isContentField:1},{name:"highlight",type:"switch",fieldWeight:1,isHidden:0,commentsEnabled:0,isContentField:0},{name:"iPad_prominent",type:"switch",fieldWeight:6,isHidden:0,commentsEnabled:0,isContentField:0},{name:"lede",type:"longtext",fieldWeight:2,isHidden:0,commentsEnabled:0,fieldTypeParam:"editor_size=250",isContentField:0},{name:"printsection",length:0,type:"text",fieldWeight:4,isHidden:0,commentsEnabled:0,isContentField:0},{name:"printstory",length:0,type:"text",fieldWeight:5,isHidden:0,commentsEnabled:0,isContentField:0}]},e=new RegExp(c+"/articles.*");a.whenGET(e).respond(b),a.when("PATCH",e).respond({});var e=new RegExp(c+"/articleTypes.*");a.whenGET(e).respond(d);var f=function(a,b){return{id:a,name:"My "+a+" "+b,template:b,content:{code:'<div class="embed'+a+'">This is so cool, '+b+"</div>"}}},g={1:f(1,"Generic"),2:f(2,"Generic"),3:f(3,"Generic"),4:f(4,"Generic")},h={5:f(5,"Tweet"),6:f(6,"Tweet"),7:f(7,"Tweet"),8:f(8,"Tweet")},i={1:f(1,"Generic"),2:f(2,"Generic"),3:f(3,"Generic"),4:f(4,"Generic"),5:f(5,"Tweet"),6:f(6,"Tweet"),7:f(7,"Tweet"),8:f(8,"Tweet")},e=new RegExp("/content-api/images[?]page=[0-9]+");a.whenGET(e).respond({items:[{id:1,basename:"Carla-bruni-sarkozy.jpg"},{id:2,basename:"French_election__N_2200069b.jpg"},{id:3,basename:"Strong-turnout-for-French-election.jpg"},{id:4,basename:"sarcozy-presidente-de-francia.jpg"},{id:5,basename:"sarkyDM1910_468x505.jpg"},{id:6,basename:"images-cms-image-003318021.jpg"},{id:7,basename:"images-cms-image-003935520.jpg"},{id:8,basename:"images-cms-image-004021392.jpg"},{id:9,basename:"images-cms-image-004059514.jpg"},{id:10,basename:"images-cms-image-004059556.jpg"}],pagination:{itemsPerPage:10,currentPage:1,itemsCount:149735,nextPageLink:"https://tw-merge.lab.sourcefabric.org/content-api/images?page=2&items_per_page=10"}});var e=new RegExp("/content-api/images/[0-9]+");a.whenGET(e).respond({id:1,location:"local",basename:"French_election__N_2200069b.jpg",thumbnailPath:"cms-thumb-000000001.jpg",url:"",description:"image description",width:"150",height:"210",photographer:"",photographerUrl:"",place:""});var e=new RegExp("/content-api/comments/.*");a.whenGET(e).respond({items:[{id:26822,author:"Inihe Ublinschä",subject:"subject",message:"message",thread_level:0,thread_order:1,status:"approved",created:"2013-11-28T18:10:09+0000",updated:"2013-11-28T18:10:09+0000",recommended:0},{id:26828,author:"More Timat",subject:"ungeeignet..",message:"Mir fiel derselbe Satz auf: «Das Anliegen, die Spekulation mit Grundbesitz einzudämmen ... , sei zwar verständlich, doch die Initiative sei dazu ungeeignet» Ja was gibts denn für geeignete Mittel möchte ich gerne wissen. Enteignung? Verstaatlichung des gesamten Bodens und Verpachtung im Baurecht für 99 Jahre? Vorschläge willkommen!",thread_level:0,thread_order:2,status:"approved",created:"2013-11-28T21:30:43+0000",updated:"2013-11-28T21:30:43+0000",recommended:1}]});var j=g,k=(f(1,"Generic"),{id:1,name:"Generic",template:"%code%"});a.whenGET(/\/content-api\/article\/64\/1\/snippets\/[\d]/).respond(function(a,b){return console.log(b.split("/")),[200,f(b.split("/")[4],"generic")]}),a.whenGET(/\/content-api\/article\/64\/1\/snippets/).respond(j),a.whenGET(/\/content-api\/snippets\/generic\/[\d]/).respond(function(a,b){return[200,f(b.split("/")[4],"generic")]}),a.whenGET(/\/content-api\/snippets\/tweet\/[\d]/).respond(function(a,b){return[200,f(b.split("/")[4],"tweet")]}),a.whenGET(/\/content-api\/snippets\/generic/).respond(g),a.whenGET(/\/content-api\/snippets\/tweet/).respond(h),a.whenGET(/\/content-api\/snippets/).respond(i),a.whenGET(/\/content-api\/snippetTemplate\/[\d]/).respond(k)}])}if(document.URL.match(/nobackend$/)){console.log("=== STUBBED BACKEND ===");var c="http://newscoop.aes.sourcefabric.net/content-api";b()}}(angular),angular.module("authoringEnvironmentApp").filter("availableRoles",[function(){return function(a,b,c){var d=[];return b?(a.forEach(function(a){var e=!1;c.forEach(function(c){return c!==b?c.id===b.id&&c.articleRole.id===a.id?void(e=!0):void 0:void 0}),e||d.push(a)}),d):a}}]),angular.module("authoringEnvironmentApp").controller("MainCtrl",["$scope","$window","mode","UserAuth",function(a,b,c,d){if(void 0===b.sessionStorage.token){a.auth=!1;var e=d.getToken(CSClientId);e.then(function(c){b.sessionStorage.token=c.access_token,a.auth=!0})}else a.auth=!0;a.$on("$viewContentLoaded",function(){jQuery("#cs-specific").prependTo(".main-background-container")}),a.mode=c}]),angular.module("authoringEnvironmentApp").factory("UserAuth",["$http","$q","$window",function(a,b){var c=this,d=function(){};return c.createFromApiData=function(a){var b=Object.create(d.prototype);return["access_token","expires_in","token_type","refresh_token"].forEach(function(c){b[c]=a[c]}),b},d.getToken=function(d){var e,f=b.defer();return a.get(Routing.generate("newscoop_gimme_users_getuseraccesstoken",{clientId:d},!0)).success(function(a){e=c.createFromApiData(a),f.resolve(e)}).error(function(a){f.reject(a)}),f.promise},d}]),angular.module("authoringEnvironmentApp").config(["TokenProvider",function(a){a.extendConfig({clientId:"14_7lu4iulnlr0gg0gwcwowkkcko48000k84sokgwcg44s4oks0g",redirectUri:"http://localhost:9000/#/callback",authorizationEndpoint:Routing.generate("fos_oauth_server_authorize",{},!0),verifyFunc:""})}]).controller("MainWithTokenCtrl",["$scope","$window","mode","Token",function(a,b,c,d){if(void 0===d.get()){a.auth=!1;var e=a.askApproval?{approval_prompt:"force"}:{};d.getTokenByPopup(e).then(function(c){a.accessToken=c.access_token,a.expiresIn=c.expires_in,d.set(c.access_token),b.sessionStorage.token=d.get(),a.auth=!0},function(){alert("Failed to get token from popup.")})}else b.sessionStorage.token=d.get(),a.auth=!0;a.$on("$viewContentLoaded",function(){jQuery("#cs-specific").prependTo(".main-background-container")}),a.mode=c}]),angular.module("authoringEnvironmentApp").controller("SfPanesCtrl",["$scope","$filter","panes",function(a,b,c){a.panes=c.query(),a.tabpaneIsOpen=function(c){return b("filter")(a.panes,{position:c,selected:!0,visible:!0}).length>0},a.flipVisible=function(a){c.visible(a),a.active=!0}}]),angular.module("authoringEnvironmentApp").controller("PaneAuthorsCtrl",["$scope","article","Author","modalFactory",function(a,b,c,d){var e=this;e.setRoleChangeWatch=function(b){var c=a.$watch(function(){return b.articleRole},function(a,c){a!==c&&e.authorRoleChanged(a,c,b)},!0);b.stopRoleChangeWatch=c},e.authorRoleChanged=function(a,c,d){b.promise.then(function(a){d.updatingRole=!0,d.updateRole({number:a.number,language:a.language,oldRoleId:c.id,newRoleId:d.articleRole.id}).then(null,function(){d.stopRoleChangeWatch(),d.articleRole=c,e.setRoleChangeWatch(d)}).finally(function(){d.updatingRole=!1})})},a.authorRoles=c.getRoleList(),a.authors=[],a.newAuthor=null,a.newAuthorRoleId=null,a.addingNewAuthor=!1,a.showAddAuthor=!0,a.select2Options={minimumInputLength:3,query:c.liveSearchQuery},a.clearNewAuthorForm=function(){a.newAuthor=null,a.newAuthorRoleId=null},a.addAuthorToArticle=function(){var c=angular.copy(a.newAuthor),d=a.newAuthorRoleId;a.addingNewAuthor=!0,b.promise.then(function(b){c.addToArticle(b.number,b.language,d).then(function(){a.authors.push(c),e.setRoleChangeWatch(c)}).finally(function(){a.addingNewAuthor=!1})})},a.confirmRemoveAuthor=function(c){var e,f,g;f="Do you really want to remove this author?",g="Should you change your mind, the same author can always be added again.",e=d.confirmLight(f,g),e.result.then(function(){b.promise.then(function(a){return c.removeFromArticle(a.number,a.language,c.articleRole.id)}).then(function(){_.remove(a.authors,function(a){return a===c})})})},a.orderChanged=function(){b.promise.then(function(b){c.setOrderOnArticle(b.number,b.language,a.authors)})},b.promise.then(function(b){return a.authors=c.getAllByArticle(b.number,b.language),a.authors.$promise}).then(function(){a.authors.forEach(function(a){e.setRoleChangeWatch(a)})})}]),angular.module("authoringEnvironmentApp").controller("PaneTopicsCtrl",["$scope",function(a){a.topics=[{id:0,text:"Foo",selected:!1},{id:1,text:"Bar",selected:!0},{id:2,text:"Baz",selected:!1},{id:3,text:"whatever",selected:!1},{id:4,text:"lekker boeiend",selected:!1},{id:5,text:"koekje",selected:!1},{id:6,text:"cookie",selected:!1},{id:7,text:"heee",selected:!1},{id:8,text:"naja",selected:!1}],a.chosenTopics=[],a.addTopic=function(){a.topics.push({text:a.topicText,selected:!1,id:a.topics[a.topics.length-1].id+1}),a.topicText=""},a.deleteTopic=function(b){a.topics.splice(a.topics.indexOf(b),1)},a.chooseTopic=function(a){a.selected=!0},a.deleteChTopic=function(a){a.selected=!1}}]),angular.module("authoringEnvironmentApp").factory("panes",["$filter",function(a){function b(a){var b="";return angular.forEach(a,function(a,c){switch(a){case"small":b+="shrink-"+c+" ";break;case"big":b+="shrink-"+c+"-more "}}),b}var c=[{name:"Authors",id:"authors",icon:"authors",template:"views/pane-authors.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Images",id:"images",icon:"media",template:"views/pane-draggable.html",position:"left",size:"small",visible:!1,active:!1,selected:!0},{name:"Snippets",id:"snippets",icon:"embeds",template:"views/pane-embed.html",position:"left",size:"small",visible:!1,active:!1,selected:!0},{name:"Comments",id:"comments",icon:"comments",template:"views/pane-comments.html",position:"left",size:"big",visible:!1,active:!1,selected:!0}];return c.layout={right:null,left:null},c.articleClass="",{query:function(){return c},visible:function(d){a("filter")(c,{position:d.position}).forEach(function(a){a===d?d.visible=!d.visible:a.visible=!1}),c.layout=this.layout(c),c.articleClass=b(c.layout)},layout:function(a){var b={left:null,right:null};return a.forEach(function(a){a.visible&&(b[a.position]=a.size)}),b}}}]),angular.module("authoringEnvironmentApp").controller("PanesConfigCtrl",["$scope","panes",function(a,b){a.panes=b.query(),a.flipPosition=function(a){a.position="left"===a.position?"right":"left"}}]),angular.module("authoringEnvironmentApp").controller("ArticleCtrl",["$scope","article","articleType","panes","configuration","mode","platform","circularBufferFactory","$log","$routeParams",function(a,b,c,d,e,f,g,h,i,j){b.init({articleId:j.article,language:j.language}),a.mode=f,a.status="Initialising",a.history=h.create({size:5}),a.articleService=b,a.workflowStatuses=[{value:b.wfStatus.NEW,text:"New"},{value:b.wfStatus.SUBMITTED,text:"Submitted"},{value:b.wfStatus.PUBLISHED,text:"Published"},{value:b.wfStatus.PUBLISHED_W_ISS,text:"Published with issue"}],a.wfStatus=a.workflowStatuses[0],a.changingWfStatus=!1,b.promise.then(function(b){var c=_.find(a.workflowStatuses,{value:b.status});a.wfStatus=c}),a.setWorkflowStatus=function(c){a.changingWfStatus=!0,b.setWorkflowStatus(c).then(function(){var b=_.find(a.workflowStatuses,{value:c});a.wfStatus=b}).finally(function(){a.changingWfStatus=!1})},a.watchCallback=function(b,c){angular.equals(b,c)?(a.modified=!1,a.status="Just downloaded"):b&&c?(a.history.push(c),a.setModified(!0)):(c||i.debug("the old article value is",c),b||i.debug("the new article value is",b))},a.setModified=function(a){b.modified=a},a.save=function(){function c(a,b){if("snippet"===a||"image"===a)return b;if(null===b)return b;var c={snippet:"--",image:"**"},d=$("<div/>").html(b);return d.contents().filter("div."+a).replaceWith(function(){var b="<"+c[a]+" "+a[0].toUpperCase()+a.slice(1)+" "+parseInt($(this).data("id"));return $.each($(this).data(),function(a,c){"id"!==a&&(b+=" "+a+'="'+c+'"')}),b+=" "+c[a]+">"}),d.html().replace(/\&lt\;\*\*/g,"<**").replace(/\*\*\&gt\;/g,"**>").replace(/\&lt\;\-\-/g,"<--").replace(/\-\-\&gt\;/g,"-->")}for(var d in a.article.fields)a.article.fields.hasOwnProperty(d)&&(a.article.fields[d]=c("snippet",c("image",a.article.fields[d])));b.resource.save({articleId:j.article,language:j.language},a.article,function(){a.setModified(!1)},function(){a.status="Error saving"})},a.$watch("article",a.watchCallback,!0),a.$watch("articleService.modified",function(b){a.status=b?"Modified":"Saved"}),b.promise.then(function(b){function d(a){if(null===a)return a;var b="<!--";b+="\\s",b+="Snippet",b+="\\s",b+="([\\d]+)",b+="(?:",b+="\\s",b+='align="',b+='([^"]+)',b+='"',b+=")?",b+="\\s",b+="-->";var c=new RegExp(b,"ig");return a.replace(c,function(a,b,c){var d="";return void 0!==b&&(d+='<div class="snippet" data-id="'+parseInt(b)+'"',void 0!==c&&(d+=' data-align="'+c+'"'),d+="></div>"),d})}function f(a){if(null===a)return a;var b="<!";b+="\\*\\*",b+="[\\s]*",b+="Image",b+="[\\s]+",b+="([\\d]+)",b+="(",b+="(",b+="[\\s]+",b+="(align|alt|sub",b+="|width|height|ratio",b+="|\\w+)",b+="\\s*",b+="=",b+="\\s*",b+="(",b+='"[^"]*"',b+="|[^\\s]*",b+=")",b+=")*",b+=")",b+="[\\s]*",b+=">";var c=new RegExp(b,"ig");return a.replace(c,function(a,b,c){var d='<div class="image" data-id="'+b+'"',e=document.createElement("div");e.innerHTML="<div "+c+"></div>";for(var f=e.childNodes[0].attributes,g=0;g<f.length;g++)d+=" data-"+f[g].name+'="'+f[g].value+'"';return d+="></div>"})}a.article=b;for(var g in b.fields)b.fields.hasOwnProperty(g)&&(b.fields[g]=f(d(b.fields[g])));"undefined"==typeof a.type&&(a.type=c.get({type:b.type},function(){var c=e.additionalFields[b.type];c.forEach(function(b){a.type.fields.push(b)})}))}),a.panes=d.query(),a.platform=g,a.editable=function(a){var b=["date","dateline","main_image","lede","body","title"];return-1===b.indexOf(a.name)?!1:!0}}]),angular.module("authoringEnvironmentApp").factory("AlohaFormattingFactory",["$rootScope",function(a){a.$on("texteditor-selection-changed",function(){angular.forEach(b,function(a){var b=Aloha.queryCommandState(a);jQuery(".editoricon-"+a.toLowerCase()).parent().toggleClass("active",b)})});var b=[],c=["Insertorderedlist","Insertunorderedlist"];return{get:function(){return b},add:function(a){-1===c.indexOf(a)&&b.push(a)},remove:function(a){b.splice(b.indexOf(a),1)},query:function(a){return-1===c.indexOf(a)?Aloha.queryCommandState(a):!1}}}]),angular.module("authoringEnvironmentApp").directive("sfAlohaFormatGeneric",["AlohaFormattingFactory",function(a){return{template:'<button class="btn btn-default btn-sm action strong" rel="tooltip"title="{{buttonName}}"><i class="fa fa-{{alohaElement|lowercase}}"></i></button>',restrict:"A",replace:!0,scope:{alohaElement:"@alohaElement",buttonName:"@buttonName"},link:function(b,c){a.add(b.alohaElement),c.attr("disabled",Aloha.queryCommandSupported(b.alohaElement)&&Aloha.queryCommandEnabled(b.alohaElement)),c.bind("click",function(){Aloha.execCommand(b.alohaElement,!1,""),c.toggleClass("active",a.query(b.alohaElement))})}}}]),angular.module("authoringEnvironmentApp").directive("sfAlohaFormatStyle",function(){return{template:'<button class="dropdown-button">{{styleName}}</button>',restrict:"A",replace:!0,scope:{styleElement:"@styleElement",styleName:"@styleName"},link:function(a,b){b.toggleClass("disabled",Aloha.queryCommandSupported("formatBlock")&&Aloha.queryCommandEnabled("formatBlock")),b.bind("click",function(){Aloha.execCommand("formatBlock",!1,a.styleElement)})}}}),angular.module("authoringEnvironmentApp").controller("ToolbarCtrl",["$scope","$filter",function(a,b){a.stylers=[{element:"p",name:"Normal Text"},{element:"h1",name:"Heading 1"},{element:"h2",name:"Heading 2"},{element:"h3",name:"Heading 3"},{element:"h4",name:"Heading 4"},{element:"h5",name:"Heading 5"},{element:"pre",name:"Preformatted"}],a.active=b("filter")(a.stylers,{element:"p"},!0)[0].name;var c=function(){var c=Aloha.queryCommandValue("formatBlock");if(c.toString().length>0){var d=b("filter")(a.stylers,{element:c},!0);d.length>0&&(a.active=d[0].name,a.$apply())}};Aloha.ready(function(){Aloha.bind("aloha-selection-changed",function(){c()}),Aloha.bind("aloha-command-executed",function(){c()})})}]),angular.module("authoringEnvironmentApp").service("article",["$resource","$q","$http","configuration",function(a,b,c,d){var e,f,g,h,i=d.API.full,j=b.defer();return f={1:["English","en"],2:["Romanian","ro"],5:["German","de"],7:["Croatian","hr"],9:["Portuguese Portugal","pt"],10:["Serbian Cyrillic","sr"],11:["Serbian Latin","sh"],12:["French","fr"],13:["Spanish","es"],15:["Russian","ru"],16:["Chinese Simplified","zh"],17:["Arabic","ar"],18:["Swedish","sv"],19:["Korean","ko"],20:["Dutch","nl"],22:["Belarus","be"],23:["Georgian","ka"],24:["Chinese Traditional","zh_TW"],25:["Polish","pl"],26:["Greek","el"],27:["Hebrew","he"],28:["Bangla","bn"],29:["Czech","cs"],30:["Italian","it"],31:["Portuguese Brazil","pt_BR"],32:["Albanian","sq"],33:["Turkish","tr"],34:["Ukrainian","uk"],35:["English Britain","en_GB"],36:["Kurdish","ku"],37:["German Austria","de_AT"]},e=Object.freeze({ENABLED:0,DISABLED:1,LOCKED:2}),h=Object.freeze({NEW:"N",SUBMITTED:"S",PUBLISHED:"Y",PUBLISHED_W_ISS:"M"}),g=a(Routing.generate("newscoop_gimme_articles_getarticle",{},!0)+"/:articleId?language=:language",{articleId:"",language:"en"},{query:{method:"GET",isArray:!0},save:{url:Routing.generate("newscoop_gimme_articles_getarticle",{},!0)+"/:articleId/:language",method:"PATCH"}}),{commenting:e,wfStatus:h,modified:!1,resource:g,promise:j.promise,init:function(a){var b=this;g.get(a).$promise.then(function(a){b.articleId=a.number,b.language=a.language,b.init=function(){},j.resolve(a)})},changeCommentingSetting:function(a){var b,c=this;return b={comments_enabled:a===e.ENABLED?1:0,comments_locked:a===e.LOCKED?1:0},g.save({articleId:c.articleId,language:c.language},b).$promise},setWorkflowStatus:function(a){var b,d;return d=[i,"articles",this.articleId,this.language,a].join("/"),b=c({method:"PATCH",url:d})}}}]),angular.module("authoringEnvironmentApp").service("articleType",["$resource",function(a){return a(Routing.generate("newscoop_gimme_articletypes_getarticletypes",{},!0)+"/:type",{},{query:{method:"GET",params:{type:""},isArray:!0}})}]),angular.module("authoringEnvironmentApp").directive("sfDroppable",["$compile","Dragdata",function(a,b){var c="p",d="drag-drop-placeholder",e="."+d;return{restrict:"A",link:function(f,g){$(g).on("dragover",c,function(a){var b=$(a.target);b.next().is(e)||b.after($("<div>").addClass(d))}).on("dragleave",c,function(a){$(a.target).next().is(e)&&$(e).remove()}).on("drop",c,function(c){c.preventDefault(),c.stopPropagation();var d=$(c.target),g=b.getDropped(c.originalEvent.dataTransfer.getData("Text"));d.next().is(e)&&$(e).remove(),d.after(a(g)(f))})}}}]),angular.module("authoringEnvironmentApp").directive("sfDraggable",["Dragdata","$log",function(a,b){return{restrict:"A",link:function(c,d){var e=a.checkDraggable(d);e&&b.debug(e),d.attr("draggable",!0),d.on("dragstart",function(b){var c=a.getData(d);b.originalEvent.dataTransfer.setData("Text",c)})}}}]),angular.module("authoringEnvironmentApp").directive("dragSort",[function(){var a,b=-1,c=null,d=-1,e=function(e){e.attr("draggable",!0),e.on("dragstart",function(b){var c;a.children().each(function(a,b){$(b).attr("data-sort-index",a)}),c={sortIndex:parseInt(e.attr("data-sort-index"),10)},d=c.sortIndex,b.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(c)),b.originalEvent.dataTransfer.effectAllowed="move",e.addClass("dragged")}),e.on("dragend",function(){e.removeClass("dragged"),c&&c.remove(),a.children().each(function(a,b){$(b).removeAttr("data-sort-index")}),b=-1,d=-1}),e.on("dragenter",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),e.on("dragover",function(f){var g,h,i,j,k=parseInt(e.attr("data-sort-index"),10);if(f.originalEvent.preventDefault(),f.originalEvent.stopPropagation(),f.originalEvent.dataTransfer.dropEffect="move",i=void 0===f.originalEvent.offsetY?f.originalEvent.pageY-e.offset().top:f.originalEvent.offsetY,g=e.outerHeight(),h=g/2>i?k:k+1,h!==b){if(b=h,c&&c.remove(),b===d||b===d+1)return;c=$('<div class="new-item-slot"></div>'),j=a.children().eq(b),j.length>0?c.insertBefore(j):a.append(c)}}),e.on("drop",function(a){a.originalEvent.preventDefault()})},f=function(a,c){a.on("dragover",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),a.on("dragenter",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),a.on("drop",function(a){var d,e,f;a.originalEvent.preventDefault(),a.originalEvent.stopPropagation(),d=a.originalEvent.dataTransfer.getData("text/plain"),d=JSON.parse(d),f=d.sortIndex,b>f&&(b-=1),f!==b&&(e=c.items.splice(f,1)[0],c.items.splice(b,0,e),c.$apply(),c.orderChangedCallback())})},g=function(b,c){a=$(c[0]),b.$watchCollection("items",function(b,c){var d=a.children(),f=_.difference(b,c);angular.forEach(d,function(a,c){_.indexOf(f,b[c])>-1&&e($(a))})}),f(a,b)};return{restrict:"A",scope:{items:"=",orderChangedCallback:"&onOrderChanged"},link:g}}]),angular.module("authoringEnvironmentApp").service("Dragdata",["$log","articleType",function(a){this.converters={test:function(){return{}},image:function(a){return{id:a.attr("data-id"),width:a.attr("data-width")}},embed:function(a){return{id:a.attr("data-id")}}},this.available=function(){var a=[];return angular.forEach(this.converters,function(b,c){a.push(c)}),a},this.checkDraggable=function(a){var b=a.attr("data-draggable-type");return b?b in this.converters?!1:'error: draggable type "'+b+'" is not supported':"error: a draggable element has not a data-draggable-type attribute"},this.getData=function(a){var b=a.attr("data-draggable-type"),c=this.converters[b],d=c(a);return d.type=b,JSON.stringify(d)},this.getDropped=function(b){var c=JSON.parse(b);switch(c.type){case"test":return $("<div>").text("test dropped");case"image":return Aloha.jQuery("<div>").data({id:c.id}).alohaBlock({"aloha-block-type":"ImageBlock"});
case"embed":return Aloha.jQuery("<div>").append($("<dropped-snippet>").attr({"data-snippet-id":c.id})).addClass("dropped-snippet").alohaBlock();default:a.debug("getDropped function called on a malformed data object, no known type into it")}}}]),angular.module("authoringEnvironmentApp").factory("SnippetTemplate",["$http","$q",function(a,b){var c=this,d=function(){};return c.createFromApiData=function(a){var b=Object.create(d.prototype);return["id","name","enabled","favourite"].forEach(function(c){b[c]=a[c]}),b.fields=[],_.forEach(a.fields,function(a){"frontend"===a.scope&&b.fields.push(angular.copy(a))}),b},d.getAll=function(){var d=b.defer(),e=[];return e.$promise=d.promise,a.get(Routing.generate("newscoop_gimme_snippettemplates_getsnippettemplates",{},!0),{params:{items_per_page:99999}}).success(function(a){a.items.forEach(function(a){a=c.createFromApiData(a),e.push(a)}),d.resolve()}).error(function(a){d.reject(a)}),e},d.createFromApiData=c.createFromApiData,d}]),angular.module("authoringEnvironmentApp").factory("Snippet",["$http","$q",function(a,b){var c=this,d=function(){};return c.createFromApiData=function(a){var b=Object.create(d.prototype);return["id","templateId","name","render"].forEach(function(c){b[c]=a[c]}),b},d.getAllByArticle=function(d,e){var f=b.defer(),g=[];return g.$promise=f.promise,a.get(Routing.generate("newscoop_gimme_snippets_getsnippetsforarticle_1",{number:d,language:e},!0),{params:{rendered:!0,items_per_page:99999}}).success(function(a){a.items.forEach(function(a){a=c.createFromApiData(a),g.push(a)}),f.resolve()}).error(function(a){f.reject(a)}),g},d.getById=function(d){var e=b.defer(),f=Routing.generate("newscoop_gimme_snippets_getsnippet",{snippetId:d},!0);return a.get(f,{params:{rendered:!0}}).success(function(a){e.resolve(c.createFromApiData(a))}).error(function(a){e.reject(a)}),e.promise},d.create=function(d,e,f){var g,h=b.defer();return g={template:e,snippet:{name:d,fields:{}}},_.forEach(f,function(a,b){g.snippet.fields[b]={data:a}}),a.post(Routing.generate("newscoop_gimme_snippets_createsnippet",{},!0),g).then(function(b){var c=b.headers("x-location");return a.get(c,{params:{rendered:!0}})},function(){return b.reject()}).then(function(a){var b=c.createFromApiData(a.data);h.resolve(b)},function(){h.reject()}),h.promise},d.prototype.addToArticle=function(c,d){var e,f=this,g=b.defer();return e="<"+Routing.generate("newscoop_gimme_snippets_getsnippet",{snippetId:f.id},!1)+'; rel="snippet">',a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:c,language:d},!0),method:"LINK",headers:{link:e}}).success(function(){g.resolve()}).error(function(a){g.reject(a)}),g.promise},d.prototype.removeFromArticle=function(c,d){var e,f=this,g=b.defer();return e="<"+Routing.generate("newscoop_gimme_snippets_getsnippet",{snippetId:f.id},!1)+'; rel="snippet">',a({url:Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:c,language:d},!0),method:"UNLINK",headers:{link:e}}).success(function(){g.resolve()}).error(function(a){g.reject(a)}),g.promise},d}]),angular.module("authoringEnvironmentApp").controller("PaneSnippetsCtrl",["$scope","$q","article","Snippet","SnippetTemplate","modalFactory",function(a,b,c,d,e,f){a.clearNewSnippetForm=function(){a.newSnippet.name="",a.newSnippet.template=null,a.snippetTemplates.forEach(function(a){a.fields.forEach(function(a){delete a.value})})},a.addNewSnippetToArticle=function(e){var f,g={};a.addingNewSnippet=!0,e.template.fields.forEach(function(a){g[a.name]=a.value}),d.create(e.name,e.template.id,g).then(function(a){return f=a,c.promise},b.reject).then(function(a){return f.addToArticle(a.number,a.language)},b.reject).then(function(){a.snippets.push(f)}).finally(function(){a.addingNewSnippet=!1})},a.confirmRemoveSnippet=function(d){var e,g,h;g="Do you really want to remove this snippet?",h="Should you change your mind, the snippet can always be added again.",e=f.confirmLight(g,h),e.result.then(function(){return c.promise},b.reject).then(function(a){return d.removeFromArticle(a.number,a.language)},b.reject).then(function(){_.remove(a.snippets,function(a){return a===d})})},a.showAddSnippet=!1,a.newSnippet={name:"",template:null},a.addingNewSnippet=!1,a.inputFieldTypes=Object.freeze({integer:"number",text:"text",url:"url"}),a.snippetTemplates=e.getAll(),c.promise.then(function(b){a.snippets=d.getAllByArticle(b.number,b.language)})}]),angular.module("authoringEnvironmentApp").controller("DroppedSnippetCtrl",["$scope","$sce","Snippet",function(a,b,c){a.expanded=!1,this.init=function(d){c.getById(d).then(function(c){a.snippetHtml=b.trustAsHtml(c.render),a.snippet=c})},a.expand=function(){a.expanded=!0},a.collapse=function(){a.expanded=!1}}]),angular.module("authoringEnvironmentApp").directive("droppedSnippet",[function(){return{restrict:"E",templateUrl:"views/dropped-snippet.html",controller:"DroppedSnippetCtrl",scope:{snippetId:"@"},link:function(a,b,c,d){var e=parseInt(a.snippetId);b.find(".remove").on("click",function(){b.parent().remove()}),d.init(e)}}}]),angular.module("authoringEnvironmentApp").directive("autoListOffset",[function(){return{restrict:"A",link:function(a,b){function c(){var a=Math.round(d.outerHeight());0!==a&&(h?(a=g,h=!1):a+=f,e.css("top",a))}var d,e,f=125,g=150,h=!0;d=b.find(".add-element"),e=b.find(".list"),d.mutate("height",function(){c()}),c()}}}]),angular.module("authoringEnvironmentApp").factory("NcImage",["$http","$q",function(a,b){var c;return c=function(a){var b,c=this;b=["id","basename","thumbnailPath","description","photographer","photographerUrl"],a=a||{},b.forEach(function(b){c[b]=a[b]}),c.width="width"in a?parseInt(a.width,10):void 0,c.height="height"in a?parseInt(a.height,10):void 0},c.getById=function(d){var e=b.defer();return a.get(Routing.generate("newscoop_gimme_images_getimage",{number:d},!0)).success(function(a){e.resolve(new c(a))}).error(function(a){e.reject(a)}),e.promise},c}]),angular.module("authoringEnvironmentApp").service("images",["$http","pageTracker","configuration","$log","article","getFileReader","formDataFactory","imageFactory","$upload","$rootScope","$q",function(a,b,c,d,e,f,g,h,i,j,k){var l=this,m=50;e.promise.then(function(a){l.article=a,l.loadAttached(a)}),this.tracker=b.getTracker({max:100}),this.loaded=[],this.displayed=[],this.collected=[],this.attached=[],this.images2upload=[],this.includedIndex=-1,this.inArticleBody={},this.itemsPerPage=m,this.itemsFound=0,this.searchFilter="",this.canLoadMore=!1,this.query=function(a){for(this.searchFilter=a;l.displayed.length>0;)l.displayed.pop();for(;l.loaded.length>0;)l.loaded.pop();this.tracker.reset(),this.itemsFound=0,this.canLoadMore=!1,this.load(this.tracker.next(),this.searchFilter).success(function(a){l.displayed=a.items,a.pagination?(l.itemsPerPage=a.pagination.itemsPerPage,l.itemsFound=a.pagination.itemsCount):(l.itemsPerPage=m,l.itemsFound=a.items.length),l.canLoadMore=!b.isLastPage(a.pagination),l.canLoadMore&&l.more()})},this.more=function(){var a=this.loaded.splice(0,this.itemsPerPage);this.displayed=this.displayed.concat(a),l.canLoadMore&&this.load(this.tracker.next(),this.searchFilter).success(function(a){l.loaded=l.loaded.concat(a.items),l.canLoadMore=!b.isLastPage(a.pagination)})},this.load=function(b,c){var d,e,f;return d={expand:!0,items_per_page:this.itemsPerPage,page:b},c?(f=Routing.generate("newscoop_gimme_images_searchimages",{},!0),d.query=c):f=Routing.generate("newscoop_gimme_images_getimages",{},!0),e=a.get(f,{params:d}),e.error(function(){l.tracker.remove(b)}),e},this.loadAttached=function(b){var c=Routing.generate("newscoop_gimme_images_getimagesforarticle",{number:b.number,language:b.language,items_per_page:99999,expand:"true"},!0);a.get(c).then(function(a){l.attached=a.data.items})},this.matchMaker=function(a){return function(b){return parseInt(b.id)===parseInt(a)}},this.collect=function(b,c){var d,e,f;this.isCollected(b)||(c?(f=Routing.generate("newscoop_gimme_images_getimage",{number:b},!0),a.get(f).then(function(a){l.collected.push(a.data)})):(e=this.matchMaker(b),d=_.find(this.displayed,e),d&&l.collected.push(d)))},this.discard=function(a){var b=this.matchMaker(a);_.remove(this.collected,b)},this.discardAll=function(){for(;l.collected.length>0;)l.collected.pop();for(;l.images2upload.length>0;)l.images2upload.pop()},this.attachAllCollected=function(){var b=[],c=[];l.collected.forEach(function(a){_.find(l.attached,a)||b.push(a)}),b.length<1||(b.forEach(function(a){c.push("<"+Routing.generate("newscoop_gimme_images_getimage",{number:a.id},!0)+">")}),c=c.join(),a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:l.article.number,language:l.article.language},!0),method:"LINK",headers:{Link:c}}).success(function(){b.forEach(function(a){l.attached.push(a)})}))},this.attach=function(b,c){var e,f,g=this.matchMaker(b);return _.find(this.attached,g)?void d.debug("image already attached, ignoring attach request"):(f=Routing.generate("newscoop_gimme_articles_linkarticle",{number:l.article.number,language:l.article.language},!0),e="<"+Routing.generate("newscoop_gimme_images_getimage",{number:b},!0)+">",d.debug("sending link request"),d.debug(f),d.debug(e),void a({url:f,method:"LINK",headers:{Link:e}}).success(function(){if(c)a.get(Routing.generate("newscoop_gimme_images_getimage",{number:b},!0)).success(function(a){l.attached.push(a)});else{var d=_.find(l.displayed,g);l.attached.push(d)}}))},this.detach=function(b){var c=this.matchMaker(b);if(_.find(this.attached,c)){var e=Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:l.article.number,language:l.article.language},!0),f="<"+Routing.generate("newscoop_gimme_images_getimage",{number:b},!0)+">";d.debug("sending an unlink request"),d.debug(e),d.debug(f),a({url:e,method:"UNLINK",headers:{Link:f}}).success(function(){_.remove(l.attached,c)})}else d.debug("image already detached, ignoring attach request")},this.addToIncluded=function(a){this.inArticleBody[a]=!0},this.removeFromIncluded=function(a){delete this.inArticleBody[a]},this.findAttached=function(a){return _.find(this.attached,this.matchMaker(a))},this.findCollected=function(a){return _.find(this.collected,this.matchMaker(a))},this.byId=function(a){var b=this.findAttached(a);if(b)return b;throw new Error("asking details about an image which is not attached to the article is not supported")},this.isAttached=function(a){return"undefined"!=typeof this.findAttached(a)},this.isCollected=function(a){return"undefined"!=typeof this.findCollected(a)},this.togglerClass=function(a){return this.isCollected(a)?"glyphicon-minus":"glyphicon-plus"},this.toggleCollect=function(a){this.isCollected(a)?this.discard(a):this.collect(a)},this.addToUploadList=function(a){var b,c;for(b=0;b<a.length;b++)c=this.decorate(a[b]),this.images2upload.push(c),c.readRawData()},this.removeFromUploadList=function(a){_.remove(this.images2upload,a)},this.clearUploadList=function(){for(;this.images2upload.length>0;)this.images2upload.pop()},this.uploadAll=function(){var a,b=[];return l.images2upload.forEach(function(c){a=c.startUpload(),b.push(a)}),b},this.decorate=function(a){return a.isUploaded=!1,a.progress=0,a.max=0,a.percent="0%",a.progressCallback=function(b){a.progress=b.loaded,a.max=b.total,a.percent=Math.round(b.loaded/b.total*100)+"%"},a.startUpload=function(){var b,c=k.defer(),d=g.makeInstance(),e=this,f="No x-location header in API response.";return d.append("image[photographer]",e.photographer),d.append("image[description]",e.description),d.append("image[image]",e),i.http({method:"POST",url:Routing.generate("newscoop_gimme_images_createimage",{},!0),data:d,headers:{"Content-Type":void 0},transformRequest:angular.identity}).progress(a.progressCallback).success(function(d,e,g){var h;a.progressCallback({loaded:100,total:100}),a.isUploaded=!0,h=g()["x-location"],h?(b=h.split("/"),a.id=parseInt(b[b.length-1],10),c.resolve({id:a.id,url:h})):(console.warn(f),c.reject(f))}).error(function(){c.reject("error uploading")}),c.promise},a.readRawData=function(){var b=k.defer(),c=f.get();return c.onload=function(){var d=h.makeInstance();d.onload=function(c){a.width=d.width,a.height=d.height,a.src=d.src,b.resolve(c.target.result),j.$apply()},d.src=c.result},c.readAsDataURL(a),b.promise},a}}]),angular.module("authoringEnvironmentApp").service("modal",["$templateCache","$log","$http",function(){var a="#myModal",b=this;this.visible=!1,this.show=function(c){this.title=c.title,this.url=c.templateUrl,c.backdrop="static",c.keyboard=!1,c.show=!0,$(a).modal(c),b.visible=!0},this.hide=function(){this.visible=!1,$(a).modal("hide")}}]),angular.module("authoringEnvironmentApp").controller("ModalCtrl",["$scope","modal",function(a,b){a.modal=b}]),angular.module("authoringEnvironmentApp").controller("ImagePaneCtrl",["$scope","images","modal","modalFactory","article","articleType","$location","configuration",function(a,b,c,d,e,f,g,h){a.images=b,a.defaultWidth="100%",a.root=h.API.rootURI,a.attachModal=function(){c.show({title:"Attach Image",templateUrl:"views/attach-image.html"})},a.detachingAllowed=function(a){return!b.inArticleBody[a]},a.detachImage=function(a){var c,e,f;e="Do you really want to detach this image from the article?",f="Should you change your mind, the image can always be re-attached again.",c=d.confirmLight(e,f),c.result.then(function(){b.detach(a)},function(){})}}]),angular.module("authoringEnvironmentApp").controller("MediaArchiveCtrl",["$scope","images","configuration",function(a,b,c){a.images=b,a.root=c.API.rootURI,a.searchFilter="",a.$watch("images.searchFilter",function(b){a.appliedFilter=b}),a.thumbnailClicked=function(a){var c=b.isAttached(a),d=b.isCollected(a);c||d||b.toggleCollect(a)},a.searchArchive=function(a){b.query(a)},a.loadMore=function(){b.more()}}]),angular.module("authoringEnvironmentApp").controller("AttachImageCtrl",["$scope","$q","images","modal","configuration",function(a,b,c,d,e){a.root=e.API.rootURI,a.images=c,a.sources=[{value:"computer",url:"views/attach-image/computer.html",description:"From Computer"},{value:"archive",url:"views/attach-image/archive.html",description:"Media Archive"}],a.selected=a.sources[1],a.select=function(b){a.selected=b},a.attachCollected=function(){c.attachAllCollected(),c.discardAll(),d.hide()},a.discardChanges=function(a){a.preventDefault(),a.stopPropagation(),c.discardAll(),d.hide()}}]),angular.module("authoringEnvironmentApp").controller("UploadFromCompCtrl",["$scope","images","$q",function(a,b,c){a.images2upload=b.images2upload,a.uploading=!1,a.$watchCollection("images.images2upload",function(b){a.images2upload=b}),a.addToUploadList=function(c){b.addToUploadList(c),a.$apply()},a.removeFromStaging=function(a){b.removeFromUploadList(a)},a.uploadStaged=function(){var d;a.uploading=!0,d=b.uploadAll(),c.all(d).then(function(a){a.forEach(function(a){b.collect(a.id,!0)}),b.clearUploadList()}).finally(function(){a.uploading=!1})},a.clearStaged=function(){b.clearUploadList()},a.setForAllPhotographer=function(a){b.images2upload.forEach(function(b){b.photographer=a})},a.setForAllDescription=function(a){b.images2upload.forEach(function(b){b.description=a})}}]),angular.module("authoringEnvironmentApp").service("pageTracker",function(){this.isLastPage=function(a){if("undefined"==typeof a)return!0;["itemsPerPage","currentPage","itemsCount"].map(function(b){a[b]=parseInt(a[b],10)});var b=a.itemsCount/a.itemsPerPage;return a.currentPage>=b},this.getTracker=function(){return{counter:1,pages:{},remove:function(a){delete this.pages[a]},has:function(a){return a in this.pages},next:function(){for(var a=1;a<=this.counter;a++)if(this.has(a)===!1)return this.pages[a]=!0,a===this.counter&&this.counter++,a},reset:function(){this.pages={},this.counter=1}}}}),angular.module("authoringEnvironmentApp").directive("droppedImage",["configuration","$log",function(a,b){return{restrict:"A",templateUrl:"views/dropped-image.html",controller:"DroppedImageCtrl",scope:{imageId:"@imageId",imageAlign:"@imageAlign",imageAlt:"@imageAlt",imageSub:"@imageSub",imageWidth:"@imageWidth",imageHeight:"@imageHeight"},link:function(c,d,e,f){function g(){var a,b,c;h&&(c=j.outerHeight()+h.outerHeight(),c=-Math.round(c),a=i.css("float"),"left"===a?b=0:"right"===a?(b=j.outerWidth()-h.outerWidth(),b=Math.round(b)):(b=j.outerWidth()-h.outerWidth(),b=Math.round(b/2)),h.css({top:c,left:b}))}var h,i=$(d),j=i.find(".dropped-image");i.mutate("height width",function(){g()}),i.find("button.close").click(function(a){a.stopPropagation(),i.remove(),f.imageRemoved(parseInt(c.imageId,10))}),j.click(function(a){a.stopPropagation(),h=h||$("#img-toolbar-"+c.imageId),h.toggle()}),c.align=function(a){var c,d;switch(a){case"left":c="left",d="2% 2% 2% 0";break;case"right":c="right",d="2% 0 2% 2%";break;case"center":c="none",d="2% auto";break;default:return void b.warn("unknown image alignment:",a)}i.css({"float":c,margin:d}),g()},c.setSize=function(b){var d;d=b in a.image.width?a.image.width[b]:c.image.width,i.width(d)},c.changePixelSize=function(a){angular.isNumber(a)&&a>0&&i.width(Math.round(a))},f.init(parseInt(c.imageId,10))}}}]),angular.module("authoringEnvironmentApp").controller("DroppedImageCtrl",["images","$scope","configuration","NcImage","$rootScope",function(a,b,c,d,e){this.init=function(c){d.getById(c).then(function(c){b.image=c,a.addToIncluded(c.id)})},this.imageRemoved=function(b){a.removeFromIncluded(b),e.$apply(a.inArticleBody)},b.root=c.API.rootURI,b.images=a}]),angular.module("authoringEnvironmentApp").factory("configuration",function(){return{API:{rootURI:"http://newscoop.aes.sourcefabric.net",endpoint:"/content-api",full:"http://newscoop.aes.sourcefabric.net/content-api"},auth:{client_id:"7_6203opwgvx8g4skgskksgkws8cs44ks8s4cw4sc8cg4wsk8c40",redirect_uri:"http://localhost:9000",server:"http://newscoop.aes.sourcefabric.net/oauth/v2/auth?"},article:{width:{desktop:960,tablet:600,phone:320}},image:{width:{small:"30%",medium:"50%",big:"100%"},"float":"none"},additionalFields:{news:[{name:"main_image",fieldWeight:10,isContentField:!0},{name:"title",fieldWeight:0,isContentField:!0}]}}}),angular.module("authoringEnvironmentApp").directive("fixedImagePlaceholder",function(){return{templateUrl:"views/fixed-image-placeholder.html",restrict:"E",link:function(a,b){b.on("drop",function(b){b.preventDefault();var c=b.originalEvent.dataTransfer.getData("Text");a.onDrop(c)})}}}),angular.module("authoringEnvironmentApp").controller("FixedImagePlaceholderCtrl",["$scope","images","configuration",function(a,b,c){a.root=c.API.rootURI,a.style={},a.dropped=!1,a.onDrop=function(c){var d=JSON.parse(c);"image"===d.type&&a.$apply(function(){a.image=b.byId(d.id),a.style.opacity=1,a.dropped=!0})}}]),angular.module("authoringEnvironmentApp").factory("authInterceptor",["$q","$window",function(a,b){return{request:function(a){var c=Routing.generate("newscoop_gimme_articles_getarticles");return c=c.substring(1,c.lastIndexOf("/")),-1===a.url.indexOf(c+"/")?a:(a.headers=a.headers||{},b.sessionStorage.token&&(a.headers.Authorization="Bearer "+b.sessionStorage.token),a)}}}]),angular.module("authoringEnvironmentApp").service("addToUrl",function(){this.add=function(a,b){var c="";return angular.forEach(a,function(a,b){c+="&"+b+"="+a}),/[?]/.test(b)||(c="?"+c.slice(1)),b+c}}),angular.module("authoringEnvironmentApp").service("mode",function(){this.current="normal",this.zen=!1,this.goZen=function(){this.current="zen",this.zen=!0},this.goNormal=function(){this.current="normal",this.zen=!1}}),angular.module("authoringEnvironmentApp").service("platform",function(){var a=this;this.current="desktop",this.go={mobile:function(){a.current="mobile"},desktop:function(){a.current="desktop"},tablet:function(){a.current="tablet"}}}),angular.module("authoringEnvironmentApp").controller("AuthenticationCtrl",["$scope","$window","$location","$log",function(a,b,c,d){a.parse=function(a){var b=a.slice(1),c=b.split("&"),d={};return c.forEach(function(a){var b=a.split("=");d[b[0]]=b[1]}),d};var e=c.url(),f=c.hash();d.debug("location url:",e),d.debug("location hash:",f);var g=a.parse(e);if(d.debug("parsed values:",JSON.stringify(g)),"access_token"in g){b.sessionStorage.token=g.access_token;var h="/";c.url(h),d.debug("redirecting to",h)}}]),angular.module("authoringEnvironmentApp").service("comments",["article","$http","$q","$resource","transform","pageTracker","$log","nestedSort",function(a,b,c,d,e,f,g,h){function i(b){return b.selected=!1,b.showStatus="collapsed",b.isEdited=!1,b.recommended=!!b.recommended,b.editing={status:b.status},b.reply={subject:"Re: "+b.subject,message:""},b.isReplyMode=!1,b.sendingReply=!1,b.collapse=function(){this.showStatus="collapsed",this.isReplyMode=!1},b.expand=function(){this.showStatus="expanded"},b.toggle=function(){"expanded"===this.showStatus?this.collapse():this.expand()},b.edit=function(){this.editing.subject=this.subject,this.editing.message=this.message,this.isEdited=!0,this.isReplyMode=!1},b.cancel=function(){this.isEdited=!1},b.save=function(){var b=this;a.promise.then(function(a){j.resource.save({articleNumber:a.number,languageCode:a.language,commentId:b.id},{comment:b.editing},function(){b.subject=b.editing.subject,b.message=b.editing.message,b.isEdited=!1})})},b.remove=function(){var b=this;a.promise.then(function(a){j.resource.delete({articleNumber:a.number,languageCode:a.language,commentId:b.id}).$promise.then(function(){_.remove(j.displayed,j.matchMaker(b.id))})})},b.replyTo=function(){b.isReplyMode=!0},b.cancelReply=function(){b.isReplyMode=!1},b.sendReply=function(){var a=this,b=angular.copy(a.reply);b.parent=a.id,a.sendingReply=!0,j.add({comment:b}).then(function(){a.sendingReply=!1,a.isReplyMode=!1,a.reply={subject:"Re: "+a.subject,message:""}})},b.toggleRecommended=function(){var a=this,b=!a.recommended;j.resource.toggleRecommended({commentId:a.id},{comment:{recommended:b?1:0}},function(){a.recommended=b})},b.changeStatus=function(b){var c=this;a.promise.then(function(a){j.resource.patch({articleNumber:a.number,languageCode:a.language,commentId:c.id},{comment:{status:b}},function(){c.status=b},function(){g.debug("error changing the status for the comment")})})},b}var j=this,k=50,l="nested";this.canLoadMore=!0,this.loaded=[],this.displayed=[],this.tracker=f.getTracker(),this.resource=d(Routing.generate("newscoop_gimme_comments_getcommentsforarticle_1",{},!0)+"/:articleNumber/:languageCode",{},{create:{method:"POST",transformRequest:e.formEncode},patch:{method:"PATCH",url:Routing.generate("newscoop_gimme_comments_updatecomment_1",{},!0)+"/:articleNumber/:languageCode/:commentId",transformRequest:e.formEncode},save:{method:"POST",url:Routing.generate("newscoop_gimme_comments_createcomment",{},!0)+"/:articleNumber/:languageCode/:commentId",transformRequest:e.formEncode},"delete":{method:"DELETE",url:Routing.generate("newscoop_gimme_comments_deletecomment_1",{},!0)+"/:articleNumber/:languageCode/:commentId"},toggleRecommended:{method:"PATCH",url:Routing.generate("newscoop_gimme_comments_updatecomment",{},!0)+"/:commentId.json"}}),this.add=function(d){var e=c.defer();return a.promise.then(function(a){j.resource.create({articleNumber:a.number,languageCode:a.language},d,function(a,c){var d=c("X-Location");d?b.get(d).success(function(a){j.displayed.push(i(a)),h.sort(j.displayed)}):j.init(),e.resolve()})}),e.promise},this.init=function(a){j.tracker=f.getTracker(),j.canLoadMore=!0,j.loaded=[],j.displayed=[],l=a&&a.sorting?a.sorting:"nested",this.load(this.tracker.next()).then(function(a){j.displayed=a.items.map(i),h.sort(j.displayed),j.canLoadMore&&j.load(j.tracker.next()).then(function(a){j.loaded=j.loaded.concat(a.items)})})},this.more=function(){if(this.canLoadMore){var a=this.loaded.splice(0,k);a=a.map(i),this.displayed=this.displayed.concat(a);var b=this.tracker.next();this.load(b).then(function(a){j.loaded=j.loaded.concat(a.items)})}else g.error("More comments required, but the service cannot load more of them. In this case the user should not be able to trigger this request")},this.load=function(d){var e=c.defer();return a.promise.then(function(a){var c;c="nested"===l?"nested":"";var g=Routing.generate("newscoop_gimme_comments_getcommentsforarticle_1",{number:a.number,language:a.language,order:c,items_per_page:k,page:d},!0);b.get(g).success(function(a){e.resolve(a),f.isLastPage(a.pagination)&&(j.canLoadMore=!1)}).error(function(){j.tracker.remove(d)})}),e.promise},this.matchMaker=function(a){return function(b){return parseInt(b.id)===parseInt(a)}},this.changeSelectedStatus=function(a,b,c){var d=null,e=this.displayed,f=0,g=e.length,h=[];if(!b&&"undefined"!=typeof c)return void e.forEach(function(b){b.id===c&&b.changeStatus(a)});if(!b&&"undefined"==typeof c)return void e.forEach(function(b){b.selected&&b.changeStatus(a)});if(b&&"undefined"!=typeof c)for(;g>f;){if(d){if(!(e[f].thread_level>d.thread_level))break;h.push(e[f])}else e[f].id===c&&(d=e[f],h.push(d));f++}else for(;g>f;){if(d){if(!(e[f].thread_level>d.thread_level)){d=null;continue}h.push(e[f])}else e[f].selected&&(d=e[f],h.push(d));f++}h.forEach(function(b){b.changeStatus(a)})}}]),angular.module("authoringEnvironmentApp").controller("CommentsCtrl",["$scope","comments","article","modalFactory","$log",function(a,b,c,d,e){var f=["pending","approved","hidden"];a.sortings=[{text:"Nested"},{text:"Chronological"},{text:"Chronological (asc.)"}],a.sorting=a.sortings[0],a.toggle=function(b){var c=a.statuses[b];a.statuses[b]=!c,"all"===b?f.map(c?function(b){a.statuses[b]=!0}:function(b){a.statuses[b]=!1}):c?f.every(function(b){return!1===a.statuses[b]})&&(a.statuses.all=!0):a.statuses.all=!1},a.commentingSettingSrv=c.commenting.ENABLED,a.commentingSetting=a.commentingSettingSrv,a.commentingOptDirty=!1,a.isChangingCommenting=!1,a.commenting=c.commenting,a.commentingOpts=[{value:c.commenting.ENABLED,text:"Enabled"},{value:c.commenting.DISABLED,text:"Disabled"},{value:c.commenting.LOCKED,text:"Locked"}],this.initCommenting=function(){c.promise.then(function(b){a.commentingSettingSrv=parseInt(b.comments_locked,10)>0?c.commenting.LOCKED:parseInt(b.comments_enabled,10)>0?c.commenting.ENABLED:c.commenting.DISABLED,a.commentingSetting=a.commentingSettingSrv})},this.initCommenting(),a.statuses={all:!0,pending:!1,approved:!1,hidden:!1},a.selected=function(b){return a.statuses.all?!0:a.statuses[b.status]?!0:!1},a.isSending=!1,a.comments=b,a.create={},b.init(),a.add=function(c){a.isSending=!0,b.add(c).then(function(){a.adding=!1,a.isSending=!1,a.create={}},function(){a.isSending=!1})},a.cancel=function(){a.adding=!1,a.create={}},a.globalShowStatus="collapsed",a.$watch("globalShowStatus",function(){b.displayed.map(function(b){b.showStatus=a.globalShowStatus})}),a.updateCommentingDirtyFlag=function(){a.commentingOptDirty=a.commentingSetting!==a.commentingSettingSrv},a.changeCommentingSetting=function(){var b=a.commentingSetting,d=a.commentingSettingSrv;a.isChangingCommenting=!0,c.changeCommentingSetting(b).then(function(){a.commentingSettingSrv=b},function(){a.commentingSetting=d}).finally(function(){a.updateCommentingDirtyFlag(),a.isChangingCommenting=!1})},a.toggleShowStatus=function(){a.globalShowStatus="expanded"===a.globalShowStatus?"collapsed":"expanded"},a.$watch("sorting",function(){e.debug("sorting changed"),b.canLoadMore&&b.init("Nested"===a.sorting.text?{sorting:"nested"}:{sorting:"chronological"})}),a.countSelected=function(){var a=0;return b.displayed.forEach(function(b){b.selected&&a++}),a},a.confirmHideComments=function(a){var c,e,f,g="undefined"!=typeof a;g?(e="Do you really want to hide this comment?",f="Comment's content will not be visible to users."):(e="Do you really want to hide selected comments?",f="Comments' contents will not be visible to users."),c=d.confirmLight(e,f),c.result.then(function(){g?b.changeSelectedStatus("hidden",!1,a):b.changeSelectedStatus("hidden",!1)},function(){})},a.confirmDeleteComments=function(a){var c,e,f,g="undefined"!=typeof a;g?(e="Are you sure you want to mark this comment as deleted?",f="Deleted comments are not visible to users."):(e="Are you sure you want to mark selected comments as deleted?",f="Deleted comments are not visible to users."),c=d.confirmHeavy(e,f),c.result.then(function(){g?b.changeSelectedStatus("deleted",!0,a):b.changeSelectedStatus("deleted",!0)},function(){})}}]),angular.module("authoringEnvironmentApp").directive("comment",function(){return{templateUrl:"views/comment.html",restrict:"E",scope:{model:"=",allowreplying:"=",onHide:"&confirmHideComments",onDelete:"&confirmDeleteComments"},link:function(){}}}),angular.module("authoringEnvironmentApp").service("transform",function(){function a(a){return $.param(a)}this.formEncode=function(b,c){var d=c();return d["Content-Type"]="application/x-www-form-urlencoded",a(b)},this.formEncodeData=a}),angular.module("authoringEnvironmentApp").service("circularBufferFactory",function(){this.create=function(a){if(!("size"in a))throw new Error("a circular buffer needs an integer size option");return{opt:a,arr:[],used:function(){return this.arr.length},push:function(a){this.used()>=this.opt.size&&this.arr.shift(),this.arr.push(a)},dump:function(){return angular.copy(this.arr)},prev:function(a){var b=a||1,c=parseInt(b,10);if(1>c)throw new Error(c+" is not a valid value for the `prev` function, check the tests or the code");var d=this.arr.length-c,e=d>=0?d:0;return this.arr[e]}}}}),angular.module("authoringEnvironmentApp").filter("sortComments",["$log",function(a){function b(a){return new Date(a.created)}return function(c,d){var e,f;switch(d){case"Nested":return _.sortBy(c,"nestedPosition");case"Chronological":return e=_.sortBy(c,b),e.reverse(),e;case"Chronological (asc.)":return _.sortBy(c,b);default:throw f="unknown sorting: "+d,a.error(f),new Error(f)}}}]),angular.module("authoringEnvironmentApp").service("nestedSort",["$log",function(a){var b=this;this.sortByCreated=function(a){function b(a){return new Date(a.created)}return _.sortBy(a,b)},this.sort=function(c){function d(a){var c=b.sortByCreated(a.childs);c.forEach(function(a){a.nestedPosition=i,i++,d(a)})}for(var e=[],f=0,g=function(a){return a.thread_level===f},h=c.filter(g);h.length>0;)e.push(h),f++,h=c.filter(g);b.map={root:{childs:[]}},e.forEach(function(c){c.forEach(function(c){var d=angular.copy(c);d.childs=[],0===d.thread_level&&(d.parent="root"),b.map[d.id]=d,"parent"in d?d.parent in b.map?b.map[d.parent].childs.push(d):a.debug("error, comment",d,"has parent",d.parent,"which is not available to us"):a.debug("error, comment",d,"is not first level but it has no parent")})});var i=0;d(b.map.root),c.forEach(function(c){c.id in b.map?c.nestedPosition=b.map[c.id].nestedPosition:a.error("comment",c,"is not in the nested sorting map",b.map)})}}]),angular.module("authoringEnvironmentApp").service("currentTime",function(){var a=!1;this.set=function(b){a=b},this.unset=function(){a=!1},this.get=function(){return a===!1?new Date:a},this.isToday=function(a){var b=this.get();return a.toDateString()===b.toDateString()}}),angular.module("authoringEnvironmentApp").filter("niceDate",["currentTime","$filter",function(a,b){return function(c){var d;return d="string"==typeof c?new Date(Date.parse(c)):c,a.isToday(d)?"today "+b("date")(d,"H:mm"):b("date")(d,"dd.MM.yyyy")}}]),angular.module("authoringEnvironmentApp").directive("dropImages",function(){return{restrict:"A",scope:{handler:"&"},link:function(a,b){b=$(b[0]),b.on("drop",function(b){var c,d,e,f=[],g=new RegExp(/^image\/.*/i);for(b.preventDefault(),b.stopPropagation(),e=b.originalEvent.dataTransfer.files,c=0;c<e.length;c++)d=e.item(c),g.test(d.type)&&f.push(d);a.handler({files:f})}),b.on("dragover",function(a){a.preventDefault(),a.stopPropagation(),a.originalEvent.dataTransfer.dropEffect="copy"})}}}),angular.module("authoringEnvironmentApp").directive("fileUpload",function(){return{restrict:"A",scope:{handler:"&"},link:function(a,b){var c=$("<input>").attr({type:"file",accept:"image/*",multiple:"multiple","class":"hidden-input",style:"display:none"});c.on("click",function(a){a.stopPropagation()}),c.on("change",function(){var b=c.get(0).files;a.handler({files:b})}),b.append(c),b.on("click",function(){c.click()
})}}}),angular.module("authoringEnvironmentApp").factory("Author",["$http","$q","$timeout","dateFactory","pageTracker",function(a,b,c,d,e){var f=250,g=null,h=0,i=function(){};return i.createFromApiData=function(a){var b=new i;return b.id=a.author.id,b.firstName=a.author.firstName,b.lastName=a.author.lastName,b.text=a.author.firstName+" "+a.author.lastName,b.articleRole=a.type?{id:a.type.id,name:a.type.type}:null,b.avatarUrl=a.author.image?"http://"+decodeURIComponent(a.author.image):"/images/authors-default-avatar.png",b.sortOrder=a.order,b},i.getAllByArticle=function(c,d){var e=b.defer(),f=[];return f.$promise=e.promise,a.get(Routing.generate("newscoop_gimme_authors_getarticleauthors",{number:c,language:d,items_per_page:99999},!0)).success(function(a){a.items.forEach(function(a){a=i.createFromApiData(a),f.push(a)}),e.resolve()}).error(function(a){e.reject(a)}),f},i.getRoleList=function(){var c=b.defer(),d=[];return d.$promise=c.promise,a.get(Routing.generate("newscoop_gimme_authors_getauthorstypes",{items_per_page:99999},!0)).success(function(a){a.items.forEach(function(a){a.name=a.type,delete a.type,d.push(a)}),c.resolve()}).error(function(a){c.reject(a)}),d},i.liveSearchQuery=function(b,j){var k=d.makeInstance(),l=b.page>1;if(!j){if(!l)return h=k,void c(function(){i.liveSearchQuery(b,!0)},f);if(angular.equals(b.context,g))return;g=b.context}!l&&f>k-h||a.get(Routing.generate("newscoop_gimme_authors_searchauthors",{items_per_page:10,page:b.page,query:b.term},!0)).success(function(a){var c,d=[];a.items.forEach(function(a){c=i.createFromApiData({author:a}),d.push(c)}),b.callback({results:d,more:!e.isLastPage(a.pagination),context:a.pagination})})},i.setOrderOnArticle=function(b,c,d){var e=[];d.forEach(function(a){e.push(a.id+"-"+a.articleRole.id)}),e=e.join(),a.post(Routing.generate("newscoop_gimme_authors_setarticleauthorsorder",{number:b,language:c},!0),{order:e})},i.prototype.addToArticle=function(c,d,e){var f,g=this,h=b.defer();return f="<"+Routing.generate("newscoop_gimme_authors_getauthorbyid",{id:g.id},!1)+'; rel="author">,<'+Routing.generate("newscoop_gimme_authors_getauthortype",{id:e},!1)+'; rel="author-type">',a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:c,language:d},!0),method:"LINK",headers:{link:f}}).success(function(){g.articleRole=g.articleRole||{},g.articleRole.id=e,h.resolve()}).error(function(a){h.reject(a)}),h.promise},i.prototype.removeFromArticle=function(c,d,e){var f,g=this,h=b.defer();return f="<"+Routing.generate("newscoop_gimme_authors_getauthorbyid",{id:g.id},!1)+'; rel="author">,<'+Routing.generate("newscoop_gimme_authors_getauthortype",{id:e},!1)+'; rel="author-type">',a({url:Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:c,language:d},!0),method:"UNLINK",headers:{link:f}}).success(function(){h.resolve()}).error(function(a){h.reject(a)}),h.promise},i.prototype.updateRole=function(b){var c,d;return c="<"+Routing.generate("newscoop_gimme_authors_getauthortype",{id:b.oldRoleId},!1)+'; rel="old-author-type">,<'+Routing.generate("newscoop_gimme_authors_getauthortype",{id:b.newRoleId},!1)+'; rel="new-author-type">',d=a.post(Routing.generate("newscoop_gimme_authors_updatearticleauthor",{number:b.number,language:b.language,authorId:this.id},!0),{},{headers:{link:c}})},i}]),angular.module("authoringEnvironmentApp").service("imageResource",["$resource","transform",function(a,b){return a(Routing.generate("newscoop_gimme_images_getimage",{},!0)+"/:id",{},{modify:{method:"PATCH",transformRequest:b.formEncode}})}]),angular.module("authoringEnvironmentApp").factory("getFileReader",function(){return{get:function(){return new FileReader}}}),angular.module("authoringEnvironmentApp").factory("formDataFactory",function(){return{makeInstance:function(){return new FormData}}}),angular.module("authoringEnvironmentApp").factory("imageFactory",function(){return{makeInstance:function(){return new Image}}}),angular.module("authoringEnvironmentApp").factory("dateFactory",function(){return{makeInstance:function(){return new Date}}});