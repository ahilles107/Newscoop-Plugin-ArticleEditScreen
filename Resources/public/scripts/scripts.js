"use strict";angular.module("authoringEnvironmentApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAlohaEditor","mgcrea.ngStrap.button","mgcrea.ngStrap.helpers.dimensions","mgcrea.ngStrap.tooltip","mgcrea.ngStrap.popover","template/modal/backdrop.html","template/modal/window.html","ui.bootstrap.modal","ui.select2","angularFileUpload","angularOauth"]).config(["$routeProvider","$httpProvider","$buttonProvider",function(a,b,c){a.when("/:language/:article",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/:callback*",{templateUrl:"views/oAuthCallback.html",controller:"CallbackCtrl"}).otherwise({redirectTo:"/de/123"}),b.interceptors.push("authInterceptor"),c.defaults.toggleEvent="change"}]).run(["$document",function(a){a.on("dragover drop",function(a){a.preventDefault()})}]);var ModalCtrlConstructor=function(a,b,c,d){a.title=c,a.text=d,a.ok=function(){b.close(!0)},a.cancel=function(){b.dismiss(!1)}};ModalCtrlConstructor.$inject=["$scope","$modalInstance","title","text"],angular.module("authoringEnvironmentApp").factory("modalFactory",["$modal",function(a){return{_createConfirmInstance:function(b,c,d){var e=d?"views/modal-confirm-heavy.html":"views/modal-confirm-light.html";return a.open({templateUrl:e,controller:ModalCtrlConstructor,backdrop:"static",keyboard:!1,resolve:{title:function(){return b},text:function(){return c}}})},confirmLight:function(a,b){return this._createConfirmInstance(a,b,!1)},confirmHeavy:function(a,b){return this._createConfirmInstance(a,b,!0)}}}]),function(a){function b(){a.module("authoringEnvironmentApp").config(["$provide",function(a){a.decorator("$httpBackend",angular.mock.e2e.$httpBackendDecorator)}]).run(["$httpBackend",function(a){a.whenGET(/views\/.*/).passThrough();var b={language:"en",fields:{highlight:"0",lede:"<p>BRUSSELS - Italian and Greek candidates nominated for President of the European Council in secret ballot.</p>",body:'<!-- Snippet 12 --><p>It plu plia olda nula, lo ekoo interjekcio aŭ. Iom inkluzive dividostreko sh, subtraho praantaŭhieraŭ bio fo. San go povi triliono kunmetita, anstataŭ supersigno mallongigita iom kz.</p> <!** Image 101 align="left" alt="Daniel Göpfert" sub="Daniel Göpfert" width="90" height="120" > <!-- Snippet 8 align="left" --> <p>Tiel ofon iometo dio at, vir alikvante montrovorto prirespondi re, sis tiam reen frazparto jh. Pov mi pobo infra alternativo, nenio geedzo alimaniere sor um.</p>\r\n<p>Tek in dekoj komplika kernovorto, dekuma disskribado je end. Vendo posttagmezo um esk, ki nedifina personalo, unt. Sen ki tiele aligi resti. Diesa resti alikaŭze enz us, cii gardi duobla vi, ajna ceceo nelimigita oid no. Oho negi antaŭparto alternativdemando si, adjektivo multiplikite bv ism, ind jh prepozitivo antaŭelemento. He ano orda nekutima, mil fi alia patro solstariva.</p>\r\n<p>Tia zepto rolvorteto du. Ar duo frota sepen dikfingro. Des vavo senforte ed. Mano halt\' onklo sur nv, aliu help transigi ian o, amen multe kompreneble ena er. Nul tiuj fora nano jo.</p>\r\n<p>Kuo op negi posta. Kazablanko subpropozicio mal ne. End ad ekoo sori, in sor otek finitivo okulvitroj, egalo latina iom ge. Pra ho filo troa, mf esk apud aliel geedzo, fin duobla fratineto sekstiliono as. Lo devus video kelka mia, sia ed mili fini. Sin nula usono kunmetaĵo ik, cii op tiea post gibi, sob brosi substantiva is.</p>\r\n<p>Jam unun participo sh. Nea mo ioma identiga, mi edzo ekde frikativo dio. Cii milo tohuo iufoje tc, mo tet krom prezoinda tempopunkto, hago dank\' esperantigita ok kie. Iufoje helpverbo ko mis, poa ci dura eĥo komparado. Pli persa deziri ju, falsa ekesti definitive jes aj. Tro iu hodiaŭa infinitivo, e eca malpli kernovorto.</p>\r\n<p>Ke ato armo postpriskribo. Mem al triliono frikativo miriametro, spite vortfarado fo iel. Oj iom ruli okej vatto. Jota tiama tagnokto nu ili. Nei kian spite ki, nenia reciprokeco ajn vo. Hot jena respondeci uj.</p>\r\n<div class="generic-embed"> </div>\r\n<p>Fri go longa senobjekta postmorgaŭ, deci praantaŭhieraŭ ina el, nea ve dato hekto. Ci speco anstataŭi sat, ses mono literaturo ko. Per vi dume falsa fundamenta, amen siatempe kuo id. Pri vi eĥo fontoj frazparto. Kab\'o difina laŭlonge ne aĥ.</p>',printsection:"Sports",printstory:null,iPad_prominent:"0"},authors:[{name:"Test Persona",link:"http://tw-merge.lab.sourcefabric.org/content-api/author/9"},{name:"Frank N. Stein",link:"http://tw-merge.lab.sourcefabric.org/content-api/author/13"}],number:"64",title:"European Council candidates set to be named",updated:"2013-12-17T14:31:14+0000",comments:"http://tw-merge.lab.sourcefabric.org/content-api/articles/64/en/comments",type:"news",published:"2013-11-14T10:49:17+0000",topics:[{id:10,title:"Cruise Night"},{id:10,title:"Crucero nocturno"},{id:11,title:"People In The News"},{id:11,title:"La gente en las noticias"},{id:29,title:"Milan Shows"},{id:29,title:"Muestra Milán"}],slideshow:[{id:5,title:"Berlin Zoo",itemsLink:"http://tw-merge.lab.sourcefabric.org/content-api/slideshows/5"}],renditions:[{caption:"articlebig",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/600x400%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"sectionthumb",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/250x167%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"square",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/150x150%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"thumb",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/150x100%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"topfront",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/500x333%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"artikel",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/555x370%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"artikelnew",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/639x426%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"blogsidebar",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x150%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierbild",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/980x306%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierbildnew",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/990x330%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierteaser",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x131%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"naviteaser",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/120x53%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"rubrikenseite",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x200%2Ffit%2Fimages%257Ccms-image-000000099.jpg"}],webcode:"cup6z",reads:"5"},d={name:"news",fields:[{name:"body",type:"body",fieldWeight:3,isHidden:0,commentsEnabled:0,fieldTypeParam:"editor_size=750",isContentField:1},{name:"highlight",type:"switch",fieldWeight:1,isHidden:0,commentsEnabled:0,isContentField:0},{name:"iPad_prominent",type:"switch",fieldWeight:6,isHidden:0,commentsEnabled:0,isContentField:0},{name:"lede",type:"longtext",fieldWeight:2,isHidden:0,commentsEnabled:0,fieldTypeParam:"editor_size=250",isContentField:0},{name:"printsection",length:0,type:"text",fieldWeight:4,isHidden:0,commentsEnabled:0,isContentField:0},{name:"printstory",length:0,type:"text",fieldWeight:5,isHidden:0,commentsEnabled:0,isContentField:0}]},e=new RegExp(c+"/articles.*");a.whenGET(e).respond(b),a.when("PATCH",e).respond({});var e=new RegExp(c+"/articleTypes.*");a.whenGET(e).respond(d);var f=function(a,b){return{id:a,name:"My "+a+" "+b,template:b,content:{code:'<div class="embed'+a+'">This is so cool, '+b+"</div>"}}},g={1:f(1,"Generic"),2:f(2,"Generic"),3:f(3,"Generic"),4:f(4,"Generic")},h={5:f(5,"Tweet"),6:f(6,"Tweet"),7:f(7,"Tweet"),8:f(8,"Tweet")},i={1:f(1,"Generic"),2:f(2,"Generic"),3:f(3,"Generic"),4:f(4,"Generic"),5:f(5,"Tweet"),6:f(6,"Tweet"),7:f(7,"Tweet"),8:f(8,"Tweet")},e=new RegExp("/content-api/images[?]page=[0-9]+");a.whenGET(e).respond({items:[{id:1,basename:"Carla-bruni-sarkozy.jpg"},{id:2,basename:"French_election__N_2200069b.jpg"},{id:3,basename:"Strong-turnout-for-French-election.jpg"},{id:4,basename:"sarcozy-presidente-de-francia.jpg"},{id:5,basename:"sarkyDM1910_468x505.jpg"},{id:6,basename:"images-cms-image-003318021.jpg"},{id:7,basename:"images-cms-image-003935520.jpg"},{id:8,basename:"images-cms-image-004021392.jpg"},{id:9,basename:"images-cms-image-004059514.jpg"},{id:10,basename:"images-cms-image-004059556.jpg"}],pagination:{itemsPerPage:10,currentPage:1,itemsCount:149735,nextPageLink:"https://tw-merge.lab.sourcefabric.org/content-api/images?page=2&items_per_page=10"}});var e=new RegExp("/content-api/images/[0-9]+");a.whenGET(e).respond({id:1,location:"local",basename:"French_election__N_2200069b.jpg",thumbnailPath:"cms-thumb-000000001.jpg",url:"",description:"image description",width:"150",height:"210",photographer:"",photographerUrl:"",place:""});var e=new RegExp("/content-api/comments/.*");a.whenGET(e).respond({items:[{id:26822,author:"Inihe Ublinschä",subject:"subject",message:"message",thread_level:0,thread_order:1,status:"approved",created:"2013-11-28T18:10:09+0000",updated:"2013-11-28T18:10:09+0000",recommended:0},{id:26828,author:"More Timat",subject:"ungeeignet..",message:"Mir fiel derselbe Satz auf: «Das Anliegen, die Spekulation mit Grundbesitz einzudämmen ... , sei zwar verständlich, doch die Initiative sei dazu ungeeignet» Ja was gibts denn für geeignete Mittel möchte ich gerne wissen. Enteignung? Verstaatlichung des gesamten Bodens und Verpachtung im Baurecht für 99 Jahre? Vorschläge willkommen!",thread_level:0,thread_order:2,status:"approved",created:"2013-11-28T21:30:43+0000",updated:"2013-11-28T21:30:43+0000",recommended:1}]});var j=g,k=(f(1,"Generic"),{id:1,name:"Generic",template:"%code%"});a.whenGET(/\/content-api\/article\/64\/1\/snippets\/[\d]/).respond(function(a,b){return console.log(b.split("/")),[200,f(b.split("/")[4],"generic")]}),a.whenGET(/\/content-api\/article\/64\/1\/snippets/).respond(j),a.whenGET(/\/content-api\/snippets\/generic\/[\d]/).respond(function(a,b){return[200,f(b.split("/")[4],"generic")]}),a.whenGET(/\/content-api\/snippets\/tweet\/[\d]/).respond(function(a,b){return[200,f(b.split("/")[4],"tweet")]}),a.whenGET(/\/content-api\/snippets\/generic/).respond(g),a.whenGET(/\/content-api\/snippets\/tweet/).respond(h),a.whenGET(/\/content-api\/snippets/).respond(i),a.whenGET(/\/content-api\/snippetTemplate\/[\d]/).respond(k)}])}if(document.URL.match(/nobackend$/)){console.log("=== STUBBED BACKEND ===");var c="http://newscoop.aes.sourcefabric.net/content-api";b()}}(angular),angular.module("authoringEnvironmentApp").filter("availableRoles",[function(){return function(a,b,c){var d=[];return b?(a.forEach(function(a){var e=!1;c.forEach(function(c){return c!==b?c.id===b.id&&c.articleRole.id===a.id?void(e=!0):void 0:void 0}),e||d.push(a)}),d):a}}]),angular.module("authoringEnvironmentApp").config(["TokenProvider",function(a){a.extendConfig({clientId:"14_7lu4iulnlr0gg0gwcwowkkcko48000k84sokgwcg44s4oks0g",redirectUri:"http://localhost:9000/#/callback",authorizationEndpoint:"http://newscoop.aes.sourcefabric.net/oauth/v2/auth",verifyFunc:""})}]).controller("MainCtrl",["$scope","$window","mode","configuration","Token",function(a,b,c,d,e){if(void 0===e.get()){var f=a.askApproval?{approval_prompt:"force"}:{};e.getTokenByPopup(f).then(function(c){a.accessToken=c.access_token,a.expiresIn=c.expires_in,e.set(c.access_token),b.sessionStorage.token=e.get()},function(){alert("Failed to get token from popup.")})}else b.sessionStorage.token=e.get();a.$on("$viewContentLoaded",function(){jQuery("#cs-specific").prependTo(".main-background-container")}),a.mode=c}]),angular.module("authoringEnvironmentApp").controller("SfPanesCtrl",["$scope","$filter","panes",function(a,b,c){a.panes=c.query(),a.tabpaneIsOpen=function(c){return b("filter")(a.panes,{position:c,selected:!0,visible:!0}).length>0},a.flipVisible=function(a){c.visible(a),a.active=!0}}]),angular.module("authoringEnvironmentApp").controller("PaneAuthorsCtrl",["$scope","article","Author","modalFactory",function(a,b,c,d){var e=this;e.setRoleChangeWatch=function(b){var c=a.$watch(function(){return b.articleRole},function(a,c){a!==c&&e.authorRoleChanged(a,c,b)},!0);b.stopRoleChangeWatch=c},e.authorRoleChanged=function(a,c,d){b.promise.then(function(a){d.updatingRole=!0,d.updateRole({number:a.number,language:a.language,oldRoleId:c.id,newRoleId:d.articleRole.id}).then(null,function(){d.stopRoleChangeWatch(),d.articleRole=c,e.setRoleChangeWatch(d)}).finally(function(){d.updatingRole=!1})})},a.authorRoles=c.getRoleList(),a.authors=[],a.newAuthor=null,a.newAuthorRoleId=null,a.addingNewAuthor=!1,a.showAddAuthor=!0,a.select2Options={minimumInputLength:3,query:c.liveSearchQuery},a.clearNewAuthorForm=function(){a.newAuthor=null,a.newAuthorRoleId=null},a.addAuthorToArticle=function(){var c=angular.copy(a.newAuthor),d=a.newAuthorRoleId;a.addingNewAuthor=!0,b.promise.then(function(b){c.addToArticle(b.number,b.language,d).then(function(){a.authors.push(c),e.setRoleChangeWatch(c)}).finally(function(){a.addingNewAuthor=!1})})},a.confirmRemoveAuthor=function(c){var e,f,g;f="Do you really want to remove this author?",g="Should you change your mind, the same author can always be added again.",e=d.confirmLight(f,g),e.result.then(function(){b.promise.then(function(a){return c.removeFromArticle(a.number,a.language,c.articleRole.id)}).then(function(){_.remove(a.authors,function(a){return a===c})})})},a.orderChanged=function(){b.promise.then(function(b){c.setOrderOnArticle(b.number,b.language,a.authors)})},b.promise.then(function(a){return c.getAll({number:a.number,language:a.language}).$promise}).then(function(b){a.authors=b,b.forEach(function(a){e.setRoleChangeWatch(a)})})}]),angular.module("authoringEnvironmentApp").controller("PaneTopicsCtrl",["$scope",function(a){a.topics=[{id:0,text:"Foo",selected:!1},{id:1,text:"Bar",selected:!0},{id:2,text:"Baz",selected:!1},{id:3,text:"whatever",selected:!1},{id:4,text:"lekker boeiend",selected:!1},{id:5,text:"koekje",selected:!1},{id:6,text:"cookie",selected:!1},{id:7,text:"heee",selected:!1},{id:8,text:"naja",selected:!1}],a.chosenTopics=[],a.addTopic=function(){a.topics.push({text:a.topicText,selected:!1,id:a.topics[a.topics.length-1].id+1}),a.topicText=""},a.deleteTopic=function(b){a.topics.splice(a.topics.indexOf(b),1)},a.chooseTopic=function(a){a.selected=!0},a.deleteChTopic=function(a){a.selected=!1}}]),angular.module("authoringEnvironmentApp").factory("panes",["$filter",function(a){function b(a){var b="";return angular.forEach(a,function(a,c){switch(a){case"small":b+="shrink-"+c+" ";break;case"big":b+="shrink-"+c+"-more "}}),b}var c=[{name:"Topics",id:"topics",icon:"topics",template:"views/pane-topics.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Authors",id:"authors",icon:"authors",template:"views/pane-authors.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Images",id:"images",icon:"media",template:"views/pane-draggable.html",position:"left",size:"small",visible:!1,active:!1,selected:!0},{name:"Snippets",id:"snippets",icon:"embeds",template:"views/pane-embed.html",position:"left",size:"small",visible:!1,active:!1,selected:!0},{name:"Comments",id:"comments",icon:"comments",template:"views/pane-comments.html",position:"left",size:"big",visible:!1,active:!1,selected:!0}];return c.layout={right:null,left:null},c.articleClass="",{query:function(){return c},visible:function(d){a("filter")(c,{position:d.position}).forEach(function(a){a===d?d.visible=!d.visible:a.visible=!1}),c.layout=this.layout(c),c.articleClass=b(c.layout)},layout:function(a){var b={left:null,right:null};return a.forEach(function(a){a.visible&&(b[a.position]=a.size)}),b}}}]),angular.module("authoringEnvironmentApp").controller("PanesConfigCtrl",["$scope","panes",function(a,b){a.panes=b.query(),a.flipPosition=function(a){a.position="left"===a.position?"right":"left"}}]),angular.module("authoringEnvironmentApp").controller("ArticleCtrl",["$scope","article","articleType","panes","configuration","mode","platform","circularBufferFactory","$log","$routeParams",function(a,b,c,d,e,f,g,h,i,j){b.init({articleId:j.article,language:j.language}),a.mode=f,a.status="Initialising",a.history=h.create({size:5}),a.articleService=b,a.watchCallback=function(b,c){angular.equals(b,c)?(a.modified=!1,a.status="Just downloaded"):b&&c?(a.history.push(c),a.setModified(!0)):(c||i.debug("the old article value is",c),b||i.debug("the new article value is",b))},a.setModified=function(a){b.modified=a},a.save=function(){function c(a,b){if("snippet"===a||"image"===a)return b;if(null===b)return b;var c={snippet:"--",image:"**"},d=$("<div/>").html(b);return d.contents().filter("div."+a).replaceWith(function(){var b="<"+c[a]+" "+a[0].toUpperCase()+a.slice(1)+" "+parseInt($(this).data("id"));return $.each($(this).data(),function(a,c){"id"!==a&&(b+=" "+a+'="'+c+'"')}),b+=" "+c[a]+">"}),d.html().replace(/\&lt\;\*\*/g,"<**").replace(/\*\*\&gt\;/g,"**>").replace(/\&lt\;\-\-/g,"<--").replace(/\-\-\&gt\;/g,"-->")}for(var d in a.article.fields)a.article.fields.hasOwnProperty(d)&&(a.article.fields[d]=c("snippet",c("image",a.article.fields[d])));b.resource.save({articleId:j.article,language:j.language},a.article,function(){a.setModified(!1)},function(){a.status="Error saving"})},a.$watch("article",a.watchCallback,!0),a.$watch("articleService.modified",function(b){a.status=b?"Modified":"Saved"}),b.promise.then(function(b){function d(a){if(null===a)return a;var b="<!--";b+="\\s",b+="Snippet",b+="\\s",b+="([\\d]+)",b+="(?:",b+="\\s",b+='align="',b+='([^"]+)',b+='"',b+=")?",b+="\\s",b+="-->";var c=new RegExp(b,"ig");return a.replace(c,function(a,b,c){var d="";return void 0!==b&&(d+='<div class="snippet" data-id="'+parseInt(b)+'"',void 0!==c&&(d+=' data-align="'+c+'"'),d+="></div>"),d})}function f(a){if(null===a)return a;var b="<!";b+="\\*\\*",b+="[\\s]*",b+="Image",b+="[\\s]+",b+="([\\d]+)",b+="(",b+="(",b+="[\\s]+",b+="(align|alt|sub",b+="|width|height|ratio",b+="|\\w+)",b+="\\s*",b+="=",b+="\\s*",b+="(",b+='"[^"]*"',b+="|[^\\s]*",b+=")",b+=")*",b+=")",b+="[\\s]*",b+=">";var c=new RegExp(b,"ig");return a.replace(c,function(a,b,c){var d='<div class="image" data-id="'+b+'"',e=document.createElement("div");e.innerHTML="<div "+c+"></div>";for(var f=e.childNodes[0].attributes,g=0;g<f.length;g++)d+=" data-"+f[g].name+'="'+f[g].value+'"';return d+="></div>"})}a.article=b;for(var g in b.fields)b.fields.hasOwnProperty(g)&&(b.fields[g]=f(d(b.fields[g])));"undefined"==typeof a.type&&(a.type=c.get({type:b.type},function(){var c=e.additionalFields[b.type];c.forEach(function(b){a.type.fields.push(b)})}))}),a.panes=d.query(),a.platform=g,a.editable=function(a){var b=["date","dateline","main_image","lede","body","title"];return-1===b.indexOf(a.name)?!1:!0}}]),angular.module("authoringEnvironmentApp").factory("AlohaFormattingFactory",["$rootScope",function(a){a.$on("texteditor-selection-changed",function(){angular.forEach(b,function(a){var b=Aloha.queryCommandState(a);jQuery(".editoricon-"+a.toLowerCase()).parent().toggleClass("active",b)})});var b=[],c=["Insertorderedlist","Insertunorderedlist"];return{get:function(){return b},add:function(a){-1===c.indexOf(a)&&b.push(a)},remove:function(a){b.splice(b.indexOf(a),1)},query:function(a){return-1===c.indexOf(a)?Aloha.queryCommandState(a):!1}}}]),angular.module("authoringEnvironmentApp").directive("sfAlohaFormatGeneric",["AlohaFormattingFactory",function(a){return{template:'<button class="btn btn-default btn-sm action strong" rel="tooltip"title="{{buttonName}}"><i class="fa fa-{{alohaElement|lowercase}}"></i></button>',restrict:"A",replace:!0,scope:{alohaElement:"@alohaElement",buttonName:"@buttonName"},link:function(b,c){a.add(b.alohaElement),c.attr("disabled",Aloha.queryCommandSupported(b.alohaElement)&&Aloha.queryCommandEnabled(b.alohaElement)),c.bind("click",function(){Aloha.execCommand(b.alohaElement,!1,""),c.toggleClass("active",a.query(b.alohaElement))})}}}]),angular.module("authoringEnvironmentApp").directive("sfAlohaFormatStyle",function(){return{template:'<button class="dropdown-button">{{styleName}}</button>',restrict:"A",replace:!0,scope:{styleElement:"@styleElement",styleName:"@styleName"},link:function(a,b){b.toggleClass("disabled",Aloha.queryCommandSupported("formatBlock")&&Aloha.queryCommandEnabled("formatBlock")),b.bind("click",function(){Aloha.execCommand("formatBlock",!1,a.styleElement)})}}}),angular.module("authoringEnvironmentApp").controller("ToolbarCtrl",["$scope","$filter",function(a,b){a.stylers=[{element:"p",name:"Normal Text"},{element:"h1",name:"Heading 1"},{element:"h2",name:"Heading 2"},{element:"h3",name:"Heading 3"},{element:"h4",name:"Heading 4"},{element:"h5",name:"Heading 5"},{element:"pre",name:"Preformatted"}],a.active=b("filter")(a.stylers,{element:"p"},!0)[0].name;var c=function(){var c=Aloha.queryCommandValue("formatBlock");if(c.toString().length>0){var d=b("filter")(a.stylers,{element:c},!0);d.length>0&&(a.active=d[0].name,a.$apply())}};Aloha.ready(function(){Aloha.bind("aloha-selection-changed",function(){c()}),Aloha.bind("aloha-command-executed",function(){c()})})}]),angular.module("authoringEnvironmentApp").service("article",["$resource","configuration","$q",function(a,b,c){var d,e,f,g=c.defer();return e={1:["English","en"],2:["Romanian","ro"],5:["German","de"],7:["Croatian","hr"],9:["Portuguese Portugal","pt"],10:["Serbian Cyrillic","sr"],11:["Serbian Latin","sh"],12:["French","fr"],13:["Spanish","es"],15:["Russian","ru"],16:["Chinese Simplified","zh"],17:["Arabic","ar"],18:["Swedish","sv"],19:["Korean","ko"],20:["Dutch","nl"],22:["Belarus","be"],23:["Georgian","ka"],24:["Chinese Traditional","zh_TW"],25:["Polish","pl"],26:["Greek","el"],27:["Hebrew","he"],28:["Bangla","bn"],29:["Czech","cs"],30:["Italian","it"],31:["Portuguese Brazil","pt_BR"],32:["Albanian","sq"],33:["Turkish","tr"],34:["Ukrainian","uk"],35:["English Britain","en_GB"],36:["Kurdish","ku"],37:["German Austria","de_AT"]},d=Object.freeze({ENABLED:0,DISABLED:1,LOCKED:2}),f=a(b.API.full+"/articles/:articleId?language=:language",{articleId:"",language:"en"},{query:{method:"GET",isArray:!0},save:{url:b.API.full+"/articles/:articleId/:language",method:"PATCH"}}),{commenting:d,modified:!1,resource:f,promise:g.promise,init:function(a){var b=this;f.get(a).$promise.then(function(a){b.articleId=a.number,b.language=a.language,b.init=function(){},g.resolve(a)})},changeCommentingSetting:function(a){var b,c=this;return b={comments_enabled:a===d.ENABLED?1:0,comments_locked:a===d.LOCKED?1:0},f.save({articleId:c.articleId,language:c.language},b).$promise}}}]),angular.module("authoringEnvironmentApp").service("articleType",["$resource","configuration",function(a,b){return a(b.API.full+"/articleTypes/:type",{},{query:{method:"GET",params:{type:""},isArray:!0}})}]),angular.module("authoringEnvironmentApp").directive("sfDroppable",["$compile","Dragdata",function(a,b){var c="p",d="drag-drop-placeholder",e="."+d;return{restrict:"A",link:function(f,g){$(g).on("dragover",c,function(a){var b=$(a.target);b.next().is(e)||b.after($("<div>").addClass(d))}).on("dragleave",c,function(a){$(a.target).next().is(e)&&$(e).remove()}).on("drop",c,function(c){c.preventDefault(),c.stopPropagation();var d=$(c.target),g=b.getDropped(c.originalEvent.dataTransfer.getData("Text"));d.next().is(e)&&$(e).remove(),d.after(a(g)(f))})}}}]),angular.module("authoringEnvironmentApp").directive("sfDraggable",["Dragdata","$log",function(a,b){return{restrict:"A",link:function(c,d){var e=a.checkDraggable(d);e&&b.debug(e),d.attr("draggable",!0),d.on("dragstart",function(b){var c=a.getData(d);b.originalEvent.dataTransfer.setData("Text",c)})}}}]),angular.module("authoringEnvironmentApp").directive("dragSort",[function(){var a,b=-1,c=null,d=-1,e=function(e){e.attr("draggable",!0),e.on("dragstart",function(b){var c;a.children().each(function(a,b){$(b).attr("data-sort-index",a)}),c={sortIndex:parseInt(e.attr("data-sort-index"),10)},d=c.sortIndex,b.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(c)),b.originalEvent.dataTransfer.effectAllowed="move",e.addClass("dragged")}),e.on("dragend",function(){e.removeClass("dragged"),c&&c.remove(),a.children().each(function(a,b){$(b).removeAttr("data-sort-index")}),b=-1,d=-1}),e.on("dragenter",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),e.on("dragover",function(f){var g,h,i,j,k=parseInt(e.attr("data-sort-index"),10);if(f.originalEvent.preventDefault(),f.originalEvent.dataTransfer.dropEffect="move",i=void 0===f.offsetY?f.originalEvent.pageY-e.offset().top:f.originalEvent.offsetY,g=e.outerHeight(),h=g/2>i?k:k+1,h!==b){if(b=h,c&&c.remove(),b===d||b===d+1)return;c=$('<div class="new-item-slot"></div>'),j=a.children().eq(b),j.length>0?c.insertBefore(j):a.append(c)}}),e.on("drop",function(a){a.preventDefault()})},f=function(a,c){a.on("dragover",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),a.on("dragenter",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),a.on("drop",function(a){var d,e,f;a.preventDefault(),a.stopPropagation(),d=a.originalEvent.dataTransfer.getData("text/plain"),d=JSON.parse(d),f=d.sortIndex,b>f&&(b-=1),f!==b&&(e=c.items.splice(f,1)[0],c.items.splice(b,0,e),c.$apply(),c.orderChangedCallback())})},g=function(b,c){a=c,b.$watchCollection("items",function(b,c){var d=_.difference(b,c);a.children().each(function(a,c){_.indexOf(d,b[a])>-1&&e($(c))})}),f(a,b)};return{restrict:"A",scope:{items:"=",orderChangedCallback:"&onOrderChanged"},link:g}}]),angular.module("authoringEnvironmentApp").service("Dragdata",["$log","articleType",function(a){this.converters={test:function(){return{}},image:function(a){return{id:a.attr("data-id"),width:a.attr("data-width")}},embed:function(a){return{id:a.attr("data-id")}}},this.available=function(){var a=[];return angular.forEach(this.converters,function(b,c){a.push(c)}),a},this.checkDraggable=function(a){var b=a.attr("data-draggable-type");return b?b in this.converters?!1:'error: draggable type "'+b+'" is not supported':"error: a draggable element has not a data-draggable-type attribute"},this.getData=function(a){var b=a.attr("data-draggable-type"),c=this.converters[b],d=c(a);return d.type=b,JSON.stringify(d)},this.getDropped=function(b){var c=JSON.parse(b);switch(c.type){case"test":return $("<div>").text("test dropped");case"image":return $("<div dropped-image>").attr({"data-id":c.id,"ng-controller":"DroppedImageCtrl","ng-style":"style.container"});case"embed":return Aloha.jQuery("<div>").append($("<dropped-snippet>").attr({snippet:"byId("+c.id+")","ng-controller":"SnippetsCtrl"})).addClass("dropped-snippet").alohaBlock();default:a.debug("getDropped function called on a malformed data object, no known type into it")}}}]),angular.module("authoringEnvironmentApp").factory("SnippetTemplate",["$http","$q","configuration",function(a,b,c){var d=c.API.full,e=this,f=function(){};return e.createFromApiData=function(a){var b=Object.create(f.prototype);return["id","name","enabled","favourite"].forEach(function(c){b[c]=a[c]}),b.fields=[],_.forEach(a.fields,function(a){"frontend"===a.scope&&b.fields.push(angular.copy(a))}),b},f.getAll=function(){var c=b.defer(),f=[],g=d+"/snippetTemplates";return f.$promise=c.promise,a.get(g,{params:{items_per_page:99999}}).success(function(a){a.items.forEach(function(a){a=e.createFromApiData(a),f.push(a)}),c.resolve()}).error(function(a){c.reject(a)}),f},f.createFromApiData=e.createFromApiData,f}]),angular.module("authoringEnvironmentApp").factory("Snippet",["$http","$q","configuration",function(a,b,c){var d=c.API.endpoint,e=c.API.full,f=this,g=function(){};return f.createFromApiData=function(a){var b=Object.create(g.prototype);return["id","templateId","name","render"].forEach(function(c){b[c]=a[c]}),b},g.getAllByArticle=function(c,d){var g,h=b.defer(),i=[];return g=[e,"snippets","article",c,d].join("/"),i.$promise=h.promise,a.get(g,{params:{rendered:!0,items_per_page:99999}}).success(function(a){a.items.forEach(function(a){a=f.createFromApiData(a),i.push(a)}),h.resolve()}).error(function(a){h.reject(a)}),i},g.create=function(c,d,g){var h,i=b.defer(),j=e+"/snippets";return h={template:d,snippet:{name:c,fields:{}}},_.forEach(g,function(a,b){h.snippet.fields[b]={data:a}}),a.post(j,h).then(function(b){var c=b.headers("x-location");return a.get(c,{params:{rendered:!0}})},function(){return b.reject()}).then(function(a){var b=f.createFromApiData(a.data);i.resolve(b)},function(){i.reject()}),i.promise},g.prototype.addToArticle=function(c,f){var g,h,i=this,j=b.defer();return h=[e,"articles",c,f].join("/"),g="<"+d+"/snippets/"+i.id+'; rel="snippet">',a({url:h,method:"LINK",headers:{link:g}}).success(function(){j.resolve()}).error(function(a){j.reject(a)}),j.promise},g.prototype.removeFromArticle=function(c,f){var g,h,i=this,j=b.defer();return h=[e,"articles",c,f].join("/"),g="<"+d+"/snippets/"+i.id+'; rel="snippet">',a({url:h,method:"UNLINK",headers:{link:g}}).success(function(){j.resolve()}).error(function(a){j.reject(a)}),j.promise},g}]),angular.module("authoringEnvironmentApp").controller("PaneSnippetsCtrl",["$scope","$q","article","Snippet","SnippetTemplate","modalFactory",function(a,b,c,d,e,f){a.clearNewSnippetForm=function(){a.newSnippet.name="",a.newSnippet.template=null,a.snippetTemplates.forEach(function(a){a.fields.forEach(function(a){delete a.value})})},a.addNewSnippetToArticle=function(e){var f,g={};a.addingNewSnippet=!0,e.template.fields.forEach(function(a){g[a.name]=a.value}),d.create(e.name,e.template.id,g).then(function(a){return f=a,c.promise},b.reject).then(function(a){return f.addToArticle(a.number,a.language)},b.reject).then(function(){a.snippets.push(f)}).finally(function(){a.addingNewSnippet=!1})},a.confirmRemoveSnippet=function(d){var e,g,h;g="Do you really want to remove this snippet?",h="Should you change your mind, the snippet can always be added again.",e=f.confirmLight(g,h),e.result.then(function(){return c.promise},b.reject).then(function(a){return d.removeFromArticle(a.number,a.language)},b.reject).then(function(){_.remove(a.snippets,function(a){return a===d})})},a.showAddSnippet=!1,a.newSnippet={name:"",template:null},a.addingNewSnippet=!1,a.inputFieldTypes=Object.freeze({integer:"number",text:"text",url:"url"}),a.snippetTemplates=e.getAll(),c.promise.then(function(b){a.snippets=d.getAllByArticle(b.number,b.language)})}]),angular.module("authoringEnvironmentApp").directive("droppedSnippet",function(){return{templateUrl:"views/dropped-snippet.html",restrict:"E",scope:{snippet:"="},link:function(a,b){b.find(".remove").on("click",function(){b.parent().remove()}),a.expand=function(){b.find(".preview").html(a.snippet.code),a.expanded=!0},a.collapse=function(){b.find(".preview").empty(),a.expanded=!1}}}}),angular.module("authoringEnvironmentApp").service("images",["$http","pageTracker","configuration","$log","article","getFileReader","formDataFactory","imageFactory","$upload","$rootScope","$q",function(a,b,c,d,e,f,g,h,i,j,k){var l=c.API.full,m=this,n=50;e.promise.then(function(a){m.article=a,m.loadAttached(a)}),this.tracker=b.getTracker({max:100}),this.loaded=[],this.displayed=[],this.collected=[],this.attached=[],this.images2upload=[],this.includedIndex=-1,this.included={},this.itemsPerPage=n,this.itemsFound=0,this.searchFilter="",this.canLoadMore=!1,this.query=function(a){for(this.searchFilter=a;m.displayed.length>0;)m.displayed.pop();for(;m.loaded.length>0;)m.loaded.pop();this.tracker.reset(),this.itemsFound=0,this.canLoadMore=!1,this.load(this.tracker.next(),this.searchFilter).success(function(a){m.displayed=a.items,a.pagination?(m.itemsPerPage=a.pagination.itemsPerPage,m.itemsFound=a.pagination.itemsCount):(m.itemsPerPage=n,m.itemsFound=a.items.length),m.canLoadMore=!b.isLastPage(a.pagination),m.canLoadMore&&m.more()
})},this.more=function(){var a=this.loaded.splice(0,this.itemsPerPage);this.displayed=this.displayed.concat(a),m.canLoadMore&&this.load(this.tracker.next(),this.searchFilter).success(function(a){m.loaded=m.loaded.concat(a.items),m.canLoadMore=!b.isLastPage(a.pagination)})},this.load=function(b,c){var d,e,f;return d={expand:!0,items_per_page:this.itemsPerPage,page:b},c?(f=l+"/search/images",d.query=c):f=l+"/images",e=a.get(f,{params:d}),e.error(function(){m.tracker.remove(b)}),e},this.loadAttached=function(b){var c=[l,"articles",b.number,b.language,"images?items_per_page=99999&expand=true"].join("/");a.get(c).then(function(a){m.attached=a.data.items})},this.matchMaker=function(a){return function(b){return parseInt(b.id)===parseInt(a)}},this.collect=function(b,c){var d,e,f;this.isCollected(b)||(c?(f=l+"/images/"+b,a.get(f).then(function(a){m.collected.push(a.data)})):(e=this.matchMaker(b),d=_.find(this.displayed,e),d&&m.collected.push(d)))},this.discard=function(a){var b=this.matchMaker(a);_.remove(this.collected,b)},this.discardAll=function(){for(;m.collected.length>0;)m.collected.pop();for(;m.images2upload.length>0;)m.images2upload.pop()},this.attachAllCollected=function(){var b,c=[],d=[];m.collected.forEach(function(a){_.find(m.attached,a)||c.push(a)}),c.length<1||(b=l+"/articles/"+m.article.number+"/"+m.article.language,c.forEach(function(a){d.push("<"+l+"/images/"+a.id+">")}),d=d.join(),a({url:b,method:"LINK",headers:{Link:d}}).success(function(){c.forEach(function(a){m.attached.push(a)})}))},this.attach=function(b,c){var e,f,g=this.matchMaker(b);return _.find(this.attached,g)?void d.debug("image already attached, ignoring attach request"):(f=l+"/articles/"+m.article.number+"/"+m.article.language,e="<"+l+"/images/"+b+">",d.debug("sending link request"),d.debug(f),d.debug(e),void a({url:f,method:"LINK",headers:{Link:e}}).success(function(){if(c)a.get(l+"/images/"+b).success(function(a){m.attached.push(a)});else{var d=_.find(m.displayed,g);m.attached.push(d)}}))},this.detach=function(b){var c=this.matchMaker(b);if(_.find(this.attached,c)){var e=l+"/articles/"+m.article.number+"/"+m.article.language,f="<"+l+"/images/"+b+">";d.debug("sending an unlink request"),d.debug(e),d.debug(f),a({url:e,method:"UNLINK",headers:{Link:f}}).success(function(){_.remove(m.attached,c)})}else d.debug("image already detached, ignoring attach request")},this.include=function(a){var b=this.matchMaker(a),d=_.findIndex(this.attached,b);if(0>d)throw new Error("trying to include a not attached image");this.attached[d].included=!0,this.includedIndex++;var e=_.cloneDeep(this.attached[d]),f="big";return e.size=f,e.style={container:{width:c.image.width[f]},image:{}},this.included[this.includedIndex]=e,this.includedIndex},this.exclude=function(a){var b=this.matchMaker(a),c=_.findIndex(this.attached,b);if(0>c)throw new Error("trying to exclude a not attached image");this.attached[c].included=!1},this.findAttached=function(a){return _.find(this.attached,this.matchMaker(a))},this.findCollected=function(a){return _.find(this.collected,this.matchMaker(a))},this.byId=function(a){var b=this.findAttached(a);if(b)return b;throw new Error("asking details about an image which is not attached to the article is not supported")},this.isAttached=function(a){return"undefined"!=typeof this.findAttached(a)},this.isCollected=function(a){return"undefined"!=typeof this.findCollected(a)},this.togglerClass=function(a){return this.isCollected(a)?"glyphicon-minus":"glyphicon-plus"},this.toggleCollect=function(a){this.isCollected(a)?this.discard(a):this.collect(a)},this.addToUploadList=function(a){var b,c;for(b=0;b<a.length;b++)c=this.decorate(a[b]),this.images2upload.push(c),c.readRawData()},this.removeFromUploadList=function(a){_.remove(this.images2upload,a)},this.clearUploadList=function(){for(;this.images2upload.length>0;)this.images2upload.pop()},this.uploadAll=function(){var a,b=[];return m.images2upload.forEach(function(c){a=c.startUpload(),b.push(a)}),b},this.decorate=function(a){return a.isUploaded=!1,a.progress=0,a.max=0,a.percent="0%",a.progressCallback=function(b){a.progress=b.loaded,a.max=b.total,a.percent=Math.round(b.loaded/b.total*100)+"%"},a.startUpload=function(){var b,c=k.defer(),d=g.makeInstance(),e=this,f="No x-location header in API response.";return d.append("image[photographer]",e.photographer),d.append("image[description]",e.description),d.append("image[image]",e),i.http({method:"POST",url:l+"/images",data:d,headers:{"Content-Type":void 0},transformRequest:angular.identity}).progress(a.progressCallback).success(function(d,e,g){var h;a.progressCallback({loaded:100,total:100}),a.isUploaded=!0,h=g()["x-location"],h?(b=h.split("/"),a.id=parseInt(b[b.length-1],10),c.resolve({id:a.id,url:h})):(console.warn(f),c.reject(f))}).error(function(){c.reject("error uploading")}),c.promise},a.readRawData=function(){var b=k.defer(),c=f.get();return c.onload=function(){var d=h.makeInstance();d.onload=function(c){a.width=d.width,a.height=d.height,a.src=d.src,b.resolve(c.target.result),j.$apply()},d.src=c.result},c.readAsDataURL(a),b.promise},a}}]),angular.module("authoringEnvironmentApp").service("modal",["$templateCache","$log","$http",function(){var a="#myModal",b=this;this.visible=!1,this.show=function(c){this.title=c.title,this.url=c.templateUrl,c.backdrop="static",c.keyboard=!1,c.show=!0,$(a).modal(c),b.visible=!0},this.hide=function(){this.visible=!1,$(a).modal("hide")}}]),angular.module("authoringEnvironmentApp").controller("ModalCtrl",["$scope","modal",function(a,b){a.modal=b}]),angular.module("authoringEnvironmentApp").controller("ImagePaneCtrl",["$scope","images","modal","modalFactory","article","articleType","$location","configuration",function(a,b,c,d,e,f,g,h){a.images=b,a.defaultWidth="100%",a.root=h.API.rootURI,a.attachModal=function(){c.show({title:"Attach Image",templateUrl:"views/attach-image.html"})},a.detachImage=function(a){var c,e,f;e="Do you really want to detach this image from the article?",f="Should you change your mind, the image can always be re-attached again.",c=d.confirmLight(e,f),c.result.then(function(){b.detach(a)},function(){})}}]),angular.module("authoringEnvironmentApp").controller("MediaArchiveCtrl",["$scope","images","configuration",function(a,b,c){a.images=b,a.root=c.API.rootURI,a.searchFilter="",a.$watch("images.searchFilter",function(b){a.appliedFilter=b}),a.thumbnailClicked=function(a){var c=b.isAttached(a),d=b.isCollected(a);c||d||b.toggleCollect(a)},a.searchArchive=function(a){b.query(a)},a.loadMore=function(){b.more()}}]),angular.module("authoringEnvironmentApp").controller("AttachImageCtrl",["$scope","$q","images","modal","configuration",function(a,b,c,d,e){a.root=e.API.rootURI,a.images=c,a.sources=[{value:"computer",url:"views/attach-image/computer.html",description:"From Computer"},{value:"archive",url:"views/attach-image/archive.html",description:"Media Archive"}],a.selected=a.sources[1],a.select=function(b){a.selected=b},a.attachCollected=function(){c.attachAllCollected(),c.discardAll(),d.hide()},a.discardChanges=function(a){a.preventDefault(),a.stopPropagation(),c.discardAll(),d.hide()}}]),angular.module("authoringEnvironmentApp").controller("UploadFromCompCtrl",["$scope","images","$q",function(a,b,c){a.images2upload=b.images2upload,a.$watchCollection("images.images2upload",function(b){a.images2upload=b}),a.addToUploadList=function(c){b.addToUploadList(c),a.$apply()},a.removeFromStaging=function(a){b.removeFromUploadList(a)},a.uploadStaged=function(){var a=b.uploadAll();c.all(a).then(function(a){a.forEach(function(a){b.collect(a.id,!0)}),b.clearUploadList()})},a.clearStaged=function(){b.clearUploadList()},a.setForAllPhotographer=function(a){b.images2upload.forEach(function(b){b.photographer=a})},a.setForAllDescription=function(a){b.images2upload.forEach(function(b){b.description=a})}}]),angular.module("authoringEnvironmentApp").service("pageTracker",function(){this.isLastPage=function(a){if("undefined"==typeof a)return!0;["itemsPerPage","currentPage","itemsCount"].map(function(b){a[b]=parseInt(a[b],10)});var b=a.itemsCount/a.itemsPerPage;return a.currentPage>=b},this.getTracker=function(){return{counter:1,pages:{},remove:function(a){delete this.pages[a]},has:function(a){return a in this.pages},next:function(){for(var a=1;a<=this.counter;a++)if(this.has(a)===!1)return this.pages[a]=!0,a===this.counter&&this.counter++,a},reset:function(){this.pages={},this.counter=1}}}}),angular.module("authoringEnvironmentApp").directive("droppedImage",["$popover",function(){return{templateUrl:"views/dropped-image.html",restrict:"A",scope:{imageId:"@imageId",imageAlign:"@imageAlign",imageAlt:"@imageAlt",imageSub:"@imageSub",imageWidth:"@imageWidth",imageHeight:"@imageHeight"},link:function(){}}}]),angular.module("authoringEnvironmentApp").controller("DroppedImageCtrl",["images","$scope","$log","configuration",function(a,b,c,d){function e(b){var d=a.included[b];if("undefined"==typeof d){var e="image with id "+b+" is not included in the article";throw c.error(e),new Error(e)}return d}function f(){return e(a.selected)}b.root=d.API.rootURI,b.images=a,b.pixels="",b.get=function(c){var d=a.include(c),f=e(d);return b.id=c,b.image=f,d},b.select=function(b){a.selected=b},b.size=function(a){var b=f();b.size=a,b.style.container.width=d.image.width[a],"big"===a&&(b.style.container.margin="0"),"original"===a?(b.style.container.width="auto",b.style.image.width="auto"):b.style.image={}},b.pixelsChanged=function(){if(angular.isNumber(b.pixels)){var a=b.pixels+"px",c=f();c.style.image.width=a}},b.align=function(a){var b,d,e=f();switch(a){case"left":b="left","big"!==e.size&&(d="0 2% 0 0");break;case"right":b="right","big"!==e.size&&(d="0 0 0 2%");break;case"center":b="none",d="0 auto";break;default:c.error("no known action "+a)}e.style.container.float=b,e.style.container.margin=d}}]),angular.module("authoringEnvironmentApp").factory("configuration",function(){return{API:{rootURI:"http://newscoop.aes.sourcefabric.net",endpoint:"/content-api",full:"http://newscoop.aes.sourcefabric.net/content-api"},auth:{client_id:"14_7lu4iulnlr0gg0gwcwowkkcko48000k84sokgwcg44s4oks0g",redirect_uri:"http://localhost:9000/#/callback",server:"http://newscoop.aes.sourcefabric.net/oauth/v2/auth"},article:{width:{desktop:960,tablet:600,phone:320}},image:{width:{small:"30%",medium:"50%",big:"100%"},"float":"none"},additionalFields:{news:[{name:"main_image",fieldWeight:10,isContentField:!0},{name:"title",fieldWeight:0,isContentField:!0}]}}}),angular.module("authoringEnvironmentApp").directive("fixedImagePlaceholder",function(){return{templateUrl:"views/fixed-image-placeholder.html",restrict:"E",link:function(a,b){b.on("drop",function(b){b.preventDefault();var c=b.originalEvent.dataTransfer.getData("Text");a.onDrop(c)})}}}),angular.module("authoringEnvironmentApp").controller("FixedImagePlaceholderCtrl",["$scope","images","configuration",function(a,b,c){a.root=c.API.rootURI,a.style={},a.dropped=!1,a.onDrop=function(c){var d=JSON.parse(c);"image"===d.type&&a.$apply(function(){a.image=b.byId(d.id),a.style.opacity=1,a.dropped=!0})}}]),angular.module("authoringEnvironmentApp").factory("authInterceptor",["$q","$window","configuration",function(a,b,c){return{request:function(a){return-1===a.url.indexOf(c.API.endpoint.substring(1)+"/")?a:(a.headers=a.headers||{},b.sessionStorage.token&&(a.headers.Authorization="Bearer "+b.sessionStorage.token),a)}}}]),angular.module("authoringEnvironmentApp").service("addToUrl",function(){this.add=function(a,b){var c="";return angular.forEach(a,function(a,b){c+="&"+b+"="+a}),/[?]/.test(b)||(c="?"+c.slice(1)),b+c}}),angular.module("authoringEnvironmentApp").service("mode",function(){this.current="normal",this.zen=!1,this.goZen=function(){this.current="zen",this.zen=!0},this.goNormal=function(){this.current="normal",this.zen=!1}}),angular.module("authoringEnvironmentApp").service("platform",function(){var a=this;this.current="desktop",this.go={mobile:function(){a.current="mobile"},desktop:function(){a.current="desktop"},tablet:function(){a.current="tablet"}}}),angular.module("authoringEnvironmentApp").controller("AuthenticationCtrl",["$scope","$window","$location","$log",function(a,b,c,d){a.parse=function(a){var b=a.slice(1),c=b.split("&"),d={};return c.forEach(function(a){var b=a.split("=");d[b[0]]=b[1]}),d};var e=c.url(),f=c.hash();d.debug("location url:",e),d.debug("location hash:",f);var g=a.parse(e);if(d.debug("parsed values:",JSON.stringify(g)),"access_token"in g){b.sessionStorage.token=g.access_token;var h="/";c.url(h),d.debug("redirecting to",h)}}]),angular.module("authoringEnvironmentApp").service("comments",["configuration","article","$http","$q","$resource","transform","pageTracker","$log","nestedSort",function(a,b,c,d,e,f,g,h,i){function j(a){return a.selected=!1,a.showStatus="collapsed",a.isEdited=!1,a.recommended=!!a.recommended,a.editing={status:a.status},a.reply={subject:"Re: "+a.subject,message:""},a.isReplyMode=!1,a.sendingReply=!1,a.collapse=function(){this.showStatus="collapsed",this.isReplyMode=!1},a.expand=function(){this.showStatus="expanded"},a.toggle=function(){"expanded"===this.showStatus?this.collapse():this.expand()},a.edit=function(){this.editing.subject=this.subject,this.editing.message=this.message,this.isEdited=!0,this.isReplyMode=!1},a.cancel=function(){this.isEdited=!1},a.save=function(){var a=this;b.promise.then(function(b){k.resource.save({articleNumber:b.number,languageCode:b.language,commentId:a.id},{comment:a.editing},function(){a.subject=a.editing.subject,a.message=a.editing.message,a.isEdited=!1})})},a.remove=function(){var a=this;b.promise.then(function(b){k.resource.delete({articleNumber:b.number,languageCode:b.language,commentId:a.id}).$promise.then(function(){_.remove(k.displayed,k.matchMaker(a.id))})})},a.replyTo=function(){a.isReplyMode=!0},a.cancelReply=function(){a.isReplyMode=!1},a.sendReply=function(){var a=this,b=angular.copy(a.reply);b.parent=a.id,a.sendingReply=!0,k.add({comment:b}).then(function(){a.sendingReply=!1,a.isReplyMode=!1,a.reply={subject:"Re: "+a.subject,message:""}})},a.toggleRecommended=function(){var a=this,b=!a.recommended;k.resource.toggleRecommended({commentId:a.id},{comment:{recommended:b?1:0}},function(){a.recommended=b})},a.changeStatus=function(a){var c=this;b.promise.then(function(b){k.resource.patch({articleNumber:b.number,languageCode:b.language,commentId:c.id},{comment:{status:a}},function(){c.status=a},function(){h.debug("error changing the status for the comment")})})},a}var k=this,l=a.API.full,m=50,n="nested";this.canLoadMore=!0,this.loaded=[],this.displayed=[],this.tracker=g.getTracker(),this.resource=e(l+"/comments/article/:articleNumber/:languageCode",{},{create:{method:"POST",transformRequest:f.formEncode},patch:{method:"PATCH",url:l+"/comments/article/:articleNumber/:languageCode/:commentId",transformRequest:f.formEncode},save:{method:"POST",url:l+"/comments/article/:articleNumber/:languageCode/:commentId",transformRequest:f.formEncode},"delete":{method:"DELETE",url:l+"/comments/article/:articleNumber/:languageCode/:commentId"},toggleRecommended:{method:"PATCH",url:l+"/comments/:commentId.json"}}),this.add=function(a){var e=d.defer();return b.promise.then(function(b){k.resource.create({articleNumber:b.number,languageCode:b.language},a,function(a,b){var d=b("X-Location");d?c.get(d).success(function(a){k.displayed.push(j(a)),i.sort(k.displayed)}):k.init(),e.resolve()})}),e.promise},this.init=function(a){k.tracker=g.getTracker(),k.canLoadMore=!0,k.loaded=[],k.displayed=[],n=a&&a.sorting?a.sorting:"nested",this.load(this.tracker.next()).then(function(a){k.displayed=a.items.map(j),i.sort(k.displayed),k.canLoadMore&&k.load(k.tracker.next()).then(function(a){k.loaded=k.loaded.concat(a.items)})})},this.more=function(){if(this.canLoadMore){var a=this.loaded.splice(0,m);a=a.map(j),this.displayed=this.displayed.concat(a);var b=this.tracker.next();this.load(b).then(function(a){k.loaded=k.loaded.concat(a.items)})}else h.error("More comments required, but the service cannot load more of them. In this case the user should not be able to trigger this request")},this.load=function(e){var f=d.defer();return b.promise.then(function(b){var d;d="nested"===n?"/nested":"";var h=[a.API.full,"/comments/article/",b.number,"/",b.language,d,"?items_per_page=",m,"&page=",e].join("");c.get(h).success(function(a){f.resolve(a),g.isLastPage(a.pagination)&&(k.canLoadMore=!1)}).error(function(){k.tracker.remove(e)})}),f.promise},this.matchMaker=function(a){return function(b){return parseInt(b.id)===parseInt(a)}},this.changeSelectedStatus=function(a,b,c){var d=null,e=this.displayed,f=0,g=e.length,h=[];if(!b&&"undefined"!=typeof c)return void e.forEach(function(b){b.id===c&&b.changeStatus(a)});if(!b&&"undefined"==typeof c)return void e.forEach(function(b){b.selected&&b.changeStatus(a)});if(b&&"undefined"!=typeof c)for(;g>f;){if(d){if(!(e[f].thread_level>d.thread_level))break;h.push(e[f])}else e[f].id===c&&(d=e[f],h.push(d));f++}else for(;g>f;){if(d){if(!(e[f].thread_level>d.thread_level)){d=null;continue}h.push(e[f])}else e[f].selected&&(d=e[f],h.push(d));f++}h.forEach(function(b){b.changeStatus(a)})}}]),angular.module("authoringEnvironmentApp").controller("CommentsCtrl",["$scope","comments","article","modalFactory","$log",function(a,b,c,d,e){var f=["pending","approved","hidden"];a.sortings=[{text:"Nested"},{text:"Chronological"},{text:"Chronological (asc.)"}],a.sorting=a.sortings[0],a.toggle=function(b){var c=a.statuses[b];a.statuses[b]=!c,"all"===b?f.map(c?function(b){a.statuses[b]=!0}:function(b){a.statuses[b]=!1}):c?f.every(function(b){return!1===a.statuses[b]})&&(a.statuses.all=!0):a.statuses.all=!1},a.commentingSettingSrv=c.commenting.ENABLED,a.commentingSetting=a.commentingSettingSrv,a.commentingOptDirty=!1,a.isChangingCommenting=!1,a.commenting=c.commenting,a.commentingOpts=[{value:c.commenting.ENABLED,text:"Enabled"},{value:c.commenting.DISABLED,text:"Disabled"},{value:c.commenting.LOCKED,text:"Locked"}],this.initCommenting=function(){c.promise.then(function(b){a.commentingSettingSrv=parseInt(b.comments_locked,10)>0?c.commenting.LOCKED:parseInt(b.comments_enabled,10)>0?c.commenting.ENABLED:c.commenting.DISABLED,a.commentingSetting=a.commentingSettingSrv})},this.initCommenting(),a.statuses={all:!0,pending:!1,approved:!1,hidden:!1},a.selected=function(b){return a.statuses.all?!0:a.statuses[b.status]?!0:!1},a.isSending=!1,a.comments=b,a.create={},b.init(),a.add=function(c){a.isSending=!0,b.add(c).then(function(){a.adding=!1,a.isSending=!1,a.create={}},function(){a.isSending=!1})},a.cancel=function(){a.adding=!1,a.create={}},a.globalShowStatus="collapsed",a.$watch("globalShowStatus",function(){b.displayed.map(function(b){b.showStatus=a.globalShowStatus})}),a.updateCommentingDirtyFlag=function(){a.commentingOptDirty=a.commentingSetting!==a.commentingSettingSrv},a.changeCommentingSetting=function(){var b=a.commentingSetting,d=a.commentingSettingSrv;a.isChangingCommenting=!0,c.changeCommentingSetting(b).then(function(){a.commentingSettingSrv=b},function(){a.commentingSetting=d}).finally(function(){a.updateCommentingDirtyFlag(),a.isChangingCommenting=!1})},a.toggleShowStatus=function(){a.globalShowStatus="expanded"===a.globalShowStatus?"collapsed":"expanded"},a.$watch("sorting",function(){e.debug("sorting changed"),b.canLoadMore&&b.init("Nested"===a.sorting.text?{sorting:"nested"}:{sorting:"chronological"})}),a.countSelected=function(){var a=0;return b.displayed.forEach(function(b){b.selected&&a++}),a},a.confirmHideComments=function(a){var c,e,f,g="undefined"!=typeof a;g?(e="Do you really want to hide this comment?",f="Comment's content will not be visible to users."):(e="Do you really want to hide selected comments?",f="Comments' contents will not be visible to users."),c=d.confirmLight(e,f),c.result.then(function(){g?b.changeSelectedStatus("hidden",!1,a):b.changeSelectedStatus("hidden",!1)},function(){})},a.confirmDeleteComments=function(a){var c,e,f,g="undefined"!=typeof a;g?(e="Are you sure you want to mark this comment as deleted?",f="Deleted comments are not visible to users."):(e="Are you sure you want to mark selected comments as deleted?",f="Deleted comments are not visible to users."),c=d.confirmHeavy(e,f),c.result.then(function(){g?b.changeSelectedStatus("deleted",!0,a):b.changeSelectedStatus("deleted",!0)},function(){})}}]),angular.module("authoringEnvironmentApp").directive("comment",function(){return{templateUrl:"views/comment.html",restrict:"E",scope:{model:"=",allowreplying:"=",onHide:"&confirmHideComments",onDelete:"&confirmDeleteComments"},link:function(){}}}),angular.module("authoringEnvironmentApp").service("transform",function(){function a(a){return $.param(a)}this.formEncode=function(b,c){var d=c();return d["Content-Type"]="application/x-www-form-urlencoded",a(b)},this.formEncodeData=a}),angular.module("authoringEnvironmentApp").service("circularBufferFactory",function(){this.create=function(a){if(!("size"in a))throw new Error("a circular buffer needs an integer size option");return{opt:a,arr:[],used:function(){return this.arr.length},push:function(a){this.used()>=this.opt.size&&this.arr.shift(),this.arr.push(a)},dump:function(){return angular.copy(this.arr)},prev:function(a){var b=a||1,c=parseInt(b,10);if(1>c)throw new Error(c+" is not a valid value for the `prev` function, check the tests or the code");var d=this.arr.length-c,e=d>=0?d:0;return this.arr[e]}}}}),angular.module("authoringEnvironmentApp").filter("sortComments",["$log",function(a){function b(a){return new Date(a.created)}return function(c,d){var e,f;switch(d){case"Nested":return _.sortBy(c,"nestedPosition");case"Chronological":return e=_.sortBy(c,b),e.reverse(),e;case"Chronological (asc.)":return _.sortBy(c,b);default:throw f="unknown sorting: "+d,a.error(f),new Error(f)}}}]),angular.module("authoringEnvironmentApp").service("nestedSort",["$log",function(a){var b=this;this.sortByCreated=function(a){function b(a){return new Date(a.created)}return _.sortBy(a,b)},this.sort=function(c){function d(a){var c=b.sortByCreated(a.childs);c.forEach(function(a){a.nestedPosition=i,i++,d(a)})}for(var e=[],f=0,g=function(a){return a.thread_level===f},h=c.filter(g);h.length>0;)e.push(h),f++,h=c.filter(g);b.map={root:{childs:[]}},e.forEach(function(c){c.forEach(function(c){var d=angular.copy(c);d.childs=[],0===d.thread_level&&(d.parent="root"),b.map[d.id]=d,"parent"in d?d.parent in b.map?b.map[d.parent].childs.push(d):a.debug("error, comment",d,"has parent",d.parent,"which is not available to us"):a.debug("error, comment",d,"is not first level but it has no parent")})});var i=0;d(b.map.root),c.forEach(function(c){c.id in b.map?c.nestedPosition=b.map[c.id].nestedPosition:a.error("comment",c,"is not in the nested sorting map",b.map)})}}]),angular.module("authoringEnvironmentApp").service("currentTime",function(){var a=!1;this.set=function(b){a=b},this.unset=function(){a=!1},this.get=function(){return a===!1?new Date:a},this.isToday=function(a){var b=this.get();return a.toDateString()===b.toDateString()}}),angular.module("authoringEnvironmentApp").filter("niceDate",["currentTime","$filter",function(a,b){return function(c){var d;return d="string"==typeof c?new Date(Date.parse(c)):c,a.isToday(d)?"today "+b("date")(d,"H:mm"):b("date")(d,"dd.MM.yyyy")}}]),angular.module("authoringEnvironmentApp").directive("dropImages",function(){return{restrict:"A",scope:{handler:"&"},link:function(a,b){b.on("drop",function(b){var c,d,e,f=[],g=new RegExp(/^image\/.*/i);for(b.preventDefault(),b.stopPropagation(),e=b.originalEvent.dataTransfer.files,c=0;c<e.length;c++)d=e.item(c),g.test(d.type)&&f.push(d);a.handler({files:f})}),b.on("dragover",function(a){a.preventDefault(),a.stopPropagation(),a.originalEvent.dataTransfer.dropEffect="copy"})}}}),angular.module("authoringEnvironmentApp").directive("fileUpload",function(){return{restrict:"A",scope:{handler:"&"},link:function(a,b){var c=$("<input>").attr({type:"file",accept:"image/*",multiple:"multiple","class":"hidden-input",style:"display:none"});c.on("click",function(a){a.stopPropagation()}),c.on("change",function(){var b=c.get(0).files;a.handler({files:b})}),b.append(c),b.on("click",function(){c.click()})}}}),angular.module("authoringEnvironmentApp").factory("Author",["$http","$resource","$q","$timeout","configuration","dateFactory","pageTracker",function(a,b,c,d,e,f,g){var h=e.API.endpoint,i=e.API.full,j=250,k=null,l=0,m=this;return m.createFromApiData=function(a){var b=new m.authorResource;return b.id=a.author.id,b.firstName=a.author.firstName,b.lastName=a.author.lastName,b.text=a.author.firstName+" "+a.author.lastName,b.articleRole=a.type?{id:a.type.id,name:a.type.type}:null,b.avatarUrl=a.author.image?"http://"+decodeURIComponent(a.author.image):"/images/authors-default-avatar.png",b.sortOrder=a.order,b},m.getAll={method:"GET",isArray:!0,transformResponse:function(a){var b=[],c=JSON.parse(a).items;return c.forEach(function(a){var c=m.createFromApiData(a);b.push(c)}),b}},m.liveSearchQuery=function(b,c){var e=f.makeInstance(),h=b.page>1;if(!c){if(!h)return l=e,void d(function(){m.authorResource.liveSearchQuery(b,!0)},j);if(angular.equals(b.context,k))return;k=b.context}!h&&j>e-l||a.get(i+"/search/authors",{params:{query:b.term,page:b.page,items_per_page:10}}).success(function(a){var c,d=[];a.items.forEach(function(a){c=m.createFromApiData({author:a}),d.push(c)}),b.callback({results:d,more:!g.isLastPage(a.pagination),context:a.pagination})})},m.setOrderOnArticle=function(b,c,d){var e,f=[];d.forEach(function(a){f.push(a.id+"-"+a.articleRole.id)}),f=f.join(),e=[i,"articles",b,c,"authors","order"].join("/"),a.post(e,{order:f})},m.addToArticle=function(b,d,e){var f,g,j=this,k=c.defer();return g=[i,"articles",b,d].join("/"),f="<"+h+"/authors/"+j.id+'; rel="author">,<'+h+"/authors/types/"+e+'; rel="author-type">',a({url:g,method:"LINK",headers:{link:f}}).success(function(){j.articleRole=j.articleRole||{},j.articleRole.id=e,k.resolve()}).error(function(a){k.reject(a)}),k.promise},m.removeFromArticle=function(b,d,e){var f,g,j=this,k=c.defer();return g=[i,"articles",b,d].join("/"),f="<"+h+"/authors/"+j.id+'; rel="author">,<'+h+"/authors/types/"+e+'; rel="author-type">',a({url:g,method:"UNLINK",headers:{link:f}}).success(function(){k.resolve()}).error(function(a){k.reject(a)}),k.promise},m.getRoleList={method:"GET",url:i+"/authors/types",isArray:!0,transformResponse:function(a){var b=JSON.parse(a).items;return b.forEach(function(a){a.name=a.type,delete a.type}),b}},m.updateRole=function(b){var c,d,e;return e=[i,"articles",b.number,b.language,"authors",this.id].join("/"),c="<"+h+"/authors/types/"+b.oldRoleId+'; rel="old-author-type">,<'+h+"/authors/types/"+b.newRoleId+'; rel="new-author-type">',d=a.post(e,{},{headers:{link:c}})},m.authorResource=b(i+"/articles/:number/:language/authors/:authorId",{authorId:"@id",items_per_page:99999},{getAll:m.getAll,getRoleList:m.getRoleList}),m.authorResource.prototype.addToArticle=m.addToArticle,m.authorResource.prototype.removeFromArticle=m.removeFromArticle,m.authorResource.prototype.updateRole=m.updateRole,m.authorResource.createFromApiData=m.createFromApiData,m.authorResource.liveSearchQuery=m.liveSearchQuery,m.authorResource.setOrderOnArticle=m.setOrderOnArticle,m.authorResource}]),angular.module("authoringEnvironmentApp").service("imageResource",["$resource","configuration","transform",function(a,b,c){return a(b.API.full+"/images/:id",{},{modify:{method:"PATCH",transformRequest:c.formEncode}})}]),angular.module("authoringEnvironmentApp").factory("getFileReader",function(){return{get:function(){return new FileReader}}}),angular.module("authoringEnvironmentApp").factory("formDataFactory",function(){return{makeInstance:function(){return new FormData}}}),angular.module("authoringEnvironmentApp").factory("imageFactory",function(){return{makeInstance:function(){return new Image}}}),angular.module("authoringEnvironmentApp").factory("dateFactory",function(){return{makeInstance:function(){return new Date}}});